<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Composer - OSBuild guides</title>
        <!-- Custom HTML head -->
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
    </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="../user-guide/user-guide.html"><strong aria-hidden="true">1.</strong> User guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../user-guide/osbuild-composer-description.html"><strong aria-hidden="true">1.1.</strong> osbuild-composer description</a></li><li class="chapter-item expanded "><a href="../user-guide/installation.html"><strong aria-hidden="true">1.2.</strong> Installation and configuration</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../user-guide/managing-repositories.html"><strong aria-hidden="true">1.2.1.</strong> Managing repositories</a></li><li class="chapter-item expanded "><a href="../user-guide/container-auth.html"><strong aria-hidden="true">1.2.2.</strong> Container registry credentials</a></li></ol></li><li class="chapter-item expanded "><a href="../user-guide/building-an-image-from-cli.html"><strong aria-hidden="true">1.3.</strong> Creating images with the CLI interface</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../user-guide/building-ostree-images.html"><strong aria-hidden="true">1.3.1.</strong> Building OSTree image</a></li><li class="chapter-item expanded "><a href="../user-guide/edge-container+installer.html"><strong aria-hidden="true">1.3.2.</strong> Building OSTree container and installer</a></li></ol></li><li class="chapter-item expanded "><a href="../user-guide/uploading-to-cloud.html"><strong aria-hidden="true">1.4.</strong> Uploading cloud images</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../user-guide/uploading-to-aws.html"><strong aria-hidden="true">1.4.1.</strong> Uploading an image to AWS</a></li><li class="chapter-item expanded "><a href="../user-guide/uploading-to-aws-s3.html"><strong aria-hidden="true">1.4.2.</strong> Uploading an image to AWS S3</a></li><li class="chapter-item expanded "><a href="../user-guide/uploading-to-gcp.html"><strong aria-hidden="true">1.4.3.</strong> Uploading an image to GCP</a></li><li class="chapter-item expanded "><a href="../user-guide/uploading-to-generic-s3.html"><strong aria-hidden="true">1.4.4.</strong> uploading an image to Generic S3</a></li><li class="chapter-item expanded "><a href="../user-guide/uploading-to-azure.html"><strong aria-hidden="true">1.4.5.</strong> Uploading an image to Microsoft Azure</a></li><li class="chapter-item expanded "><a href="../user-guide/uploading-to-oci.html"><strong aria-hidden="true">1.4.6.</strong> Uploading an image to OCI</a></li></ol></li><li class="chapter-item expanded "><a href="../user-guide/uploading-to-registry.html"><strong aria-hidden="true">1.5.</strong> Uploading container images</a></li><li class="chapter-item expanded "><a href="../user-guide/oscap-remediation.html"><strong aria-hidden="true">1.6.</strong> OpenSCAP image remediation</a></li></ol></li><li class="chapter-item expanded "><a href="../blueprint-reference/blueprint-reference.html"><strong aria-hidden="true">2.</strong> Blueprint reference</a></li><li class="chapter-item expanded "><a href="../image-builder-service/architecture.html"><strong aria-hidden="true">3.</strong> Image Builder service architecture</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../image-builder-service/image-builder-crc.html"><strong aria-hidden="true">3.1.</strong> Backend</a></li><li class="chapter-item expanded "><a href="../image-builder-service/image-builder-composer.html" class="active"><strong aria-hidden="true">3.2.</strong> Composer</a></li><li class="chapter-item expanded "><a href="../image-builder-service/image-builder-workers.html"><strong aria-hidden="true">3.3.</strong> Workers</a></li></ol></li><li class="chapter-item expanded "><a href="../developer-guide/developer-guide.html"><strong aria-hidden="true">4.</strong> Developer guide</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../developer-guide/workflow.html"><strong aria-hidden="true">4.1.</strong> Workflow</a></li><li class="chapter-item expanded "><a href="../developer-guide/code-style.html"><strong aria-hidden="true">4.2.</strong> Code style</a></li><li class="chapter-item expanded "><a href="../developer-guide/osbuild.html"><strong aria-hidden="true">4.3.</strong> OSBuild</a></li><li class="chapter-item expanded "><a href="../developer-guide/osbuild-composer.html"><strong aria-hidden="true">4.4.</strong> osbuild-composer</a></li><li class="chapter-item expanded "><a href="../developer-guide/latest-rpm-builds.html"><strong aria-hidden="true">4.5.</strong> Latest RPM builds</a></li><li class="chapter-item expanded "><a href="../developer-guide/testing.html"><strong aria-hidden="true">4.6.</strong> Testing strategy</a></li><li class="chapter-item expanded "><a href="../developer-guide/releasing.html"><strong aria-hidden="true">4.7.</strong> Releasing</a></li><li class="chapter-item expanded "><a href="../developer-guide/glossary.html"><strong aria-hidden="true">4.8.</strong> Glossary</a></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">OSBuild guides</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="image-builder-composer-api-architecture-document"><a class="header" href="#image-builder-composer-api-architecture-document">Image Builder Composer API Architecture Document</a></h1>
<h2 id="service-description"><a class="header" href="#service-description">Service Description</a></h2>
<p>The <code>image-builder-composer</code> API routed via <a href="https://api.openshift.com/">api.openshift.com</a> serves as a
job queue for pending image builds as well as a metadata-store for already built images. When an image
build is queued via the API it is turned into a set of jobs that are put on the job queue, and together
do the necessary tasks to determine how the image should be built, build the image, upload the image to
its destination, and possibly register or import it to its final format.</p>
<p>The <code>image-builder-worker</code> API routed via <a href="https://api.openshift.com/">api.openshift.com</a> serves as the
other side of the job queue, where jobs can be dequeued to be executed and their results posted.</p>
<p>The actual jobs are executed by <code>workers</code>, which is outside the scope of this document.</p>
<h2 id="technology-stack"><a class="header" href="#technology-stack">Technology Stack</a></h2>
<p>The service is written in Golang, and the list of dependencies can be found in
<a href="https://github.com/osbuild/osbuild-composer/blob/main/go.mod">go.mod</a>.</p>
<p>The <code>ubi8/go-toolset:latest</code> container is used as a builder, and <code>ubi8/ubi-minimal:latest</code> to run the
binary. The container images are located here: https://quay.io/repository/app-sre/composer.</p>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<p>The service consists of the composer and the composer-worker apps running in an AppSRE managed cluster,
and their backing database.</p>
<p>If either composer or the database are unavailable, the service does not work at all, new images
cannot be built, and historical builds cannot be introspected. Already built images that may be in
used by customers are unaffected, only their history and metadata can no longer be queried through
the service.</p>
<p>If composer-workers is unavailable, new jobs can be queued and old ones can be queried, but workers
will not be able to pick up new jobs until the API is back, and they will not be able to report back
results correctly for jobs they finish while the API is down.</p>
<h2 id="routes"><a class="header" href="#routes">Routes</a></h2>
<p>The public routes are <code>/api/image-builder-composer/v2/</code> and <code>/api/image-builder/worker/v1/</code>, detailed
lists can be found at https://api.openshift.com/api/image-builder-composer/v2/openapi and
https://api.openshift.com/api/image-builder-worker/v1/openapi.</p>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>Composer has the following internal and external dependencies.</p>
<h3 id="internal"><a class="header" href="#internal">Internal</a></h3>
<p>Composer relies on Red Hat SSO for authentication.</p>
<h3 id="external"><a class="header" href="#external">External</a></h3>
<ul>
<li>AWS RDS for data storage. See the section on state.</li>
<li>Quay as a container registry. Without this, the service cannot be redeployed.</li>
<li>Github as an upstream repository. Without this, the service cannot be redeployed.</li>
<li>Gitlab, AWS EC2, and Openstack for upstream testing. Without this changes to the service cannot land.</li>
</ul>
<h2 id="service-diagram"><a class="header" href="#service-diagram">Service Diagram</a></h2>
<p>See parent page.</p>
<h2 id="application-success-criteria"><a class="header" href="#application-success-criteria">Application Success Criteria</a></h2>
<ol>
<li>Image builds can be queued successfully</li>
<li>Jobs can be dequeued successfully and correctly</li>
<li>Jobs are tracked correctly</li>
<li>The state of historical or in-flight builds can be queried and introspected successfully</li>
</ol>
<h2 id="state"><a class="header" href="#state">State</a></h2>
<p>The service depends on a PostgreSQL database, the default postgres12-rds-1 template is used. The
database stores metadata about each build, making it possible to enumerate past builds as well as
function as a job queue.</p>
<p>If the state is lost historical data would be lost, and pending image builds might never get scheduled,
but the user could still use their existing images if they have saved the necessary information. Data
loss would not affect the ability to schedule new builds.</p>
<h2 id="load-testing"><a class="header" href="#load-testing">Load Testing</a></h2>
<p>The Image Builder API in console.redhat.com is currently being load tested on a weekly basis with failure
thresholds reflecting the SLIs. The load tests happen against stage CRC, which is backed by composer in
api.stage.openshift.com. An example can be found <a href="https://gitlab.com/osbuild/ci/image-builder/-/jobs/1723976612">here</a>.</p>
<p>More information can be found <a href="https://github.com/osbuild/image-builder/blob/main/test/README.md">upstream</a>.</p>
<h2 id="capacity"><a class="header" href="#capacity">Capacity</a></h2>
<p>The defaults described in App Interface, 1 cpu 512Mi memory per container running in the default three pods are sufficient, and our expectations
are that this will remain sufficient for the next twelve months.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../image-builder-service/image-builder-crc.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                            <a rel="next" href="../image-builder-service/image-builder-workers.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../image-builder-service/image-builder-crc.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../image-builder-service/image-builder-workers.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>

        <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
    </body>
</html>
