<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Image Builder</title>
        <meta name="robots" content="noindex" />


        <!-- Custom HTML head -->
        
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->

    </head>
    <body>
    <div id="body-container">
        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var html = document.querySelector('html');
            var sidebar = null;
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item "><a href="introduction.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item "><a href="image-builder-service/architecture.html"><strong aria-hidden="true">2.</strong> Image Builder on console.redhat.com</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="image-builder-service/image-builder-crc.html"><strong aria-hidden="true">2.1.</strong> Backend</a></li><li class="chapter-item "><a href="image-builder-service/image-builder-composer.html"><strong aria-hidden="true">2.2.</strong> Composer</a></li><li class="chapter-item "><a href="image-builder-service/image-builder-workers.html"><strong aria-hidden="true">2.3.</strong> Workers</a></li><li class="chapter-item "><a href="image-builder-service/image-builder-koji.html"><strong aria-hidden="true">2.4.</strong> Koji integration</a></li></ol></li><li class="chapter-item "><a href="image-builder-on-premises/image-builder-on-premises.html"><strong aria-hidden="true">3.</strong> Image Builder on premises</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="image-builder-on-premises/release-overview.html"><strong aria-hidden="true">3.1.</strong> Releases</a></li><li class="chapter-item "><a href="image-builder-on-premises/basic-concepts.html"><strong aria-hidden="true">3.2.</strong> Basic concepts</a></li><li class="chapter-item "><a href="image-builder-on-premises/installation.html"><strong aria-hidden="true">3.3.</strong> Installation and configuration</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="image-builder-on-premises/managing-repositories.html"><strong aria-hidden="true">3.3.1.</strong> Managing repositories</a></li><li class="chapter-item "><a href="image-builder-on-premises/container-auth.html"><strong aria-hidden="true">3.3.2.</strong> Container registry credentials</a></li></ol></li><li class="chapter-item "><a href="image-builder-on-premises/building-an-image-from-cli.html"><strong aria-hidden="true">3.4.</strong> Creating images with the CLI interface</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="image-builder-on-premises/building-ostree-images.html"><strong aria-hidden="true">3.4.1.</strong> Building OSTree image</a></li><li class="chapter-item "><a href="image-builder-on-premises/edge-container+installer.html"><strong aria-hidden="true">3.4.2.</strong> Building OSTree container and installer</a></li></ol></li><li class="chapter-item "><a href="image-builder-on-premises/uploading-to-cloud.html"><strong aria-hidden="true">3.5.</strong> Uploading cloud images</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="image-builder-on-premises/uploading-to-aws.html"><strong aria-hidden="true">3.5.1.</strong> Uploading an image to AWS</a></li><li class="chapter-item "><a href="image-builder-on-premises/uploading-to-aws-s3.html"><strong aria-hidden="true">3.5.2.</strong> Uploading an image to AWS S3</a></li><li class="chapter-item "><a href="image-builder-on-premises/uploading-to-gcp.html"><strong aria-hidden="true">3.5.3.</strong> Uploading an image to GCP</a></li><li class="chapter-item "><a href="image-builder-on-premises/uploading-to-generic-s3.html"><strong aria-hidden="true">3.5.4.</strong> uploading an image to Generic S3</a></li><li class="chapter-item "><a href="image-builder-on-premises/uploading-to-azure.html"><strong aria-hidden="true">3.5.5.</strong> Uploading an image to Microsoft Azure</a></li><li class="chapter-item "><a href="image-builder-on-premises/uploading-to-oci.html"><strong aria-hidden="true">3.5.6.</strong> Uploading an image to OCI</a></li></ol></li><li class="chapter-item "><a href="image-builder-on-premises/uploading-to-registry.html"><strong aria-hidden="true">3.6.</strong> Uploading container images</a></li><li class="chapter-item "><a href="image-builder-on-premises/oscap-remediation.html"><strong aria-hidden="true">3.7.</strong> OpenSCAP image remediation</a></li><li class="chapter-item "><a href="image-builder-on-premises/repository-customizations.html"><strong aria-hidden="true">3.8.</strong> Repository customizations</a></li><li class="chapter-item "><a href="image-builder-on-premises/blueprint-reference.html"><strong aria-hidden="true">3.9.</strong> Blueprint Reference</a></li></ol></li><li class="chapter-item "><a href="developer-guide/index.html"><strong aria-hidden="true">4.</strong> Developer Guide</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="developer-guide/general/index.html"><strong aria-hidden="true">4.1.</strong> General</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="developer-guide/general/glossary.html"><strong aria-hidden="true">4.1.1.</strong> Glossary</a></li><li class="chapter-item "><a href="developer-guide/general/workflow.html"><strong aria-hidden="true">4.1.2.</strong> Workflow</a></li><li class="chapter-item "><a href="developer-guide/general/code-style.html"><strong aria-hidden="true">4.1.3.</strong> Code style</a></li><li class="chapter-item "><a href="developer-guide/general/releasing/index.html"><strong aria-hidden="true">4.1.4.</strong> Releasing</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="developer-guide/general/releasing/backporting.html"><strong aria-hidden="true">4.1.4.1.</strong> Backporting</a></li><li class="chapter-item "><a href="developer-guide/general/releasing/latest-rpm-builds.html"><strong aria-hidden="true">4.1.4.2.</strong> Latest RPM builds</a></li></ol></li><li class="chapter-item "><a href="developer-guide/general/testing-strategy/index.html"><strong aria-hidden="true">4.1.5.</strong> Testing Strategy</a></li></ol></li><li class="chapter-item "><a href="developer-guide/projects/index.html"><strong aria-hidden="true">4.2.</strong> Projects</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="developer-guide/projects/osbuild/index.html"><strong aria-hidden="true">4.2.1.</strong> osbuild</a></li><li class="chapter-item "><a href="developer-guide/projects/osbuild-composer/index.html"><strong aria-hidden="true">4.2.2.</strong> osbuild-composer</a><a class="toggle"><div>‚ù±</div></a></li><li><ol class="section"><li class="chapter-item "><a href="developer-guide/projects/osbuild-composer/localcloud.html"><strong aria-hidden="true">4.2.2.1.</strong> Local Cloud API Development</a></li></ol></li><li class="chapter-item "><a href="developer-guide/projects/rpmrepo/index.html"><strong aria-hidden="true">4.2.3.</strong> rpmrepo</a></li></ol></li></ol></li></ol>
            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <!-- Track and set sidebar scroll position -->
        <script>
            var sidebarScrollbox = document.querySelector('#sidebar .sidebar-scrollbox');
            sidebarScrollbox.addEventListener('click', function(e) {
                if (e.target.tagName === 'A') {
                    sessionStorage.setItem('sidebar-scroll', sidebarScrollbox.scrollTop);
                }
            }, { passive: true });
            var sidebarScrollTop = sessionStorage.getItem('sidebar-scroll');
            sessionStorage.removeItem('sidebar-scroll');
            if (sidebarScrollTop) {
                // preserve sidebar scroll position when navigating via links within sidebar
                sidebarScrollbox.scrollTop = sidebarScrollTop;
            } else {
                // scroll sidebar to current active section when navigating via "next/previous chapter" buttons
                var activeSection = document.querySelector('#sidebar .active');
                if (activeSection) {
                    activeSection.scrollIntoView({ block: 'center' });
                }
            }
        </script>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Image Builder</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="build-reliable-operating-system-images"><a class="header" href="#build-reliable-operating-system-images">Build Reliable Operating System Images</a></h1>
<p>Use Image Builder to create images of your Linux operating system in a reliable fashion, isolating the image creation from your host operating system, and producing a reliable, well-defined image ready to be deployed.</p>
<p>Image Builder provides both the tools to build custom operating system images, as well as applications to deploy hosted image building services. At its core, the <a href="./developer-guide/osbuild.html"><code>osbuild</code></a> project takes the responsibility of assembling custom images of operating systems according to the precise needs of the user. The <a href="./developer-guide/osbuild-composer.html"><code>osbuild-composer</code></a> project builds on top of osbuild and implements an image creation service that can be deployed as a hosted service.</p>
<h2 id="image-builder-on-consoleredhatcom"><a class="header" href="#image-builder-on-consoleredhatcom">Image Builder on console.redhat.com</a></h2>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<p><svg
   id="artwork"
   viewBox="0 0 760 311.63"
   version="1.1"
   sodipodi:docname="306_OpenShift_OSBuild_upstream_0123.svg"
   inkscape:version="1.2.2 (b0a8486541, 2022-12-01)"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:xlink="http://www.w3.org/1999/xlink"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
&lt;sodipodi:namedview
id=&quot;namedview177&quot;
pagecolor=&quot;#ffffff&quot;
bordercolor=&quot;#666666&quot;
borderopacity=&quot;1.0&quot;
inkscape:showpageshadow=&quot;2&quot;
inkscape:pageopacity=&quot;0.0&quot;
inkscape:pagecheckerboard=&quot;0&quot;
inkscape:deskcolor=&quot;#d1d1d1&quot;
showgrid=&quot;false&quot;
inkscape:zoom=&quot;1.7118421&quot;
inkscape:cx=&quot;287.99385&quot;
inkscape:cy=&quot;155.97233&quot;
inkscape:window-width=&quot;2560&quot;
inkscape:window-height=&quot;1371&quot;
inkscape:window-x=&quot;0&quot;
inkscape:window-y=&quot;0&quot;
inkscape:window-maximized=&quot;1&quot;
inkscape:current-layer=&quot;artwork&quot; /&gt;
<defs
     id="defs4">
<style
       id="style2">
.cls-1, .cls-2, .cls-3 {
fill: none;
}
.cls-2 {
stroke: #06c;
}
.cls-2, .cls-4 {
stroke-linecap: round;
stroke-linejoin: round;
}
.cls-5 {
fill: #06c;
}
.cls-6, .cls-4 {
fill: #fff;
}
.cls-7 {
fill: #e8e8e8;
}
.cls-8, .cls-9 {
font-family: RedHatTextRoman-Medium, 'Red Hat Text';
font-variation-settings: 'wght' 500;
font-weight: 500;
}
.cls-8, .cls-10, .cls-11 {
fill: #151515;
font-size: 12px;
}
.cls-12 {
fill: #ececec;
font-size: 10px;
}
.cls-12, .cls-13 {
font-family: RedHatTextRoman-Regular, 'Red Hat Text';
font-variation-settings: 'wght' 400;
}
.cls-3 {
stroke: #adadad;
stroke-miterlimit: 10;
}
.cls-4 {
stroke: #5b5b5b;
stroke-width: 1.5px;
}
.cls-11 {
font-family: RedHatTextRoman-Bold, 'Red Hat Text';
font-variation-settings: 'wght' 700;
font-weight: 700;
}
</style>
</defs>
<g
     id="g12">
<text
       class="cls-12"
       transform="translate(715.77 294.65)"
       id="text8"><tspan
         x="0"
         y="0"
         id="tspan6">306_0123</tspan></text>
<rect
       class="cls-1"
       y="271.63"
       width="760"
       height="40"
       id="rect10" />
</g>
<g
     id="g20">
<rect
       class="cls-7"
       x="575"
       y="20"
       width="185"
       height="114.5"
       transform="translate(1335 154.5) rotate(-180)"
       id="rect14" />
<text
       class="cls-11"
       transform="translate(590 43.85)"
       id="text18"><tspan
         x="0"
         y="0"
         id="tspan16">AmazonEC2</tspan></text>
</g>
<rect
     class="cls-7"
     x="375"
     y="20"
     width="175"
     height="114.5"
     transform="translate(925 154.5) rotate(-180)"
     id="rect22" />
<text
     class="cls-11"
     transform="translate(390 43.85)"
     id="text26"><tspan
       x="0"
       y="0"
       id="tspan24">api.openshift.com</tspan></text>
<a
     id="a403"
     xlink:href="https://github.com/osbuild/osbuild-composer/tree/e5c46409233345a6db7d0d7cbe015523f9d0809c">
<g
       id="g40">
<g
         id="g32">
<rect
           class="cls-6"
           x="390.5"
           y="60"
           width="144"
           height="49"
           id="rect28" />
<path
           class="cls-5"
           d="M534,60.5v48h-143V60.5h143m1-1h-145v50h145V59.5h0Z"
           id="path30" />
</g>
<text
         class="cls-8"
         transform="translate(420.17 81.44)"
         id="text38"><tspan
           x="0"
           y="0"
           id="tspan34">image-builder-</tspan><tspan
           x="14.45"
           y="13"
           id="tspan36">composer</tspan></text>
</g>
</a>
<rect
     class="cls-7"
     x="375"
     y="159.5"
     width="175"
     height="135"
     transform="translate(925 454) rotate(-180)"
     id="rect42" />
<rect
     class="cls-7"
     x="175"
     y="159.5"
     width="175"
     height="135"
     transform="translate(525 454) rotate(-180)"
     id="rect44" />
<text
     class="cls-11"
     transform="translate(390 279.57)"
     id="text48"><tspan
       x="0"
       y="0"
       id="tspan46">AmazonRDS</tspan></text>
<text
     class="cls-11"
     transform="translate(190 279.57)"
     id="text52"><tspan
       x="0"
       y="0"
       id="tspan50">AmazonRDS</tspan></text>
<rect
     class="cls-7"
     x="0"
     y="20"
     width="350"
     height="114.5"
     transform="translate(350 154.5) rotate(-180)"
     id="rect54" />
<g
     id="g76">
<g
       id="g64">
<path
         class="cls-4"
         d="M262.5,184.25c-10.19,0-18.45,4.06-18.45,9.69v16.94c0,5.63,8.26,10.19,18.45,10.19s18.45-4.56,18.45-10.19v-16.94c0-5.63-8.26-9.69-18.45-9.69Z"
         id="path56" />
<path
         class="cls-4"
         d="M280.95,205.19c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19"
         id="path58" />
<path
         class="cls-4"
         d="M280.95,199.44c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19"
         id="path60" />
<path
         class="cls-4"
         d="M280.95,193.94c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19,8.26-9.69,18.45-9.69,18.45,4.06,18.45,9.69Z"
         id="path62" />
</g>
<text
       class="cls-10"
       transform="translate(212.83 238.72)"
       id="text74"><tspan
         class="cls-9"
         id="tspan68"><tspan
           x="0"
           y="0"
           id="tspan66">image-builder-db</tspan></tspan><tspan
         class="cls-13"
         id="tspan72"><tspan
           x="1.16"
           y="15"
           id="tspan70">(Insights account)</tspan></tspan></text>
</g>
<g
     id="g82">
<line
       class="cls-2"
       x1="180.83"
       y1="84.5"
       x2="165.01"
       y2="84.5"
       id="line78" />
<polygon
       class="cls-5"
       points="179.37 79.51 188.01 84.5 179.37 89.49 179.37 79.51"
       id="polygon80" />
</g>
<g
     id="g88">
<line
       class="cls-2"
       x1="262.5"
       y1="173.79"
       x2="262.5"
       y2="109.5"
       id="line84" />
<polygon
       class="cls-5"
       points="267.49 172.34 262.5 180.97 257.51 172.34 267.49 172.34"
       id="polygon86" />
</g>
<g
     id="g110">
<g
       id="g98">
<path
         class="cls-4"
         d="M462.5,184.25c-10.19,0-18.45,4.06-18.45,9.69v16.94c0,5.63,8.26,10.19,18.45,10.19s18.45-4.56,18.45-10.19v-16.94c0-5.63-8.26-9.69-18.45-9.69Z"
         id="path90" />
<path
         class="cls-4"
         d="M480.95,205.19c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19"
         id="path92" />
<path
         class="cls-4"
         d="M480.95,199.44c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19"
         id="path94" />
<path
         class="cls-4"
         d="M480.95,193.94c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19,8.26-9.69,18.45-9.69,18.45,4.06,18.45,9.69Z"
         id="path96" />
</g>
<text
       class="cls-10"
       transform="translate(424.51 238.72)"
       id="text108"><tspan
         class="cls-9"
         id="tspan102"><tspan
           x="0"
           y="0"
           id="tspan100">composer-db</tspan></tspan><tspan
         class="cls-13"
         id="tspan106"><tspan
           x="-12.14"
           y="15"
           id="tspan104">(AppSRE account)</tspan></tspan></text>
</g>
<g
     id="g116">
<line
       class="cls-2"
       x1="462.5"
       y1="173.79"
       x2="462.5"
       y2="109.5"
       id="line112" />
<polygon
       class="cls-5"
       points="467.49 172.34 462.5 180.97 457.51 172.34 467.49 172.34"
       id="polygon114" />
</g>
<g
     id="g122">
<line
       class="cls-2"
       x1="380.32"
       y1="84.5"
       x2="335"
       y2="84.5"
       id="line118" />
<polygon
       class="cls-5"
       points="378.86 79.51 387.5 84.5 378.86 89.49 378.86 79.51"
       id="polygon120" />
</g>
<g
     id="g128">
<line
       class="cls-2"
       x1="590"
       y1="84.5"
       x2="544.68"
       y2="84.5"
       id="line124" />
<polygon
       class="cls-5"
       points="546.14 79.51 537.5 84.5 546.14 89.49 546.14 79.51"
       id="polygon126" />
</g>
<text
     class="cls-11"
     transform="translate(15 43.85)"
     id="text132"><tspan
       x="0"
       y="0"
       id="tspan130">console.redhat.com</tspan></text>
<a
     id="a294"
     xlink:href="https://github.com/RedHatInsights/image-builder-frontend/tree/4fe1242c49303bfbcbb7128a08ca2d672418ea5a">
<g
       id="g146"
       onclick="https://github.com/RedHatInsights/image-builder-frontend/tree/4fe1242c49303bfbcbb7128a08ca2d672418ea5a">
<g
         id="g138">
<rect
           class="cls-6"
           x="15.5"
           y="60"
           width="149"
           height="49"
           id="rect134" />
<path
           class="cls-5"
           d="M164,60.5v48H16V60.5H164m1-1H15v50H165V59.5h0Z"
           id="path136" />
</g>
<text
         class="cls-8"
         transform="translate(50.17 81.44)"
         id="text144"><tspan
           x="0"
           y="0"
           id="tspan140">image-builder-</tspan><tspan
           x="17.37"
           y="13"
           id="tspan142">frontend</tspan></text>
</g>
</a>
<polyline
     class="cls-3"
     points="595 114.5 740 114.5 740 64.5"
     id="polyline148" />
<polyline
     class="cls-3"
     points="600 119.5 745 119.5 745 69.5"
     id="polyline150" />
<a
     id="a510"
     xlink:href="https://github.com/osbuild/osbuild/tree/433515cff898168b204833941a6d32399152128b">
<g
       id="g502">
<g
         id="g156">
<rect
           class="cls-6"
           x="590.5"
           y="60"
           width="144"
           height="49"
           id="rect152" />
<path
           class="cls-5"
           d="M734,60.5v48h-143V60.5h143m1-1h-145v50h145V59.5h0Z"
           id="path154" />
</g>
<text
         class="cls-8"
         transform="translate(628.43 88)"
         id="text160"><tspan
           x="0"
           y="0"
           id="tspan158">worker fleet</tspan></text>
</g>
</a>
<a
     id="a303"
     xlink:href="https://github.com/osbuild/image-builder/tree/c27adabf487e2ced3adcd29ad2e62f73c1662bfd">
<g
       id="g174">
<g
         id="g166">
<rect
           class="cls-6"
           x="190.5"
           y="60"
           width="144"
           height="49"
           id="rect162" />
<path
           class="cls-5"
           d="M334,60.5v48H191V60.5h143m1-1H190v50h145V59.5h0Z"
           id="path164" />
</g>
<text
         class="cls-8"
         transform="translate(220.17 81.44)"
         id="text172"><tspan
           x="0"
           y="0"
           id="tspan168">image-builder-</tspan><tspan
           x="18.4"
           y="13"
           id="tspan170">backend</tspan></text>
</g>
</a>
</svg></p>
<p>Image Builder is available as a managed service as part of <a href="https://console.redhat.com">Red Hat's Hybrid Cloud Console</a>. It is used during the development of RHEL and Fedora but is also used by Red Hat‚Äôs customers or anyone with a <a href="https://developers.redhat.com/register">Red Hat developer license</a>. It builds customized images of RHEL and CentOS Stream for many footprints (traditional, ostree-based), targets (Public clouds, Baremetal, etc), and architectures (x86, ARM, IBM).</p>
<p><a href="./image-builder-service/architecture.html"><strong>Documentation</strong></a></p>
<h2 id="image-builder-on-premises"><a class="header" href="#image-builder-on-premises">Image Builder on premises</a></h2>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<p><svg
   id="artwork"
   viewBox="0 0 605 210"
   version="1.1"
   sodipodi:docname="onpremises.svg"
   inkscape:version="1.2.2 (b0a8486541, 2022-12-01)"
   width="605"
   height="210"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
&lt;sodipodi:namedview
id=&quot;namedview177&quot;
pagecolor=&quot;#ffffff&quot;
bordercolor=&quot;#666666&quot;
borderopacity=&quot;1.0&quot;
inkscape:showpageshadow=&quot;2&quot;
inkscape:pageopacity=&quot;0.0&quot;
inkscape:pagecheckerboard=&quot;0&quot;
inkscape:deskcolor=&quot;#d1d1d1&quot;
showgrid=&quot;false&quot;
inkscape:zoom=&quot;1.7118421&quot;
inkscape:cx=&quot;353.42045&quot;
inkscape:cy=&quot;155.97233&quot;
inkscape:window-width=&quot;1920&quot;
inkscape:window-height=&quot;1011&quot;
inkscape:window-x=&quot;0&quot;
inkscape:window-y=&quot;0&quot;
inkscape:window-maximized=&quot;1&quot;
inkscape:current-layer=&quot;artwork&quot; /&gt;
<defs
     id="defs4">
<style
       id="style2">
.cls-1, .cls-2, .cls-3 {
fill: none;
}
.cls-2 {
stroke: #06c;
}
.cls-2, .cls-4 {
stroke-linecap: round;
stroke-linejoin: round;
}
.cls-5 {
fill: #06c;
}
.cls-6, .cls-4 {
fill: #fff;
}
.cls-7 {
fill: #e8e8e8;
}
.cls-8, .cls-9 {
font-family: RedHatTextRoman-Medium, 'Red Hat Text';
font-variation-settings: 'wght' 500;
font-weight: 500;
}
.cls-8, .cls-10, .cls-11 {
fill: #151515;
font-size: 12px;
}
.cls-12 {
fill: #ececec;
font-size: 10px;
}
.cls-12, .cls-13 {
font-family: RedHatTextRoman-Regular, 'Red Hat Text';
font-variation-settings: 'wght' 400;
}
.cls-3 {
stroke: #adadad;
stroke-miterlimit: 10;
}
.cls-4 {
stroke: #5b5b5b;
stroke-width: 1.5px;
}
.cls-11 {
font-family: RedHatTextRoman-Bold, 'Red Hat Text';
font-variation-settings: 'wght' 700;
font-weight: 700;
}
</style>
</defs>
<rect
     class="cls-7"
     x="-185"
     y="-200"
     width="175"
     height="190"
     transform="scale(-1)"
     id="rect452"
     style="stroke-width:1.28817" />
<g
     id="g450"
     transform="matrix(0.96666667,0,0,1,10.5,56.75)">
<g
       id="g138">
<rect
         class="cls-6"
         x="15.5"
         y="60"
         width="149"
         height="49"
         id="rect134" />
<path
         class="cls-5"
         d="m 164,60.5 v 48 H 16 v -48 h 148 m 1,-1 H 15 v 50 h 150 z"
         id="path136" />
</g>
<text
       class="cls-8"
       id="text144"
       x="53.315987"
       y="87.697998">composer-cli</text>
</g>
<rect
     class="cls-7"
     x="-595"
     y="-162.25"
     width="185"
     height="114.5"
     transform="scale(-1)"
     id="rect14" />
<rect
     class="cls-7"
     x="-385"
     y="-162.25"
     width="175"
     height="114.5"
     transform="scale(-1)"
     id="rect22" />
<g
     id="g419"
     transform="translate(-165,20.5)">
<g
       id="g32">
<rect
         class="cls-6"
         x="390.5"
         y="60"
         width="144"
         height="49"
         id="rect28" />
<path
         class="cls-5"
         d="m 534,60.5 v 48 H 391 v -48 h 143 m 1,-1 H 390 v 50 h 145 z"
         id="path30" />
</g>
<text
       class="cls-8"
       id="text38"
       x="396.94199"
       y="74.697998"><tspan
         x="411.39197"
         y="87.697998"
         id="tspan36">osbuild-composer</tspan></text>
</g>
<g
     id="g128"
     transform="translate(-165,20.5)">
<line
       class="cls-2"
       x1="590"
       y1="84.5"
       x2="544.67999"
       y2="84.5"
       id="line124" />
<polygon
       class="cls-5"
       points="546.14,79.51 537.5,84.5 546.14,89.49 "
       id="polygon126" />
</g>
<polyline
     class="cls-3"
     points="595 114.5 740 114.5 740 64.5"
     id="polyline148"
     transform="translate(-165,20.5)" />
<polyline
     class="cls-3"
     points="600 119.5 745 119.5 745 69.5"
     id="polyline150"
     transform="translate(-165,20.5)" />
<g
     id="g156"
     transform="translate(-165,20.5)">
<rect
       class="cls-6"
       x="590.5"
       y="60"
       width="144"
       height="49"
       id="rect152" />
<path
       class="cls-5"
       d="m 734,60.5 v 48 H 591 v -48 h 143 m 1,-1 H 590 v 50 h 145 z"
       id="path154" />
</g>
<text
     class="cls-8"
     id="text160"
     x="473.54202"
     y="108.5"><tspan
       x="473.54202"
       y="108.5"
       id="tspan158">worker/s</tspan></text>
<g
     id="g166"
     transform="translate(-165,-17.25)">
<rect
       class="cls-6"
       x="190.5"
       y="60"
       width="144"
       height="49"
       id="rect162" />
<path
       class="cls-5"
       d="m 334,60.5 v 48 H 191 v -48 h 143 m 1,-1 H 190 v 50 h 145 z"
       id="path164" />
</g>
<text
     class="cls-8"
     id="text172"
     x="46.043976"
     y="70.447998">cockpit-composer</text>
<g
     id="g1474"
     transform="translate(0,-17.25)">
<polygon
       class="cls-5"
       points="378.86,79.51 387.5,84.5 378.86,89.49 "
       id="polygon706"
       transform="rotate(-31.536727,378.99421,397.49701)"
       style="fill:#0066cc" />
<path
       style="fill:none;stroke:#0066cc;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
       d="m 169.85711,158.77108 45.70814,-28.22652"
       id="path793" />
</g>
<g
     id="g1480"
     transform="matrix(1,0,0,-1,0,226.22566)">
<polygon
       class="cls-5"
       points="387.5,84.5 378.86,89.49 378.86,79.51 "
       id="polygon1476"
       transform="rotate(-31.536727,378.99421,397.49701)"
       style="fill:#0066cc" />
<path
       style="fill:none;stroke:#0066cc;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
       d="m 169.85711,158.77108 45.70814,-28.22652"
       id="path1478" />
</g>
</svg></p>
<p>Image Builder can also be deployed and self-hosted. In its most basic setup, it will use one osbuild-composer service and one worker running osbuild. The architecture you can build images for will depend on the architecture of the worker, i.e. on an x86 worker you can only build x86 images. You can leverage <a href="./image-builder-on-premises/blueprint-reference.html">blueprints</a> to customize your images.</p>
<p><a href="./image-builder-on-premises/image-builder-on-premises.html"><strong>Documentation</strong></a></p>
<h2 id="how-to-contribute"><a class="header" href="#how-to-contribute">How to contribute</a></h2>
<p>All of our code is open source and <a href="https://github.com/osbuild">on GitHub</a>.</p>
<p>Our <a href="https://www.osbuild.org/guides/developer-guide/developer-guide.html">developer guide</a> is a great starting point to learn about our workflow, code style and more!</p>
<h3 id="how-to-reach-out-to-us"><a class="header" href="#how-to-reach-out-to-us">How to reach out to us</a></h3>
<ul>
<li>Matrix: <code>#image-builder</code> on fedoraproject.org</li>
<li>Mailing List: <a href="mailto:image-builder@redhat.com">image-builder@redhat.com</a></li>
<li>Issues and pull requests: <a href="https://github.com/osbuild">github.com/osbuild</a></li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h2 id="service-architecture"><a class="header" href="#service-architecture">Service architecture</a></h2>
<p>This service is open source, so all of its code is inspectable and can be contributed to.</p>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<p><svg
   id="artwork"
   viewBox="0 0 760 311.63"
   version="1.1"
   sodipodi:docname="306_OpenShift_OSBuild_upstream_0123.svg"
   inkscape:version="1.2.2 (b0a8486541, 2022-12-01)"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns:xlink="http://www.w3.org/1999/xlink"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
&lt;sodipodi:namedview
id=&quot;namedview177&quot;
pagecolor=&quot;#ffffff&quot;
bordercolor=&quot;#666666&quot;
borderopacity=&quot;1.0&quot;
inkscape:showpageshadow=&quot;2&quot;
inkscape:pageopacity=&quot;0.0&quot;
inkscape:pagecheckerboard=&quot;0&quot;
inkscape:deskcolor=&quot;#d1d1d1&quot;
showgrid=&quot;false&quot;
inkscape:zoom=&quot;1.7118421&quot;
inkscape:cx=&quot;287.99385&quot;
inkscape:cy=&quot;155.97233&quot;
inkscape:window-width=&quot;2560&quot;
inkscape:window-height=&quot;1371&quot;
inkscape:window-x=&quot;0&quot;
inkscape:window-y=&quot;0&quot;
inkscape:window-maximized=&quot;1&quot;
inkscape:current-layer=&quot;artwork&quot; /&gt;
<defs
     id="defs4">
<style
       id="style2">
.cls-1, .cls-2, .cls-3 {
fill: none;
}
.cls-2 {
stroke: #06c;
}
.cls-2, .cls-4 {
stroke-linecap: round;
stroke-linejoin: round;
}
.cls-5 {
fill: #06c;
}
.cls-6, .cls-4 {
fill: #fff;
}
.cls-7 {
fill: #e8e8e8;
}
.cls-8, .cls-9 {
font-family: RedHatTextRoman-Medium, 'Red Hat Text';
font-variation-settings: 'wght' 500;
font-weight: 500;
}
.cls-8, .cls-10, .cls-11 {
fill: #151515;
font-size: 12px;
}
.cls-12 {
fill: #ececec;
font-size: 10px;
}
.cls-12, .cls-13 {
font-family: RedHatTextRoman-Regular, 'Red Hat Text';
font-variation-settings: 'wght' 400;
}
.cls-3 {
stroke: #adadad;
stroke-miterlimit: 10;
}
.cls-4 {
stroke: #5b5b5b;
stroke-width: 1.5px;
}
.cls-11 {
font-family: RedHatTextRoman-Bold, 'Red Hat Text';
font-variation-settings: 'wght' 700;
font-weight: 700;
}
</style>
</defs>
<g
     id="g12">
<text
       class="cls-12"
       transform="translate(715.77 294.65)"
       id="text8"><tspan
         x="0"
         y="0"
         id="tspan6">306_0123</tspan></text>
<rect
       class="cls-1"
       y="271.63"
       width="760"
       height="40"
       id="rect10" />
</g>
<g
     id="g20">
<rect
       class="cls-7"
       x="575"
       y="20"
       width="185"
       height="114.5"
       transform="translate(1335 154.5) rotate(-180)"
       id="rect14" />
<text
       class="cls-11"
       transform="translate(590 43.85)"
       id="text18"><tspan
         x="0"
         y="0"
         id="tspan16">AmazonEC2</tspan></text>
</g>
<rect
     class="cls-7"
     x="375"
     y="20"
     width="175"
     height="114.5"
     transform="translate(925 154.5) rotate(-180)"
     id="rect22" />
<text
     class="cls-11"
     transform="translate(390 43.85)"
     id="text26"><tspan
       x="0"
       y="0"
       id="tspan24">api.openshift.com</tspan></text>
<a
     id="a403"
     xlink:href="https://github.com/osbuild/osbuild-composer/tree/e5c46409233345a6db7d0d7cbe015523f9d0809c">
<g
       id="g40">
<g
         id="g32">
<rect
           class="cls-6"
           x="390.5"
           y="60"
           width="144"
           height="49"
           id="rect28" />
<path
           class="cls-5"
           d="M534,60.5v48h-143V60.5h143m1-1h-145v50h145V59.5h0Z"
           id="path30" />
</g>
<text
         class="cls-8"
         transform="translate(420.17 81.44)"
         id="text38"><tspan
           x="0"
           y="0"
           id="tspan34">image-builder-</tspan><tspan
           x="14.45"
           y="13"
           id="tspan36">composer</tspan></text>
</g>
</a>
<rect
     class="cls-7"
     x="375"
     y="159.5"
     width="175"
     height="135"
     transform="translate(925 454) rotate(-180)"
     id="rect42" />
<rect
     class="cls-7"
     x="175"
     y="159.5"
     width="175"
     height="135"
     transform="translate(525 454) rotate(-180)"
     id="rect44" />
<text
     class="cls-11"
     transform="translate(390 279.57)"
     id="text48"><tspan
       x="0"
       y="0"
       id="tspan46">AmazonRDS</tspan></text>
<text
     class="cls-11"
     transform="translate(190 279.57)"
     id="text52"><tspan
       x="0"
       y="0"
       id="tspan50">AmazonRDS</tspan></text>
<rect
     class="cls-7"
     x="0"
     y="20"
     width="350"
     height="114.5"
     transform="translate(350 154.5) rotate(-180)"
     id="rect54" />
<g
     id="g76">
<g
       id="g64">
<path
         class="cls-4"
         d="M262.5,184.25c-10.19,0-18.45,4.06-18.45,9.69v16.94c0,5.63,8.26,10.19,18.45,10.19s18.45-4.56,18.45-10.19v-16.94c0-5.63-8.26-9.69-18.45-9.69Z"
         id="path56" />
<path
         class="cls-4"
         d="M280.95,205.19c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19"
         id="path58" />
<path
         class="cls-4"
         d="M280.95,199.44c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19"
         id="path60" />
<path
         class="cls-4"
         d="M280.95,193.94c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19,8.26-9.69,18.45-9.69,18.45,4.06,18.45,9.69Z"
         id="path62" />
</g>
<text
       class="cls-10"
       transform="translate(212.83 238.72)"
       id="text74"><tspan
         class="cls-9"
         id="tspan68"><tspan
           x="0"
           y="0"
           id="tspan66">image-builder-db</tspan></tspan><tspan
         class="cls-13"
         id="tspan72"><tspan
           x="1.16"
           y="15"
           id="tspan70">(Insights account)</tspan></tspan></text>
</g>
<g
     id="g82">
<line
       class="cls-2"
       x1="180.83"
       y1="84.5"
       x2="165.01"
       y2="84.5"
       id="line78" />
<polygon
       class="cls-5"
       points="179.37 79.51 188.01 84.5 179.37 89.49 179.37 79.51"
       id="polygon80" />
</g>
<g
     id="g88">
<line
       class="cls-2"
       x1="262.5"
       y1="173.79"
       x2="262.5"
       y2="109.5"
       id="line84" />
<polygon
       class="cls-5"
       points="267.49 172.34 262.5 180.97 257.51 172.34 267.49 172.34"
       id="polygon86" />
</g>
<g
     id="g110">
<g
       id="g98">
<path
         class="cls-4"
         d="M462.5,184.25c-10.19,0-18.45,4.06-18.45,9.69v16.94c0,5.63,8.26,10.19,18.45,10.19s18.45-4.56,18.45-10.19v-16.94c0-5.63-8.26-9.69-18.45-9.69Z"
         id="path90" />
<path
         class="cls-4"
         d="M480.95,205.19c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19"
         id="path92" />
<path
         class="cls-4"
         d="M480.95,199.44c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19"
         id="path94" />
<path
         class="cls-4"
         d="M480.95,193.94c0,5.63-8.26,10.19-18.45,10.19s-18.45-4.56-18.45-10.19,8.26-9.69,18.45-9.69,18.45,4.06,18.45,9.69Z"
         id="path96" />
</g>
<text
       class="cls-10"
       transform="translate(424.51 238.72)"
       id="text108"><tspan
         class="cls-9"
         id="tspan102"><tspan
           x="0"
           y="0"
           id="tspan100">composer-db</tspan></tspan><tspan
         class="cls-13"
         id="tspan106"><tspan
           x="-12.14"
           y="15"
           id="tspan104">(AppSRE account)</tspan></tspan></text>
</g>
<g
     id="g116">
<line
       class="cls-2"
       x1="462.5"
       y1="173.79"
       x2="462.5"
       y2="109.5"
       id="line112" />
<polygon
       class="cls-5"
       points="467.49 172.34 462.5 180.97 457.51 172.34 467.49 172.34"
       id="polygon114" />
</g>
<g
     id="g122">
<line
       class="cls-2"
       x1="380.32"
       y1="84.5"
       x2="335"
       y2="84.5"
       id="line118" />
<polygon
       class="cls-5"
       points="378.86 79.51 387.5 84.5 378.86 89.49 378.86 79.51"
       id="polygon120" />
</g>
<g
     id="g128">
<line
       class="cls-2"
       x1="590"
       y1="84.5"
       x2="544.68"
       y2="84.5"
       id="line124" />
<polygon
       class="cls-5"
       points="546.14 79.51 537.5 84.5 546.14 89.49 546.14 79.51"
       id="polygon126" />
</g>
<text
     class="cls-11"
     transform="translate(15 43.85)"
     id="text132"><tspan
       x="0"
       y="0"
       id="tspan130">console.redhat.com</tspan></text>
<a
     id="a294"
     xlink:href="https://github.com/RedHatInsights/image-builder-frontend/tree/4fe1242c49303bfbcbb7128a08ca2d672418ea5a">
<g
       id="g146"
       onclick="https://github.com/RedHatInsights/image-builder-frontend/tree/4fe1242c49303bfbcbb7128a08ca2d672418ea5a">
<g
         id="g138">
<rect
           class="cls-6"
           x="15.5"
           y="60"
           width="149"
           height="49"
           id="rect134" />
<path
           class="cls-5"
           d="M164,60.5v48H16V60.5H164m1-1H15v50H165V59.5h0Z"
           id="path136" />
</g>
<text
         class="cls-8"
         transform="translate(50.17 81.44)"
         id="text144"><tspan
           x="0"
           y="0"
           id="tspan140">image-builder-</tspan><tspan
           x="17.37"
           y="13"
           id="tspan142">frontend</tspan></text>
</g>
</a>
<polyline
     class="cls-3"
     points="595 114.5 740 114.5 740 64.5"
     id="polyline148" />
<polyline
     class="cls-3"
     points="600 119.5 745 119.5 745 69.5"
     id="polyline150" />
<a
     id="a510"
     xlink:href="https://github.com/osbuild/osbuild/tree/433515cff898168b204833941a6d32399152128b">
<g
       id="g502">
<g
         id="g156">
<rect
           class="cls-6"
           x="590.5"
           y="60"
           width="144"
           height="49"
           id="rect152" />
<path
           class="cls-5"
           d="M734,60.5v48h-143V60.5h143m1-1h-145v50h145V59.5h0Z"
           id="path154" />
</g>
<text
         class="cls-8"
         transform="translate(628.43 88)"
         id="text160"><tspan
           x="0"
           y="0"
           id="tspan158">worker fleet</tspan></text>
</g>
</a>
<a
     id="a303"
     xlink:href="https://github.com/osbuild/image-builder/tree/c27adabf487e2ced3adcd29ad2e62f73c1662bfd">
<g
       id="g174">
<g
         id="g166">
<rect
           class="cls-6"
           x="190.5"
           y="60"
           width="144"
           height="49"
           id="rect162" />
<path
           class="cls-5"
           d="M334,60.5v48H191V60.5h143m1-1H190v50h145V59.5h0Z"
           id="path164" />
</g>
<text
         class="cls-8"
         transform="translate(220.17 81.44)"
         id="text172"><tspan
           x="0"
           y="0"
           id="tspan168">image-builder-</tspan><tspan
           x="18.4"
           y="13"
           id="tspan170">backend</tspan></text>
</g>
</a>
</svg></p>
<blockquote>
<p>Click each component in this diagram to get to the <strong>hash</strong> of the source code <strong>currently running in production</strong>.</p>
</blockquote>
<p>The metadata defining the service for App-Interface is kept upstream and open as templates for both the <a href="https://github.com/osbuild/osbuild-composer/blob/main/templates/composer.yml">osbuild-composer</a> and <a href="https://github.com/osbuild/image-builder/blob/main/templates/image-builder.yml">image-builder components</a>.
The tooling to operate the service is to large parts open source and publicly accessible, e.g. qontract in the form of <a href="https://github.com/app-sre/qontract-server">qontract-server</a>, <a href="https://github.com/app-sre/qontract-reconcile">qontract-reconcile</a>.
The architecture documents in this section comply with the AppSRE contract.</p>
<ul>
<li><a href="https://developers.redhat.com/api-catalog/api/image-builder">Service API documentation</a></li>
</ul>
<h2 id="how-to-contribute-1"><a class="header" href="#how-to-contribute-1">How to contribute</a></h2>
<p>Our <a href="image-builder-service/../developer-guide/index.html">developer guide</a> is a great starting point to learn about our workflow, code style and more!</p>
<p>If you want to contribute to our frontend or backend, here are guides on how to get the respective stack set up for development:</p>
<ul>
<li><a href="https://github.com/RedHatInsights/image-builder-frontend#frontend-development">image-builder-frontend</a></li>
<li><a href="https://github.com/RedHatInsights/image-builder-frontend/blob/main/devel/README.md">image-builder-backend</a></li>
</ul>
<h3 id="how-to-reach-out-to-us-1"><a class="header" href="#how-to-reach-out-to-us-1">How to reach out to us</a></h3>
<ul>
<li>Matrix: <code>#image-builder</code> on fedoraproject.org</li>
<li>Mailing List: <a href="mailto:image-builder@redhat.com">image-builder@redhat.com</a></li>
<li>Issues: <a href="https://issues.redhat.com/issues/?jql=project%20%3D%20HMS%20and%20component%20in%20(%22Image%20Builder%22)">Service</a>, <a href="https://issues.redhat.com/issues/?jql=project%20%3D%20COMPOSER">On premises</a>, <a href="https://github.com/osbuild">github.com/osbuild</a></li>
<li>Pull requests: <a href="https://github.com/osbuild">github.com/osbuild</a></li>
</ul>
<h2 id="how-open-is-this-service"><a class="header" href="#how-open-is-this-service">How open is this service?</a></h2>
<h4 id="-open-assets"><a class="header" href="#-open-assets">üü¢ Open assets</a></h4>
<ul>
<li>üü¢ <a href="https://github.com/osbuild">The source code is open.</a></li>
<li>üü¢ Unit tests are open.</li>
<li>üü¢ Performance tests are open.</li>
<li>üü¢ Functional tests are open.</li>
<li>üü¢ The dependencies are open source.</li>
<li>üü¢ Deployment metadata is open. <a href="https://github.com/osbuild/osbuild-composer/blob/main/templates/composer.yml">[1]</a> <a href="https://github.com/osbuild/image-builder/blob/main/templates/image-builder.yml">[2]</a></li>
</ul>
<h4 id="-contribution-workflow"><a class="header" href="#-contribution-workflow">üü¢ Contribution workflow</a></h4>
<ul>
<li>üü¢ External contributors can follow the same workflow as team members.</li>
<li>üü¢ <a href="image-builder-service/../developer-guide/general/workflow.html">The workflow is publicly documented.</a></li>
<li>üü¢ Regular contributors can trigger CI.</li>
<li>üü¢ External contributions are eagerly reviewed.</li>
</ul>
<h4 id="-issue-tracking-and-planning"><a class="header" href="#-issue-tracking-and-planning">üü† Issue tracking and planning</a></h4>
<ul>
<li>üü¢ The issue tracker is public. <a href="https://github.com/osbuild">[1]</a> <a href="https://issues.redhat.com/issues/?jql=project%20%3D%20COMPOSER%20or%20(project%20%3D%20HMS%20AND%20component%20in%20(%22Image%20Builder%22))">[2]</a></li>
<li>üü† The roadmap is public. <a href="https://github.com/orgs/osbuild/projects">[1]</a></li>
</ul>
<h4 id="-documentation"><a class="header" href="#-documentation">üü¢ Documentation</a></h4>
<ul>
<li>üü¢ <a href="https://www.osbuild.org/guides/introduction.html">User documentation is public.</a></li>
<li>üü¢ <a href="image-builder-service/../developer-guide/index.html">Developer documentation is public.</a></li>
</ul>
<h4 id="-communication"><a class="header" href="#-communication">üü† Communication</a></h4>
<ul>
<li>üü¢ <a href="mailto:image-builder@redhat.com">There is a public mailinglist.</a></li>
<li>üî¥ There are public meetings.</li>
</ul>
<h4 id="-open-site-reliability-engineering"><a class="header" href="#-open-site-reliability-engineering">üü† Open Site Reliability Engineering</a></h4>
<ul>
<li>üü¢ <a href="https://status.redhat.com">There is an open status page.</a></li>
<li>üî¥ Logging, monitoring, and alerting is open.</li>
<li>üî¥ Incident management is open.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="image-builder-crc-api-architecture-document"><a class="header" href="#image-builder-crc-api-architecture-document">Image Builder CRC API Architecture Document</a></h1>
<h2 id="service-description"><a class="header" href="#service-description">Service Description</a></h2>
<p>The <code>image-builder</code> API in CRC serves as the public API used either directly by customers or through the
CRC UI. Through this API customers can create, manage and view image builds. The service in CRC is
responsible for access management, quotas, rate-limiting, etc. In the future it may interact with other
services in CRC in order to add value to the image build experience.</p>
<p>The actual image build requests are passed on to <code>composer</code>, which is outside the scope of this document.</p>
<h2 id="technology-stack"><a class="header" href="#technology-stack">Technology Stack</a></h2>
<p>The service is written in Golang, and the list of dependencies can be found in
<a href="https://github.com/osbuild/image-builder/blob/main/go.mod">go.mod</a>.</p>
<p>The <code>ubi8/go-toolset:latest</code> container is used as a builder, and <code>ubi8/ubi-minimal:latest</code> to run the
binary. The container images are located here: https://quay.io/repository/cloudservices/image-builder.</p>
<h2 id="components"><a class="header" href="#components">Components</a></h2>
<p>The service consists of the image-builder app running in CRC, and its backing database. If either of
these are unavailable, the service does not work at all, new images cannot be built, and historical
builds cannot be introspected. Already built images that may be in used by customers are unaffected,
only their history and metadata can no longer be queried through the service.</p>
<h2 id="routes"><a class="header" href="#routes">Routes</a></h2>
<p>The public route is <code>/api/v1/image-builder</code>, a detailed list can be found at
<a href="https://console.redhat.com/docs/api/image-builder">https://console.redhat.com/docs/api/image-builder</a>.</p>
<h2 id="dependencies"><a class="header" href="#dependencies">Dependencies</a></h2>
<p>Image builder has the following internal and external dependencies.</p>
<h3 id="internal"><a class="header" href="#internal">Internal</a></h3>
<p>Image Builder relies on 3Scale to set the <code>x-rh-identity</code> header. It uses the header for authentication,
and quota application. It also uses the account number to map previously made compose requests to that
account number.</p>
<h3 id="external"><a class="header" href="#external">External</a></h3>
<ul>
<li>AWS RDS for data storage. See the section on state.</li>
<li>Quay as a container registry. Without this, the service cannot be redeployed.</li>
<li>Github as an upstream repository. Without this, the service cannot be redeployed.</li>
<li>Gitlab, AWS EC2, and Openstack for upstream testing. Without this changes to the service cannot land.</li>
</ul>
<h2 id="service-diagram"><a class="header" href="#service-diagram">Service Diagram</a></h2>
<p>See parent page.</p>
<h2 id="application-success-criteria"><a class="header" href="#application-success-criteria">Application Success Criteria</a></h2>
<ol>
<li>Customers can queue image builds and view their state.</li>
<li>Customers can introspect and manage existing builds.</li>
<li>Quotas are applied according to policy to manage cost of running the service.</li>
<li>The service is able to provide functionality to make its own functionality discoverable</li>
</ol>
<ul>
<li>Enumerate supported features</li>
<li>Package search</li>
</ul>
<h2 id="slos"><a class="header" href="#slos">SLOs</a></h2>
<p>The image builder API has the following SLOs, but we aim to add more and make these stricter as we
gain more experience from production. Our SLO targets are defined in App Interface.</p>
<h3 id="latency"><a class="header" href="#latency">Latency</a></h3>
<p>The ratio of requests that are considered significantly fast. The aim is to make it possible
to have a responsive UI. The exception is currently the <code>/compose</code> call, which is long-running and
our SLO targets reflect a higher latency threshold. The UI must be implemented with this 
in mind.</p>
<h3 id="stability"><a class="header" href="#stability">Stability</a></h3>
<p>The proportion of successful (or unsuccessful due to user error) <code>/compose</code> requests. The aim is for users
to be able to reliably queue image builds, even if some retries are required.</p>
<h2 id="state"><a class="header" href="#state">State</a></h2>
<p>The service depends on a PostgreSQL database, the default postgres12-rds-1 template is used. The
database stores metadata about each build, making it possible to enumerate past builds and to enforce
quota limits. If the state is lost historical data would be lost, but the user could still use their
images if they have saved the necessary information. The quote calculations would be off, but in the
worst case scenario customers would be able to build more images than they are meant to, which would
not be a big problem.</p>
<h2 id="load-testing"><a class="header" href="#load-testing">Load Testing</a></h2>
<p>Image Builder is currently being load tested on a weekly basis with failure thresholds reflecting the
SLIs. The load tests happen against stage CRC. An example can be found
<a href="https://gitlab.com/osbuild/ci/image-builder/-/jobs/1541382293">here</a>.</p>
<p>More information can be found <a href="https://github.com/osbuild/image-builder/blob/main/test/README.md">upstream</a>.</p>
<h2 id="capacity"><a class="header" href="#capacity">Capacity</a></h2>
<p>The needed capacity might grow a little bit in all directions (DB and number of pods), but any growth should
be slow. Currently  pods are running, and limits have been set on memory or cpu usage. The default insights
limits and quotas are used, which should be more than enough.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="image-builder-composer-api-architecture-document"><a class="header" href="#image-builder-composer-api-architecture-document">Image Builder Composer API Architecture Document</a></h1>
<h2 id="service-description-1"><a class="header" href="#service-description-1">Service Description</a></h2>
<p>The <code>image-builder-composer</code> API routed via <a href="https://api.openshift.com/">api.openshift.com</a> serves as a
job queue for pending image builds as well as a metadata-store for already built images. When an image
build is queued via the API it is turned into a set of jobs that are put on the job queue, and together
do the necessary tasks to determine how the image should be built, build the image, upload the image to
its destination, and possibly register or import it to its final format.</p>
<p>The <code>image-builder-worker</code> API routed via <a href="https://api.openshift.com/">api.openshift.com</a> serves as the
other side of the job queue, where jobs can be dequeued to be executed and their results posted.</p>
<p>The actual jobs are executed by <code>workers</code>, which is outside the scope of this document.</p>
<h2 id="multitenancy"><a class="header" href="#multitenancy">Multitenancy</a></h2>
<p><code>osbuild-composer</code> deployments in both <a href="https://api.openshift.com/">api.openshift.com</a> and <a href="https://api.stage.openshift.com/">api.stage.openshift.com</a> have support for running builds for multiple tenants. Jobs created by a tenant can be picked only by workers belonging to the same tenant.</p>
<p>The tenant of an API request is currently determined from the JWT token that the API caller used. Specifically, the implementation extracts the tenant ID from <code>rh-org-id</code> or <code>account_id</code> fields. This is defined in <a href="https://github.com/osbuild/osbuild-composer/blob/de72b36dddfc703d76d79479dde7b92f0a78e924/templates/composer.yml#L261">the deployment template</a>.</p>
<p>Internally in <code>osbuild-composer</code>, the tenant ID is prefixed with <code>org-</code> and saved to the jobqueue as a <code>channel</code>, see <a href="https://github.com/osbuild/osbuild-composer/blob/de72b36dddfc703d76d79479dde7b92f0a78e924/pkg/jobqueue/jobqueue.go#L35">composer's source code</a>.</p>
<h2 id="technology-stack-1"><a class="header" href="#technology-stack-1">Technology Stack</a></h2>
<p>The service is written in Golang, and the list of dependencies can be found in
<a href="https://github.com/osbuild/osbuild-composer/blob/main/go.mod">go.mod</a>.</p>
<p>The <code>ubi8/go-toolset:latest</code> container is used as a builder, and <code>ubi8/ubi-minimal:latest</code> to run the
binary. The container images are located here: https://quay.io/repository/app-sre/composer.</p>
<h2 id="components-1"><a class="header" href="#components-1">Components</a></h2>
<p>The service consists of the composer and the composer-worker apps running in an AppSRE managed cluster,
and their backing database.</p>
<p>If either composer or the database are unavailable, the service does not work at all, new images
cannot be built, and historical builds cannot be introspected. Already built images that may be in
used by customers are unaffected, only their history and metadata can no longer be queried through
the service.</p>
<p>If composer-workers is unavailable, new jobs can be queued and old ones can be queried, but workers
will not be able to pick up new jobs until the API is back, and they will not be able to report back
results correctly for jobs they finish while the API is down.</p>
<h2 id="routes-1"><a class="header" href="#routes-1">Routes</a></h2>
<p>The public routes are <code>/api/image-builder-composer/v2/</code> and <code>/api/image-builder/worker/v1/</code>, detailed
lists can be found at https://api.openshift.com/api/image-builder-composer/v2/openapi and
https://api.openshift.com/api/image-builder-worker/v1/openapi.</p>
<h2 id="dependencies-1"><a class="header" href="#dependencies-1">Dependencies</a></h2>
<p>Composer has the following internal and external dependencies.</p>
<h3 id="internal-1"><a class="header" href="#internal-1">Internal</a></h3>
<p>Composer relies on Red Hat SSO for authentication.</p>
<h3 id="external-1"><a class="header" href="#external-1">External</a></h3>
<ul>
<li>AWS RDS for data storage. See the section on state.</li>
<li>Quay as a container registry. Without this, the service cannot be redeployed.</li>
<li>Github as an upstream repository. Without this, the service cannot be redeployed.</li>
<li>Gitlab, AWS EC2, and Openstack for upstream testing. Without this changes to the service cannot land.</li>
</ul>
<h2 id="service-diagram-1"><a class="header" href="#service-diagram-1">Service Diagram</a></h2>
<p>See parent page.</p>
<h2 id="application-success-criteria-1"><a class="header" href="#application-success-criteria-1">Application Success Criteria</a></h2>
<ol>
<li>Image builds can be queued successfully</li>
<li>Jobs can be dequeued successfully and correctly</li>
<li>Jobs are tracked correctly</li>
<li>The state of historical or in-flight builds can be queried and introspected successfully</li>
</ol>
<h2 id="state-1"><a class="header" href="#state-1">State</a></h2>
<p>The service depends on a PostgreSQL database, the default postgres12-rds-1 template is used. The
database stores metadata about each build, making it possible to enumerate past builds as well as
function as a job queue.</p>
<p>If the state is lost historical data would be lost, and pending image builds might never get scheduled,
but the user could still use their existing images if they have saved the necessary information. Data
loss would not affect the ability to schedule new builds.</p>
<h2 id="load-testing-1"><a class="header" href="#load-testing-1">Load Testing</a></h2>
<p>The Image Builder API in console.redhat.com is currently being load tested on a weekly basis with failure
thresholds reflecting the SLIs. The load tests happen against stage CRC, which is backed by composer in
api.stage.openshift.com. An example can be found <a href="https://gitlab.com/osbuild/ci/image-builder/-/jobs/1723976612">here</a>.</p>
<p>More information can be found <a href="https://github.com/osbuild/image-builder/blob/main/test/README.md">upstream</a>.</p>
<h2 id="capacity-1"><a class="header" href="#capacity-1">Capacity</a></h2>
<p>The defaults described in App Interface, 1 cpu 512Mi memory per container running in the default three pods are sufficient, and our expectations
are that this will remain sufficient for the next twelve months.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="image-builder-workers-architecture-document"><a class="header" href="#image-builder-workers-architecture-document">Image Builder Workers Architecture Document</a></h1>
<h2 id="service-description-2"><a class="header" href="#service-description-2">Service Description</a></h2>
<p>The <code>workers</code> are a fleet of (for now) amazon EC2 instances, responsible for requesting pending jobs
from the composer-worker API in AOC, perform jobs as instructed and report back the results. The
kinds of jobs are:</p>
<ul>
<li>determining build instructions for future image builds</li>
<li>building images</li>
<li>uploading images to their destination</li>
<li>registering images in their target platform</li>
</ul>
<p>Workers are stateless, apart from their caches, and hence trivially restartable. To build images
workers need to be running in a VM with kernel access, rather than in a container, and in order
to upload the results the workers need the right credentials for each of the possible targets. In
order to request new jobs, the workers need to be issued with RH credentials.</p>
<h2 id="technology-stack-2"><a class="header" href="#technology-stack-2">Technology Stack</a></h2>
<p>The service is written in Golang, and the list of vendored dependencies can be found in
<a href="https://github.com/osbuild/osbuild-composer/blob/main/go.mod">go.mod</a>. The underlying tool is written
in python3.</p>
<p>Both the service and underlying tool are built as RPMs and installed into AMIs. Their dependencies are
specified in their respective .spec files:</p>
<ul>
<li>https://github.com/osbuild/osbuild/blob/main/osbuild.spec</li>
<li>https://github.com/osbuild/osbuild-composer/blob/main/osbuild-composer.spec</li>
</ul>
<h2 id="components-2"><a class="header" href="#components-2">Components</a></h2>
<p>The service consists of a fleet of workers. If no workers are available, no jobs will be built until
workers are again available. Nothing is lost as jobs will stay in the queue, but everything will
simply stall.</p>
<h2 id="routes-2"><a class="header" href="#routes-2">Routes</a></h2>
<p>The workers expose no routes.</p>
<h2 id="dependencies-2"><a class="header" href="#dependencies-2">Dependencies</a></h2>
<p>The workers have the following internal and external dependencies.</p>
<h3 id="internal-2"><a class="header" href="#internal-2">Internal</a></h3>
<ul>
<li>Red Hat SSO for authentication. Without this, the worker cannot request new jobs.</li>
</ul>
<h3 id="external-2"><a class="header" href="#external-2">External</a></h3>
<ul>
<li>EC2. Without this the workers cannot run.</li>
<li>EC2, GCP and Azure to upload the respective images. Without this image upload will fail.</li>
<li>S3 to upload images for download by the user. Without this image upload will fail.</li>
<li>Packer as a build tool. Without this, the service cannot be redeployed.</li>
<li>TerraForm as a deployment orchestrator. Without this, the service cannot be redeployed.</li>
<li>Github as an upstream repository. Without this, the service cannot be redeployed.</li>
<li>Gitlab, AWS EC2, and Openstack for upstream testing. Without this changes to the service cannot land.</li>
</ul>
<h2 id="service-diagram-2"><a class="header" href="#service-diagram-2">Service Diagram</a></h2>
<p>See parent page.</p>
<h2 id="application-success-criteria-2"><a class="header" href="#application-success-criteria-2">Application Success Criteria</a></h2>
<p>The worker fleet is successful if:</p>
<ol>
<li>It scales on demand to avoid pending jobs having overly long queue times.</li>
<li>The jobs are executed in a timely fashion.</li>
<li>The job error rate (including image builds and uploads) is low.</li>
</ol>
<h2 id="state-2"><a class="header" href="#state-2">State</a></h2>
<p>Workers only have ephemeral state.</p>
<p>To optimize build-times, workers will keep a cache of previously (partially) built or downloaded
artifacts if this is lost it will be recreated on demand with no other loss than extra running time.</p>
<h2 id="load-testing-2"><a class="header" href="#load-testing-2">Load Testing</a></h2>
<p>Image Builder is currently being load tested on a weekly basis with failure thresholds reflecting the
SLIs. The load tests happen against stage CRC. An example can be found
<a href="https://gitlab.com/osbuild/ci/image-builder/-/jobs/1541382293">here</a>.</p>
<p>The load testing happens against stage, and tests the entire stack, including the workers.</p>
<h2 id="capacity-2"><a class="header" href="#capacity-2">Capacity</a></h2>
<p>Increasing the rate at which workers can handle jobs is easily done by scaling up the ASG.</p>
<p>The workers are also limited by a 2 week image retention period in our cloud accounts. For GCP
images this means there's can have a maximum of 1000 images stored at any given time. For AWS it's
limited by the snapshots per region limit (100k). And it's limited by the amount of images that can
concurrently be imported (20). The latter might pose a problem in future.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="image-builder-koji-integration"><a class="header" href="#image-builder-koji-integration">Image Builder Koji integration</a></h1>
<p>This document describes how various instances of the <a href="https://koji.build/">Koji</a> build system can and do integrate with the Image Builder service.</p>
<h2 id="architecture"><a class="header" href="#architecture">Architecture</a></h2>
<p><code>osbuild-composer</code> can integrate with a <code>Koji</code> instance as an external Content Generator using the <a href="https://github.com/osbuild/koji-osbuild">koji-osbuild</a> plugin. The overview of the integration is described in the <a href="https://github.com/osbuild/koji-osbuild/blob/main/README.md">koji-osbuild project README</a>.</p>
<p>In short, a <code>Koji</code> instance integrates directly with <code>osbuild-composer</code> API, usually as a separate tenant with a dedicated set of workers.</p>
<h2 id="technology-stack-3"><a class="header" href="#technology-stack-3">Technology Stack</a></h2>
<p>The <a href="https://github.com/osbuild/koji-osbuild">koji-osbuild</a> plugin is implemented in Python, and the list of dependencies can be found in the <a href="https://github.com/osbuild/koji-osbuild/blob/main/koji-osbuild.spec">SPEC file</a>.</p>
<h2 id="building-images-via-koji-integration"><a class="header" href="#building-images-via-koji-integration">Building images via Koji integration</a></h2>
<p>The <code>koji-osbuild</code> plugin allows one to submit image builds via the Koji Hub API using the <code>osbuildImage</code> task. The accepted arguments schema of the <code>osbuildImage</code> task is described <a href="https://github.com/osbuild/koji-osbuild/blob/cc3e621754d99b3f2a4fcb85bb207bf76a0970ea/plugins/hub/osbuild.py#L12-L225">in the plugin implementation</a>. The <code>koji-osbuild</code> plugin processes the request and submits a new compose request using the <code>osbuild-composer</code> Cloud API. The plugin always sets the <a href="https://github.com/osbuild/osbuild-composer/blob/434362e81ed996e6353360c3311090ae1cbe73a6/internal/cloudapi/v2/openapi.v2.yml#L736-L737"><code>koji</code> property</a> in the compose request, signaling to <code>osbuild-composer</code> that the request is coming from a <code>Koji</code> plugin.</p>
<p>Images built as part of a compose requests submitted via the <code>Koji</code> plugin are always implicitly uploaded to the respective <code>Koji</code> instance. Since <strong>version 10</strong> of the <code>koji-osbuild</code> plugin, images can be uploaded directly to the appropriate cloud environment, in addition to being uploaded to <code>Koji</code>. More details are below in the <a href="image-builder-service/image-builder-koji.html#cloud-upload">Cloud upload</a> section.</p>
<p>The <code>koji-osbuild</code> plugin also supports specifying all image customizations supported by the <code>osbuild-composer</code> Cloud API.</p>
<p>There are currently two easy ways how to trigger the <code>osbuildImage</code> tasks in Koji:</p>
<ul>
<li><code>koji-cli</code> - the command line client for interacting with <code>Koji</code>. The prerequisite is to install the <code>koji-osbuild-cli</code> plugin. For more information, run <code>koji osbuild-image --help</code>.</li>
<li><a href="https://pagure.io/pungi">Pungi</a> - a distribution compose tool. <code>Pungi</code> interacts directly with the <code>Koji</code> Hub API and is able to submit <code>osbuildImage</code> tasks as part of a distribution compose. The details of how to configure <code>Pungi</code> to trigger image builds are described in the <a href="https://docs.pagure.org/pungi/configuration.html#osbuild-composer-for-building-images">project documentation</a>.</li>
</ul>
<h3 id="cloud-upload"><a class="header" href="#cloud-upload">Cloud upload</a></h3>
<h4 id="prerequisites"><a class="header" href="#prerequisites">Prerequisites</a></h4>
<ul>
<li><code>koji-osbuild</code> version &gt;= 10</li>
<li><code>osbuild-composer</code> version &gt;= 58</li>
</ul>
<h4 id="details"><a class="header" href="#details">Details</a></h4>
<p>Images built via the <code>Koji</code> integration can be automatically uploaded to the appropriate cloud environment, in addition to the <code>Koji</code> instance. In order for this to happen, one must provide <em>upload_options</em> when using the <code>osbuildImage</code> task and the integrated <code>osbuild-composer</code> instance must be configured appropriately to be able to upload to the respective cloud environments.</p>
<p>Currently supported <em>upload_options</em> are:</p>
<ul>
<li>AWS EC2</li>
<li>AWS S3</li>
<li>Azure (as an image)</li>
<li>GCP</li>
<li>Container registry</li>
</ul>
<p>Please note, that each image type can be uploaded only to its respective cloud target, represented by <em>upload_options</em> (e.g. the <code>ami</code> image can be uploaded only to <code>AWS EC2</code>, <code>gce</code> image can be uploaded only to <code>GCP</code>, etc.).</p>
<p>The allowed <em>upload_options</em> schema is defined in the <a href="https://github.com/osbuild/koji-osbuild/blob/cc3e621754d99b3f2a4fcb85bb207bf76a0970ea/plugins/hub/osbuild.py#L110-L118"><code>koji-osbuild</code> Hub plugin</a> and currently matches the <a href="https://github.com/osbuild/osbuild-composer/blob/434362e81ed996e6353360c3311090ae1cbe73a6/internal/cloudapi/v2/openapi.v2.yml#L809-L815"><code>osbuild-composer</code> Cloud API <code>UploadOptions</code></a>.</p>
<p>If the compose request contains multiple image requests (meaning that multiple images will be built), the provided <em>upload_options</em> will be used as is for all images (with all its consequences).</p>
<p>All the necessary data to locate the image in the cloud is attached by the <code>koji-osbuild</code> plugin to the image build task in <code>Koji</code> as <code>compose-status.json</code> file. Below is an example of such file:</p>
<pre><code class="language-json">{
    &quot;image_statuses&quot;: [
        {
            &quot;status&quot;: &quot;success&quot;,
            &quot;upload_status&quot;: {
                &quot;options&quot;: {
                    &quot;ami&quot;: &quot;ami-02e34403c421dfc17&quot;,
                    &quot;region&quot;: &quot;us-east-1&quot;
                },
                &quot;status&quot;: &quot;success&quot;,
                &quot;type&quot;: &quot;aws&quot;
            }
        }
    ],
    &quot;koji_build_id&quot;: 1,
    &quot;koji_task_id&quot;: null,
    &quot;status&quot;: &quot;success&quot;
}
</code></pre>
<h4 id="cloud-upload-via-koji-cli"><a class="header" href="#cloud-upload-via-koji-cli">Cloud upload via <code>koji-cli</code></a></h4>
<p>In order to upload images to the cloud when using <code>koji-cli</code>, one must first create a JSON file with the appropriate <em>upload_options</em>.</p>
<p>Example <code>gcp_upload_options.json</code>:</p>
<pre><code class="language-json">{
    &quot;region&quot;: &quot;eu&quot;,
    &quot;bucket&quot;: &quot;my-bucket&quot;,
    &quot;share_with_accounts&quot;: [&quot;alice@example.org&quot;]
}
</code></pre>
<p>Then add the <code>--upload-options=gcp_upload_options.json</code> argument to the command line when calling <code>koji</code> CLI.</p>
<h4 id="cloud-upload-via-pungi"><a class="header" href="#cloud-upload-via-pungi">Cloud upload via <code>Pungi</code></a></h4>
<p>In order to upload images to the cloud, when using <code>Pungi</code> to trigger image builds, one must specify the <code>upload_options</code> option in the configuration dictionary as described in the <a href="https://docs.pagure.org/pungi/configuration.html#osbuild-composer-for-building-images">project documentation</a>.</p>
<p>Please note that the support for cloud upload has been merged to the <code>Pungi</code> project after the <strong>4.3.6</strong> release. Therefore, if you want to take advantage of this feature, make sure to use version higher than <strong>4.3.6</strong>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="image-builder-on-premises-1"><a class="header" href="#image-builder-on-premises-1">Image Builder on premises</a></h1>
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<p><svg
   id="artwork"
   viewBox="0 0 605 210"
   version="1.1"
   sodipodi:docname="onpremises.svg"
   inkscape:version="1.2.2 (b0a8486541, 2022-12-01)"
   width="605"
   height="210"
   xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape"
   xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd"
   xmlns="http://www.w3.org/2000/svg"
   xmlns:svg="http://www.w3.org/2000/svg">
&lt;sodipodi:namedview
id=&quot;namedview177&quot;
pagecolor=&quot;#ffffff&quot;
bordercolor=&quot;#666666&quot;
borderopacity=&quot;1.0&quot;
inkscape:showpageshadow=&quot;2&quot;
inkscape:pageopacity=&quot;0.0&quot;
inkscape:pagecheckerboard=&quot;0&quot;
inkscape:deskcolor=&quot;#d1d1d1&quot;
showgrid=&quot;false&quot;
inkscape:zoom=&quot;1.7118421&quot;
inkscape:cx=&quot;353.42045&quot;
inkscape:cy=&quot;155.97233&quot;
inkscape:window-width=&quot;1920&quot;
inkscape:window-height=&quot;1011&quot;
inkscape:window-x=&quot;0&quot;
inkscape:window-y=&quot;0&quot;
inkscape:window-maximized=&quot;1&quot;
inkscape:current-layer=&quot;artwork&quot; /&gt;
<defs
     id="defs4">
<style
       id="style2">
.cls-1, .cls-2, .cls-3 {
fill: none;
}
.cls-2 {
stroke: #06c;
}
.cls-2, .cls-4 {
stroke-linecap: round;
stroke-linejoin: round;
}
.cls-5 {
fill: #06c;
}
.cls-6, .cls-4 {
fill: #fff;
}
.cls-7 {
fill: #e8e8e8;
}
.cls-8, .cls-9 {
font-family: RedHatTextRoman-Medium, 'Red Hat Text';
font-variation-settings: 'wght' 500;
font-weight: 500;
}
.cls-8, .cls-10, .cls-11 {
fill: #151515;
font-size: 12px;
}
.cls-12 {
fill: #ececec;
font-size: 10px;
}
.cls-12, .cls-13 {
font-family: RedHatTextRoman-Regular, 'Red Hat Text';
font-variation-settings: 'wght' 400;
}
.cls-3 {
stroke: #adadad;
stroke-miterlimit: 10;
}
.cls-4 {
stroke: #5b5b5b;
stroke-width: 1.5px;
}
.cls-11 {
font-family: RedHatTextRoman-Bold, 'Red Hat Text';
font-variation-settings: 'wght' 700;
font-weight: 700;
}
</style>
</defs>
<rect
     class="cls-7"
     x="-185"
     y="-200"
     width="175"
     height="190"
     transform="scale(-1)"
     id="rect452"
     style="stroke-width:1.28817" />
<g
     id="g450"
     transform="matrix(0.96666667,0,0,1,10.5,56.75)">
<g
       id="g138">
<rect
         class="cls-6"
         x="15.5"
         y="60"
         width="149"
         height="49"
         id="rect134" />
<path
         class="cls-5"
         d="m 164,60.5 v 48 H 16 v -48 h 148 m 1,-1 H 15 v 50 h 150 z"
         id="path136" />
</g>
<text
       class="cls-8"
       id="text144"
       x="53.315987"
       y="87.697998">composer-cli</text>
</g>
<rect
     class="cls-7"
     x="-595"
     y="-162.25"
     width="185"
     height="114.5"
     transform="scale(-1)"
     id="rect14" />
<rect
     class="cls-7"
     x="-385"
     y="-162.25"
     width="175"
     height="114.5"
     transform="scale(-1)"
     id="rect22" />
<g
     id="g419"
     transform="translate(-165,20.5)">
<g
       id="g32">
<rect
         class="cls-6"
         x="390.5"
         y="60"
         width="144"
         height="49"
         id="rect28" />
<path
         class="cls-5"
         d="m 534,60.5 v 48 H 391 v -48 h 143 m 1,-1 H 390 v 50 h 145 z"
         id="path30" />
</g>
<text
       class="cls-8"
       id="text38"
       x="396.94199"
       y="74.697998"><tspan
         x="411.39197"
         y="87.697998"
         id="tspan36">osbuild-composer</tspan></text>
</g>
<g
     id="g128"
     transform="translate(-165,20.5)">
<line
       class="cls-2"
       x1="590"
       y1="84.5"
       x2="544.67999"
       y2="84.5"
       id="line124" />
<polygon
       class="cls-5"
       points="546.14,79.51 537.5,84.5 546.14,89.49 "
       id="polygon126" />
</g>
<polyline
     class="cls-3"
     points="595 114.5 740 114.5 740 64.5"
     id="polyline148"
     transform="translate(-165,20.5)" />
<polyline
     class="cls-3"
     points="600 119.5 745 119.5 745 69.5"
     id="polyline150"
     transform="translate(-165,20.5)" />
<g
     id="g156"
     transform="translate(-165,20.5)">
<rect
       class="cls-6"
       x="590.5"
       y="60"
       width="144"
       height="49"
       id="rect152" />
<path
       class="cls-5"
       d="m 734,60.5 v 48 H 591 v -48 h 143 m 1,-1 H 590 v 50 h 145 z"
       id="path154" />
</g>
<text
     class="cls-8"
     id="text160"
     x="473.54202"
     y="108.5"><tspan
       x="473.54202"
       y="108.5"
       id="tspan158">worker/s</tspan></text>
<g
     id="g166"
     transform="translate(-165,-17.25)">
<rect
       class="cls-6"
       x="190.5"
       y="60"
       width="144"
       height="49"
       id="rect162" />
<path
       class="cls-5"
       d="m 334,60.5 v 48 H 191 v -48 h 143 m 1,-1 H 190 v 50 h 145 z"
       id="path164" />
</g>
<text
     class="cls-8"
     id="text172"
     x="46.043976"
     y="70.447998">cockpit-composer</text>
<g
     id="g1474"
     transform="translate(0,-17.25)">
<polygon
       class="cls-5"
       points="378.86,79.51 387.5,84.5 378.86,89.49 "
       id="polygon706"
       transform="rotate(-31.536727,378.99421,397.49701)"
       style="fill:#0066cc" />
<path
       style="fill:none;stroke:#0066cc;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
       d="m 169.85711,158.77108 45.70814,-28.22652"
       id="path793" />
</g>
<g
     id="g1480"
     transform="matrix(1,0,0,-1,0,226.22566)">
<polygon
       class="cls-5"
       points="387.5,84.5 378.86,89.49 378.86,79.51 "
       id="polygon1476"
       transform="rotate(-31.536727,378.99421,397.49701)"
       style="fill:#0066cc" />
<path
       style="fill:none;stroke:#0066cc;stroke-width:1px;stroke-linecap:butt;stroke-linejoin:miter;stroke-opacity:1"
       d="m 169.85711,158.77108 45.70814,-28.22652"
       id="path1478" />
</g>
</svg></p>
<p><code>osbuild-composer</code> is a service for building customized operating system images (currently only Fedora and RHEL). These images can be used with various virtualization software such as <a href="https://www.qemu.org/">QEMU</a>, <a href="https://www.virtualbox.org/">VirtualBox</a>, <a href="https://www.vmware.com/">VMWare</a> and also with cloud computing providers like <a href="https://aws.amazon.com/">AWS</a>, <a href="https://azure.microsoft.com/">Azure</a> or <a href="https://cloud.google.com/">GCP</a>.</p>
<p>There are two frontends that you can use to communicate with osbuild-composer:</p>
<ul>
<li>
<p><strong>Cockpit Composer</strong>: The web-based management console Cockpit comes bundled with a UI extension to build operating system artifacts. See the documentation of Cockpit Composer for information, or consult the Cockpit Guide for help on general Cockpit questions.</p>
</li>
<li>
<p><strong>Command-line Interface</strong>: With composer-cli there exists a linux command-line interface (CLI) to some of the functionality provided by OSBuild. The CLI is part of the Weldr project, a precursor of OSBuild.</p>
</li>
</ul>
<p>This guide contains instructions on installing <code>osbuild-composer</code> service and its basic usage.</p>
<p>If you want to fix a typo, or even contribute new content, the sources for this webpage are hosted in <a href="https://github.com/osbuild/guides/">osbuild/guides GitHub repository</a>.</p>
<p>For Red Hatters, the internal guides can be found <a href="https://osbuild.pages.redhat.com/internal-guides/">here</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><div class="table-wrapper"><table><thead><tr><th></th><th>cockpit-composer</th><th>osbuild</th><th>osbuild-composer</th></tr></thead><tbody>
<tr><td><em>8.10</em></td><td>47-1</td><td>95-1</td><td>88-1</td></tr>
<tr><td><em>8.9</em></td><td>47-1</td><td>93-1</td><td>88-1</td></tr>
<tr><td><em>9.3</em></td><td>47-1</td><td>93-1</td><td>88-1</td></tr>
<tr><td><em>9.4</em></td><td>47-1</td><td>95-1</td><td>88-1</td></tr>
<tr><td><em>CentOS Stream 8</em></td><td>47-1</td><td>95-1</td><td>88-1</td></tr>
<tr><td><em>CentOS Stream 9</em></td><td>47-1</td><td>94-1</td><td>88-1</td></tr>
<tr><td><em>Fedora 37</em></td><td>47-1</td><td>94-1</td><td>89-1</td></tr>
<tr><td><em>Fedora 38</em></td><td>47-1</td><td>94-1</td><td>89-1</td></tr>
<tr><td><em>Fedora 39</em></td><td>47-1</td><td>95-1</td><td>89-1</td></tr>
<tr><td><em>Git</em></td><td>47</td><td>95</td><td>88.1</td></tr>
<tr><td><em>Service</em></td><td>n/a</td><td>n/a</td><td><a href="https://github.com/osbuild/osbuild-composer/compare/v88-7-ge5c4640...main">v88-7-ge5c4640</a></td></tr>
<tr><td><em>Workers</em></td><td>n/a</td><td><a href="https://github.com/osbuild/osbuild/compare/v93...main">v93</a></td><td><a href="https://github.com/osbuild/osbuild-composer/compare/v88-7-ge5c4640...main">v88-7-ge5c4640</a></td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="basic-concepts"><a class="header" href="#basic-concepts">Basic concepts</a></h1>
<p><code>osbuild-composer</code> works with a concept of <strong>blueprints</strong>. A blueprint is a description of the final <strong>image</strong> and its <strong>customizations</strong>. A <strong>customization</strong> can be:</p>
<ul>
<li>an additional RPM package</li>
<li>enabled service</li>
<li>custom kernel command line parameter, and many others. See <a href="https://www.osbuild.org/guides/blueprint-reference/blueprint-reference.html#blueprint-reference">Blueprint</a> reference for more details. </li>
</ul>
<p>An <strong>image</strong> is defined by its blueprint and <strong>image type</strong>, which is for example <code>qcow2</code> (QEMU Copy On Write disk image) or <code>AMI</code> (Amazon Machine Image).</p>
<p>Finally, <code>osbuild-composer</code> also supports <strong>upload targets</strong>, which are cloud providers where an image can be stored after it is built. See the <a href="image-builder-on-premises/./uploading-to-cloud.html">Uploading cloud images</a> section for more details.</p>
<h2 id="example-blueprint"><a class="header" href="#example-blueprint">Example blueprint</a></h2>
<pre><code class="language-toml">name = &quot;base-image-with-tmux&quot;
description = &quot;A base system with tmux&quot;
version = &quot;0.0.1&quot;

[[packages]]
name = &quot;tmux&quot;
version = &quot;*&quot;
</code></pre>
<p>The blueprint is in <a href="https://toml.io/en/">TOML format</a>.</p>
<h2 id="image-types"><a class="header" href="#image-types">Image types</a></h2>
<p><code>osbuild-composer</code> supports various types of output images. To see all supported types, run this command:</p>
<pre><code>$ composer-cli compose types
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="installation"><a class="header" href="#installation">Installation</a></h1>
<p>To get started with <code>osbuild-composer</code> on your local machine, you can install the CLI interface or the Web UI, which is part of Cockpit project. </p>
<h2 id="cli-interface"><a class="header" href="#cli-interface">CLI interface</a></h2>
<p>For CLI only, run the following command to install necessary packages:</p>
<pre><code>$ sudo dnf install osbuild-composer composer-cli
</code></pre>
<p>To enable the service, run this command:</p>
<pre><code>$ sudo systemctl enable --now osbuild-composer.socket
</code></pre>
<p>Verify that the installation works by running <code>composer-cli</code>:</p>
<pre><code>$ sudo composer-cli status show
</code></pre>
<p>If you prefer to run this command without sudo privileges, add your user to the <code>weldr</code> group:</p>
<pre><code>$ sudo usermod -a -G weldr &lt;user&gt;
$ newgrp weldr
</code></pre>
<h2 id="web-ui"><a class="header" href="#web-ui">Web UI</a></h2>
<p>If you prefer the Web UI interface, known as an Image Builder, install the following package:</p>
<pre><code>$ sudo dnf install cockpit-composer
</code></pre>
<p>and enable <code>cockpit</code> and <code>osbuild-composer</code> services:</p>
<pre><code>$ sudo systemctl enable --now osbuild-composer.socket
$ sudo systemctl enable --now cockpit.socket
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="managing-repositories"><a class="header" href="#managing-repositories">Managing repositories</a></h1>
<p>There are two kinds of repositories used in osbuild-composer:</p>
<ol>
<li><strong>Custom 3rd party repositories</strong> - use these to include packages that are not available in the official Fedora or RHEL repositories.</li>
<li><strong>Official repository overrides</strong> - use these if you want to download base system RPMs from elsewhere than the official repositories. For example if you have a custom mirror in your network. Keep in mind that this will <strong>disable the default repositories</strong>, so the mirror must contain all necessary packages!</li>
</ol>
<h2 id="custom-3rd-party-repositories"><a class="header" href="#custom-3rd-party-repositories">Custom 3rd party repositories</a></h2>
<p>These are managed using <code>composer-cli</code> (see the manpage for complete reference). To add a new repository, create a <code>TOML</code> file like this:</p>
<pre><code class="language-toml">id = &quot;k8s&quot;
name = &quot;Kubernetes&quot;
type = &quot;yum-baseurl&quot;
url = &quot;https://packages.cloud.google.com/yum/repos/kubernetes-el7-x86_64&quot;
check_gpg = false
check_ssl = false
</code></pre>
<p>and add it using <code>composer-cli sources add &lt;file-name.toml&gt;</code>. Verify its presence using <code>composer-cli sources list</code> and its content using <code>composer-cli sources info &lt;id&gt;</code>.</p>
<h3 id="using-sources-with-specific-distributions"><a class="header" href="#using-sources-with-specific-distributions">Using sources with specific distributions</a></h3>
<p>A new optional field has been added to the repository source format. It is a
list of distribution strings that the source will be used with when depsolving
and building images.</p>
<p>Sources with no <code>distros</code> will be used with all composes. If you want to use a
source for a specific distro you set the <code>distros</code> list to the distro name(s)
to use it with.</p>
<p>eg. A source that is only used when depsolving or building fedora 32:</p>
<pre><code class="language-toml">check_gpg = true
check_ssl = true
distros = [&quot;fedora-32&quot;]
id = &quot;f32-local&quot;
name = &quot;local packages for fedora32&quot;
type = &quot;yum-baseurl&quot;
url = &quot;http://local/repos/fedora32/projectrepo/&quot;
</code></pre>
<p>This source will be used for any requests that specify fedora-32, eg. listing
packages and specifying fedora-32 will include this source, but listing
packages for the host distro will not.</p>
<h3 id="verifying-repository-metadata-with-gpg"><a class="header" href="#verifying-repository-metadata-with-gpg">Verifying Repository Metadata with GPG</a></h3>
<p>In addition to checking the GPG signature on rpm packages, DNF can check that
repository metadata has been signed with a GPG key. You can setup such a
repository yourself by signing your <code>repomd.xml</code> file after you have run
<code>createrepo_c</code> on your repository. For example:</p>
<pre><code class="language-bash">cd repo/
createrepo_c .
cd repodata/
gpg -u YOUR-GPG-KEY-EMAIL --yes --detach-sign --armor repomd.xml
</code></pre>
<p>In order to check this signature you need to tell osbuild-composer what gpg key
to use to do the check.  Set <code>check_repogpg = true</code> in the source, and if the
key is available over https, set the <code>gpgkeys</code> entry to the URL for the key,
like this:</p>
<pre><code class="language-toml">check_gpg = true
check_ssl = true
id = &quot;custom-local&quot;
name = &quot;signed local packages&quot;
type = &quot;yum-baseurl&quot;
url = &quot;https://local/repos/projectrepo/&quot;
check_repogpg = true
gpgkeys=[&quot;https://local/keys/repokey.pub&quot;]
</code></pre>
<p>Normally you would want to distribute the key via a separate channel from the
rpms for better security, the above is just an example. You can also embed the
whole key into the source <code>gpgkeys</code> entry. If the entry starts with <code>-----BEGIN PGP PUBLIC KEY BLOCK-----</code> it will import it directly instead of fetching it
from the url. For example:</p>
<pre><code class="language-toml">check_gpg = true
check_ssl = true
check_repogpg
id = &quot;custom-local&quot;
name = &quot;signed local packages&quot;
type = &quot;yum-baseurl&quot;
url = &quot;https://local/repos/projectrepo/&quot;
gpgkeys=[&quot;https://remote/keys/other-repokey.pub&quot;,
'''-----BEGIN PGP PUBLIC KEY BLOCK-----
Version: GnuPG v1.4.10 (GNU/Linux)

mQENBEt+xXMBCACkA1ZtcO4H7ZUG/0aL4RlZIozsorXzFrrTAsJEHvdy+rHCH3xR
cFz6IMbfCOdV+oKxlDP7PS0vWKfqxwkenOUut5o9b32uDdFMW4IbFXEQ94AuSQpS
jo8PlVMm/51pmmRxdJzyPnr0YD38mVK6qUEYLI/4zXSgFk493GT8Y4m3N18O/+ye
PnOOItj7qbrCMASoBx1TG8Zdg8ufehMnfb85x4xxAebXkqJQpEVTjt4lj4p6BhrW
R+pIW/nBUrz3OsV7WwPKjSLjJtTJFxYX+RFSCqOdfusuysoOxpIHOx1WxjGUOB5j
fnhmq41nWXf8ozb58zSpjDrJ7jGQ9pdUpAtRABEBAAG0HkJyaWFuIEMuIExhbmUg
PGJjbEByZWRoYXQuY29tPokBOAQTAQIAIgUCS37FcwIbAwYLCQgHAwIGFQgCCQoL
BBYCAwECHgECF4AACgkQEX6MFo7+On9dgAf9Hi2K1MKcmLkDeSUIXkXIAw0nAzl2
UDGLWEdDqAgFxP6UaCVtOIRCr7z4EDOQoxD7mkdekbH2W5GcTO4h8MQBHYD9EkY7
H/lTKchlFfsmafOoA3Y/tDLPKu+OIfH9Mqn2Mf7wMYGrnWSRNKYgvC5zkMgkhoPU
mSPPHyBabsdS/Kg5ZAf43ac/MXY9V8Mk6zqbBlj6QYqjJ0nBD6vwozrDQ5gJtDUL
mQho13zPn4lBJl9YJVjcgRB2WbzgSZOln0DfV22Seai66vnr5NyaOIw5B9QLSNhN
EaPFswEDLKCsns9dkDuGFX52/Mt/i7JySvwhMBqHElPzWmwCHeY45M8gBYhGBBAR
AgAGBQJLfsbpAAoJECH7Y/6XEsLNuasAn0Q0jB4Ea/95EREUkCFTm9L6nOpAAJ9t
QzwGXhrLFZzOdRWYiWcCQbX5/7kBDQRLfsVzAQgAvN5jr95pJthv2w9co9/7omhM
5rAnr9WJfbMLLiUfPPUvpL24RGO6SKy03aiVTUjlaHc+cGqOciwnNKMCSt+noyG2
kNnAESTDtCivpsjonaFP8jA3TqL0QK+yzBRKJnMnLEY1nWE1FtkMRccXvzi0Z/XQ
VhiWQyTvDFoKtepBFrH9UqWbNHyki22aighumUsW01pcPH2ogSj+HR01r7SfI/y2
EkE6loHQfCDycHmlqYV+X6GZEvf1qu2+EHEQChsHIAxWyshsxM/ZPmx/8e5S3Xmj
l7h/6E9wcsIpvnf504sLX5j4Km9I5HgJSRxHxgRPpqJ2/XiClAJanO5gCw0RdQAR
AQABiQEfBBgBAgAJBQJLfsVzAhsMAAoJEBF+jBaO/jp/SqEH/iArzrfVOhZQGuy1
KmG0+/FdJGqAEHP5HWpsaeYJok1VmhTPZd4IVFBz/bGJYyvsrPU0pJ6QLkdGxNnb
KulJocgkW5MKEL/CRc54ESKwYngigmbY4qLwhS+gB3BJg1TvoHD810MSj4wdxNNo
6JQmFmuoDsLRwaRYbKQDz95XXoGQtmV1o57T05WkLuC5OmHqnWv3rggVC8madpUJ
moUUvUWgU1qyXe3PrgMGFOibWIl7lPZ08nzKXBRvSK/xoTGxl+570AevfVHMu5Uk
Yu2U6D6/DYohtTYp0s1ekS5KQkCJM7lfqecDsQhfVfOfR0w4aF8k8u3HmWdOfUz+
9+2ZsBo=
=myjM
-----END PGP PUBLIC KEY BLOCK-----''']
</code></pre>
<p>Notice that gpgkeys can take as many key urls and keys as you need, not just one.
If the signature cannot be found an error similar to this will be returned:</p>
<pre><code>GPG verification is enabled, but GPG signature is not available.
This may be an error or the repository does not support GPG verification:
Status code: 404 for http://repo-server/fedora/repodata/repomd.xml.asc (IP: 192.168.1.3)
</code></pre>
<p>And if the signature is invalid:</p>
<pre><code>repomd.xml GPG signature verification error: Bad GPG signature
</code></pre>
<p>You can test the signature of the repository manually by running <code>gpg --verify repomd.xml.asc</code>
to help troubleshoot problems.</p>
<h2 id="official-repository-overrides"><a class="header" href="#official-repository-overrides">Official repository overrides</a></h2>
<p><code>osbuild-composer</code> does not inherit the system repositories located in <code>/etc/yum.repos.d/</code>. Instead, it has its own set of official repositories defined in <code>/usr/share/osbuild-composer/repositories</code>. To override the official repositories, define overrides in <code>/etc/osbuild-composer/repositories</code>. This directory is meant for user defined overrides and the files located here take precedence over those in <code>/usr</code>.</p>
<p>The configuration files are not in the usual &quot;repo&quot; format. Instead, they are simple <code>JSON</code> files.</p>
<h3 id="defining-official-repository-overrides"><a class="header" href="#defining-official-repository-overrides">Defining official repository overrides</a></h3>
<p>To set your own repositories, create this directory if it does not exist already:</p>
<pre><code class="language-bash">$ sudo mkdir -p /etc/osbuild-composer/repositories
</code></pre>
<p>Based on the system you want to build an image for, determine the name of a new JSON file:</p>
<ul>
<li>Fedora 32 - <code>fedora-32.json</code></li>
<li>Fedora 33 - <code>fedora-33.json</code></li>
<li>RHEL 8.4 - <code>rhel-84.json</code></li>
<li>RHEL 9.0 - <code>rhel-90.json</code></li>
</ul>
<p>Then, create the JSON file with the following structure (or copy the file from <code>/usr/share/osbuild-composer/</code> and modify its content):</p>
<pre><code class="language-json">{
    &quot;&lt;ARCH&gt;&quot;: [
        {
            &quot;name&quot;: &quot;&lt;REPO NAME&gt;&quot;,
            &quot;metalink&quot;: &quot;&quot;,
            &quot;baseurl&quot;: &quot;&quot;,
            &quot;mirrorlist&quot;: &quot;&quot;,
            &quot;gpgkey&quot;: &quot;&quot;,
            &quot;check_gpg&quot;: &quot;&quot;,
            &quot;metadata_expire&quot;: &quot;&quot;,
        }
    ]
}
</code></pre>
<p>Specify only one of the following attributes: <code>metalink</code>, <code>mirrorlist</code>, or <code>baseurl</code>. All the remaining fields like <code>gpgkey</code>, <code>metadata_expire</code>, etc. are optional.</p>
<p>For example, for building a Fedora 33 image running on x86_64, create <code>/etc/osbuild-composer/repositories/fedora-33.json</code> with this content:</p>
<pre><code class="language-json">{
    &quot;x86_64&quot;: [
        {
            &quot;name&quot;: &quot;fedora&quot;,
            &quot;metalink&quot;: &quot;https://mirrors.fedoraproject.org/metalink?repo=fedora-33&amp;arch=x86_64&quot;,
            &quot;gpgkey&quot;: &quot;-----BEGIN PGP PUBLIC KEY BLOCK-----\n\nmQINBF4wBvsBEADQmcGbVUbDRUoXADReRmOOEMeydHghtKC9uRs9YNpGYZIB+bie\nbGYZmflQayfh/wEpO2W/IZfGpHPL42V7SbyvqMjwNls/fnXsCtf4LRofNK8Qd9fN\nkYargc9R7BEz/mwXKMiRQVx+DzkmqGWy2gq4iD0/mCyf5FdJCE40fOWoIGJXaOI1\nTz1vWqKwLS5T0dfmi9U4Tp/XsKOZGvN8oi5h0KmqFk7LEZr1MXarhi2Va86sgxsF\nQcZEKfu5tgD0r00vXzikoSjn3qA5JW5FW07F1pGP4bF5f9J3CZbQyOjTSWMmmfTm\n2d2BURWzaDiJN9twY2yjzkoOMuPdXXvovg7KxLcQerKT+FbKbq8DySJX2rnOA77k\nUG4c9BGf/L1uBkAT8dpHLk6Uf5BfmypxUkydSWT1xfTDnw1MqxO0MsLlAHOR3J7c\noW9kLcOLuCQn1hBEwfZv7VSWBkGXSmKfp0LLIxAFgRtv+Dh+rcMMRdJgKr1V3FU+\nrZ1+ZAfYiBpQJFPjv70vx+rGEgS801D3PJxBZUEy4Ic4ZYaKNhK9x9PRQuWcIBuW\n6eTe/6lKWZeyxCumLLdiS75mF2oTcBaWeoc3QxrPRV15eDKeYJMbhnUai/7lSrhs\nEWCkKR1RivgF4slYmtNE5ZPGZ/d61zjwn2xi4xNJVs8q9WRPMpHp0vCyMwARAQAB\ntDFGZWRvcmEgKDMzKSA8ZmVkb3JhLTMzLXByaW1hcnlAZmVkb3JhcHJvamVjdC5v\ncmc+iQI4BBMBAgAiBQJeMAb7AhsPBgsJCAcDAgYVCAIJCgsEFgIDAQIeAQIXgAAK\nCRBJ/XdJlXD/MZm2D/9kriL43vd3+0DNMeA82n2v9mSR2PQqKny39xNlYPyy/1yZ\nP/KXoa4NYSCA971LSd7lv4n/h5bEKgGHxZfttfOzOnWMVSSTfjRyM/df/NNzTUEV\n7ORA5GW18g8PEtS7uRxVBf3cLvWu5q+8jmqES5HqTAdGVcuIFQeBXFN8Gy1Jinuz\nAH8rJSdkUeZ0cehWbERq80BWM9dhad5dW+/+Gv0foFBvP15viwhWqajr8V0B8es+\n2/tHI0k86FAujV5i0rrXl5UOoLilO57QQNDZH/qW9GsHwVI+2yecLstpUNLq+EZC\nGqTZCYoxYRpl0gAMbDLztSL/8Bc0tJrCRG3tavJotFYlgUK60XnXlQzRkh9rgsfT\nEXbQifWdQMMogzjCJr0hzJ+V1d0iozdUxB2ZEgTjukOvatkB77DY1FPZRkSFIQs+\nfdcjazDIBLIxwJu5QwvTNW8lOLnJ46g4sf1WJoUdNTbR0BaC7HHj1inVWi0p7IuN\n66EPGzJOSjLK+vW+J0ncPDEgLCV74RF/0nR5fVTdrmiopPrzFuguHf9S9gYI3Zun\nYl8FJUu4kRO6JPPTicUXWX+8XZmE94aK14RCJL23nOSi8T1eW8JLW43dCBRO8QUE\nAso1t2pypm/1zZexJdOV8yGME3g5l2W6PLgpz58DBECgqc/kda+VWgEAp7rO2A==\n=EPL3\n-----END PGP PUBLIC KEY BLOCK-----\n&quot;,
            &quot;check_gpg&quot;: true
        }
    ]
}
</code></pre>
<p>After you have created repository overrides in <code>/etc/osbuild-composer/repositories</code>, you must restart the <code>osbuild-composer</code> service in order for the overrides to take effect.</p>
<h2 id="using-repositories-that-require-subscription"><a class="header" href="#using-repositories-that-require-subscription">Using repositories that require subscription</a></h2>
<p><code>osbuild-composer</code> can use subscriptions from the host system if they are configured in the appropriate file in <code>/etc/osbuild-composer/repositories</code>. To enable such repository, copy the <code>baseurl</code> from <code>/etc/yum.repos.d/redhat.repo</code> and paste it into the JSON repository definition. Then allow RHSM support using <code>&quot;rhsm&quot;: true</code> like this:</p>
<pre><code class="language-json">{
  &quot;x86_64&quot;: [
    {
      &quot;baseurl&quot;: &quot;https://localhost/repo&quot;,
      &quot;gpgkey&quot;: &quot;...&quot;,
      &quot;rhsm&quot;: true
    }
  ]
}
</code></pre>
<p><code>osbuild-composer</code> will read the <code>/etc/yum.repos.d/redhat.repo</code> file from the host system and use it as a source of subscriptions. The same subscriptions must be available on a remote worker, if used.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="container-registry-credentials"><a class="header" href="#container-registry-credentials">Container registry credentials</a></h1>
<p>All communication with container registries is done by the <code>osbuild-worker</code>
service. It can be configured via the <code>/etc/osbuild-worker/osbuild-worker.toml</code>
configuration file. It is read only once at service start, so the service
needs to be restarted after making any changes.</p>
<p>The configuration file has a <code>containers</code> section with an <code>auth_file_path</code>
field that is a string referring to a path of a <code>containers-auth.json(5)</code> file
to be used for accessing protected resources. An example configuration could
look like this:</p>
<pre><code class="language-Toml">[containers]
auth_file_path = &quot;/etc/osbuild-worker/containers-auth.json&quot;
</code></pre>
<p>For detailed information on the format of the authorization file itself,
refer to the corresponding man page: <code>man 5 containers-auth.json</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="creating-images-with-the-cli-interface"><a class="header" href="#creating-images-with-the-cli-interface">Creating images with the CLI interface</a></h1>
<p>An image is specified by a blueprint and an image type. Unless you specify otherwise, it will use the same distribution and version (e.g. Fedora 33) as the host system. The architecture will always be the same as the one on the host.</p>
<h2 id="blueprints-management-using-composer-cli"><a class="header" href="#blueprints-management-using-composer-cli">Blueprints management using composer-cli</a></h2>
<p><code>osbuild-composer</code> provides a storage for blueprints. To store a <code>blueprint.toml</code> blueprint file, run this command:</p>
<pre><code>$ composer-cli blueprints push blueprint.toml
</code></pre>
<p>To verify that the blueprint is available, list all currently stored blueprints:</p>
<pre><code>$ composer-cli blueprints list
base-image-with-tmux
</code></pre>
<p>To display the blueprint you have just added, run the command:</p>
<pre><code>$ sudo composer-cli blueprints show base-image-with-tmux
name = &quot;base-image-with-tmux&quot;
description = &quot;A base system with tmux&quot;
version = &quot;0.0.1&quot;
modules = []
groups = []

[[packages]]
name = &quot;tmux&quot;
version = &quot;*&quot;
</code></pre>
<h2 id="building-an-image-using-composer-cli"><a class="header" href="#building-an-image-using-composer-cli">Building an image using composer-cli</a></h2>
<p>To build a customized image, start by choosing the blueprint and image type you would like to build. To do so, run the following commands:</p>
<pre><code>$ sudo composer-cli blueprints list
$ sudo composer-cli compose types
</code></pre>
<p>and trigger a compose (example using the blueprint from the previous section):</p>
<pre><code>$ composer-cli compose start base-image-with-tmux qcow2
Compose ab71b61a-b3c4-434f-b214-1e16527766ff added to the queue
</code></pre>
<p>Note that the compose is assigned with a Universally Unique Identifier (UUID), that you can use to monitor the image build progress:</p>
<pre><code>$ composer-cli compose info ab71b61a-b3c4-434f-b214-1e16527766ff
ab71b61a-b3c4-434f-b214-1e16527766ff RUNNING  base-image-with-tmux 0.0.1 qcow2            2147483648
Packages:
    tmux-*
Modules:
Dependencies:
</code></pre>
<p>At this time, the compose is in a &quot;RUNNING&quot; state. Once the compose reaches the &quot;FINISHED&quot; state, you can download the resulting image by running the following command:</p>
<pre><code>$ sudo composer-cli compose results ab71b61a-b3c4-434f-b214-1e16527766ff
ab71b61a-b3c4-434f-b214-1e16527766ff.tar: 455.18 MB
$ fd
ab71b61a-b3c4-434f-b214-1e16527766ff.tar
$ tar xf ab71b61a-b3c4-434f-b214-1e16527766ff.tar
$ fd 
ab71b61a-b3c4-434f-b214-1e16527766ff-disk.qcow2
ab71b61a-b3c4-434f-b214-1e16527766ff.json
ab71b61a-b3c4-434f-b214-1e16527766ff.tar
logs
logs/osbuild.log
</code></pre>
<p>From the example output above, the resulting tarball contains not only the <code>qcow2</code> image, but also a <code>JSON</code> file, which is the osbuild manifest (see the <a href="image-builder-on-premises/../developer-guide/index.html">Developer Guide</a> for more details), and a directory with logs.</p>
<p>For more options, see the <code>help</code> text for <code>composer-cli</code>:</p>
<pre><code>$ sudo composer-cli compose help
</code></pre>
<h4 id="tip-booting-the-image-with-qemu"><a class="header" href="#tip-booting-the-image-with-qemu">Tip: Booting the image with qemu</a></h4>
<p>If you want to quickly run the resulting image, you can use <code>qemu</code>:</p>
<pre><code>$ qemu-system-x86_64 \
                -enable-kvm \
                -m 3000 \
                -snapshot \
                -cpu host \
                -net nic,model=virtio \
                -net user,hostfwd=tcp::2223-:22 \
                ab71b61a-b3c4-434f-b214-1e16527766ff-disk.qcow2 
</code></pre>
<p>Be aware that you must specify a way to access the machine in the blueprint. For example, you can create a user with known password, set an SSH key, or enable <code>cloud-init</code> to use a <code>cloud-init</code> ISO file.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="building-ostree-image"><a class="header" href="#building-ostree-image">Building OSTree image</a></h1>
<p>This section contains a guide for building OSTree commits. As opposed to the &quot;traditional&quot; image types, these commits are not directly bootable so although they basically contain a full operating system, in order to boot them, they need to be deployed. This can, for example, be done via the  Fedora installer (Anaconda).</p>
<p>OSTree is a technology for creating immutable operating system images and it is a base for Fedora CoreOS, Fedora IoT, Fedora Silverblue, and RHEL for Edge. For more information on OSTree, see <a href="https://ostreedev.github.io/ostree/">their website</a>.</p>
<h2 id="overview-of-the-intended-result"><a class="header" href="#overview-of-the-intended-result">Overview of the intended result</a></h2>
<p>As mentioned above, osbuild-composer produces OSTree commits which are not directly bootable. The commits are inside a tarball to make their usage more convenient. In order to deploy them, you will need:</p>
<ul>
<li>
<p>Fedora installation ISO - such as netinst (<a href="https://getfedora.org/en/server/download/">https://getfedora.org/en/server/download/</a>)</p>
</li>
<li>
<p>HTTP server to serve the content of the tarball to the Fedora virtual machine booted from the ISO</p>
</li>
<li>
<p>Kickstart file that instructs Anaconda (Fedora installer) to use the OSTree commit from the HTTP server</p>
</li>
</ul>
<p>In this guide, a container running Apache <code>httpd</code> will be used as the HTTP server.</p>
<p>The result will look like this:</p>
<pre><code> _________________          ____________________________
|                 |        |                            |
|                 |-------&gt;| Fedora VM with mounted ISO |
|                 |        |  - Anaconda                |
|  Fedora Host OS |        |____________________________|
|                 |                |
|                 |         _______|________________________
|                 |        |                                |
|                 |-------&gt;| Fedora container running httpd |
|_________________|        |  serving content of the tarball|
                           |  and the kickstart file        |
                           |________________________________|
</code></pre>
<p><em>Note: If you would like to understand what is inside the tarball, read the upstream OSTree documentation.</em></p>
<h2 id="building-an-ostree-commit"><a class="header" href="#building-an-ostree-commit">Building an OSTree commit</a></h2>
<p>Start by creating a blueprint for your commit. Using your favorite text editor, <code>vi</code>, create a file named <code>fishy.toml</code> with this content:</p>
<pre><code class="language-toml">name = &quot;fishy-commit&quot;
description = &quot;Fishy OSTree commit&quot;
version = &quot;0.0.1&quot;

[[packages]]
name = &quot;fish&quot;
version = &quot;*&quot;
</code></pre>
<p>Now push the blueprint to osbuild-composer using <code>composer-cli</code>:</p>
<pre><code>$ composer-cli blueprints push fishy.toml
</code></pre>
<p>And start a build:</p>
<pre><code>$ composer-cli compose start fishy-commit fedora-iot-commit
Compose 8e8014f8-4d15-441a-a26d-9ed7fc89e23a added to the queue
</code></pre>
<p>Monitor the build status using:</p>
<pre><code>$ composer-cli compose status
</code></pre>
<p>And finally when the compose is complete, download the result:</p>
<pre><code>$ composer-cli compose image 8e8014f8-4d15-441a-a26d-9ed7fc89e23a
8e8014f8-4d15-441a-a26d-9ed7fc89e23a-commit.tar: 670.45 MB
</code></pre>
<h2 id="writing-a-kickstart-file"><a class="header" href="#writing-a-kickstart-file">Writing a Kickstart file</a></h2>
<p>As mentioned above, the Kickstart file is meant for the Anaconda installer. It contains instructions on how to install the system.</p>
<p>Create a file named <code>ostree.ks</code> with this content:</p>
<pre><code>lang en_US.UTF-8
keyboard us
timezone UTC
zerombr
clearpart --all --initlabel
autopart
reboot
user --name=core --groups=wheel --password=foobar
ostreesetup --nogpg --url=http://10.0.2.2:8000/repo/ --osname=iot --remote=iot --ref=fedora/33/x86_64/iot
</code></pre>
<p>For those interested in all the options, you can read <a href="https://anaconda-installer.readthedocs.io/en/latest/index.html">Anaconda‚Äôs documentation</a>.</p>
<p>The crucial part is on the last line. Here, <code>ostreesetup</code> command is used to fetch the OSTree commit. Now for those wondering about the IP address, this tutorial uses <code>qemu</code> to boot the virtual machine and <code>10.0.2.2</code> is an address which you can use to reach the host system from the guest: <a href="https://wiki.qemu.org/Documentation/Networking#User_Networking_.28SLIRP.29">User Networking</a>.</p>
<h2 id="setting-up-an-http-server"><a class="header" href="#setting-up-an-http-server">Setting up an HTTP server</a></h2>
<p>Now that the kickstart file and OSTree commit are ready, create a container running HTTP server and serving those file. Start by creating a Dockerfile:</p>
<pre><code class="language-dockerfile">FROM fedora:latest
RUN dnf -y install httpd &amp;&amp; dnf clean all
ADD *.tar *.ks /var/www/html
EXPOSE 80
CMD [&quot;/usr/sbin/httpd&quot;, &quot;-D&quot;, &quot;FOREGROUND&quot;]
</code></pre>
<p>Make sure you have everything in the build directory (keep in mind that the UUID is random, so it will be different in your case):</p>
<pre><code>$ ls
8e8014f8-4d15-441a-a26d-9ed7fc89e23a-commit.tar
Dockerfile
ostree.ks
</code></pre>
<p>Build the container image:</p>
<pre><code>$ podman build -t ostree .
</code></pre>
<p>And run it:</p>
<pre><code>$ podman run --rm -p 8000:80 ostree
</code></pre>
<p><em>Note: You might be wondering why to bother with a container when you can just use &quot;python -m http.server&quot;. The problem is that OSTree produces way too many requests and the Python HTTP server simply fails to keep up with OSTree.</em></p>
<h2 id="running-a-vm-and-applying-the-ostree-commit"><a class="header" href="#running-a-vm-and-applying-the-ostree-commit">Running a VM and applying the OSTree commit</a></h2>
<p>Start with downloading the Netinstall image from here: <a href="https://getfedora.org/en/server/download/">https://getfedora.org/en/server/download/</a></p>
<p>Create an empty qcow2 image. That is an image of a hard drive for the virtual machine (VM).</p>
<pre><code>$ qemu-img create -f qcow2 disk-image.img 5G
</code></pre>
<p>Run a VM using the hard drive and mount the installation ISO:</p>
<pre><code>$ qemu-system-x86_64 \
          -enable-kvm \
          -m 3000 \
          -snapshot \
          -cpu host \
          -net nic,model=virtio \
          -net user,hostfwd=tcp::2223-:22 \
          -cdrom $HOME/Downloads/Fedora-Server-netinst-x86_64-33-1.2.iso \
          disk-image.img
</code></pre>
<p><em>Note: To prevent any issue, use the latest stable Fedora host OS for this tutorial.</em></p>
<p>This command instructs qemu (the hypervisor) to:</p>
<ul>
<li>Use KVM virtualization (makes the VM faster).</li>
<li>Increase memory to 3000MB (some processes can get memory hungry, for example <code>dnf</code>).</li>
<li>Snapshot the hard drive image, don't override its content.</li>
<li>Use the same CPU type as the host uses.</li>
<li>Connect the guest to a virtual network bridge on the host and forward TCP port 2223 from the host to the SSH port (22) on the guest (makes it easier to connect to the guest system).</li>
<li>Mount the installation ISO.</li>
<li>Use the hard drive image created above.</li>
</ul>
<p>At the initial screen, use arrow keys to select the &quot;Install Fedora 33&quot; line and press TAB key. You‚Äôll see a line of kernel command line options appear below. Something like:</p>
<p><img src="image-builder-on-premises/img/ostree-in-anaconda.png" alt="" /></p>
<pre><code>vmlinuz initrd=initrd.img inst.stage2=hd:LABEL=Fedora quiet
</code></pre>
<p>Add a space and this string:</p>
<pre><code>inst.ks=http://10.0.2.2:8000/ostree.ks
</code></pre>
<p>Resulting in this kernel command line:</p>
<pre><code>vmlinuz initrd=initrd.img inst.stage2=hd:LABEL=Fedora quiet inst.ks=http://10.0.2.2:8000/ostree.ks
</code></pre>
<p>The IP address <code>10.0.2.2</code> is again used here, because the VM is running inside Qemu.</p>
<p>Press &quot;Enter&quot;, the Anaconda GUI will show up and automatically install the OSTree commit created above.</p>
<p>Once the system is installed and rebooted, use username &quot;core&quot; and password &quot;foobar&quot; to login. You can change the credentials in the kickstart file.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="building-a-rhel-for-edge-installer"><a class="header" href="#building-a-rhel-for-edge-installer">Building a RHEL for Edge Installer</a></h1>
<p>The following describes how to build a boot ISO which installs an OSTree-based system using the &quot;RHEL for Edge Container&quot; in combination with the &quot;RHEL for Edge Installer&quot; image types. The workflow has the same result as the <a href="image-builder-on-premises/./building-ostree-images.html">Building OSTree Image</a> guide with the new image types automating some of the steps.</p>
<p>Note that there are some small differences in this procedure between RHEL 8.4 and RHEL 8.5:</p>
<ul>
<li>The names of the image types have changed. In 8.4, the image types were prefixed by <code>rhel-</code>. This prefix was removed in 8.5.
<ul>
<li>The old names <code>rhel-edge-container</code> and <code>rhel-edge-installer</code> still work in RHEL 8.5 as aliases to the new names, however these names are considered deprecated and may be removed completely in future versions.</li>
</ul>
</li>
<li>The internal port for the container has changed from 80 in RHEL 8.4 to 8080 in RHEL 8.5.</li>
</ul>
<h2 id="process-overview"><a class="header" href="#process-overview">Process overview</a></h2>
<ol>
<li>Create and load a blueprint with customizations.</li>
<li>Build an <code>edge-container</code> (RHEL 8.5) or <code>rhel-edge-container</code> (RHEL 8.4) image.</li>
<li>Load image in podman and start the container.</li>
<li>Create and load an empty blueprint.</li>
<li>Build an <code>edge-installer</code> (RHEL 8.5) or <code>rhel-edge-installer</code> (RHEL 8.4) image, pointing the <code>ostree-url</code> to <code>http://10.0.2.2:8080/repo/</code> and setting the <code>ostree-ref</code> to <code>rhel/edge/demo</code>.</li>
</ol>
<p>The <code>edge-container</code> image type creates an OSTree commit and embeds it into an OCI container with a web server. When the container is started, the web server serves the commit as an OSTree repository.</p>
<p>The <code>edge-intaller</code> image type pulls the commit from the running container and creates an installable boot ISO with a kickstart file configured to use the embedded OSTree commit.</p>
<h2 id="detailed-workflow"><a class="header" href="#detailed-workflow">Detailed workflow</a></h2>
<h3 id="build-the-container-and-serve-the-commit"><a class="header" href="#build-the-container-and-serve-the-commit">Build the container and serve the commit</a></h3>
<p>Start by creating a blueprint for the commit. The content below is an example and can be modified to fit your needs. For this guide, we will name the file <code>example.toml</code>.</p>
<pre><code class="language-toml">name = &quot;example&quot;
description = &quot;RHEL for Edge Installer example&quot;
version = &quot;0.0.3&quot;

[[packages]]
name = &quot;vim-enhanced&quot;
version = &quot;*&quot;

[[packages]]
name = &quot;tmux&quot;
version = &quot;*&quot;

[customizations]

[[customizations.user]]
name = &quot;user&quot;
description = &quot;Example User&quot;
password = &quot;$6$uvdfeuHQYM6kUaea$fvvzyu.Z.u89TVCB2tq8UEc52XDFGnAqCo75BX3zu8OzIbS.EKMo/Saammb151sLrdzmlESnpNEPrJ7h5b0c6/&quot;
groups = [&quot;wheel&quot;]
</code></pre>
<p>Now push the blueprint to osbuild-composer using <code>composer-cli</code>:</p>
<pre><code>$ composer-cli blueprints push example.toml
</code></pre>
<p>And start the container build:</p>
<pre><code>$ composer-cli compose start-ostree --ref &quot;rhel/edge/example&quot; example edge-container
Compose 8e8014f8-4d15-441a-a26d-9ed7fc89e23a added to the queue
</code></pre>
<p>The value for <code>--ref</code> can be changed but must begin with an alphanumeric character and contain only alphanumeric characters, <code>/</code>, <code>_</code>, <code>-</code>, and <code>.</code>.</p>
<p><em>Note: In RHEL 8.4, the image type was called <code>rhel-edge-container</code>. It has been renamed to <code>edge-container</code> in 8.5 onwards.</em></p>
<p>Monitor the build status using:</p>
<pre><code>$ composer-cli compose status
</code></pre>
<p>When the compose is FINISHED, download the result:</p>
<pre><code>$ composer-cli compose image 8e8014f8-4d15-441a-a26d-9ed7fc89e23a
8e8014f8-4d15-441a-a26d-9ed7fc89e23a-rhel84-container.tar: 670.45 MB
</code></pre>
<p>Load the container into registry:</p>
<pre><code>$ cat 8e8014f8-4d15-441a-a26d-9ed7fc89e23a-rhel84-container.tar | podman load
Getting image source signatures
Copying blob 82934cd3e69d done
Copying config d11911c3dc done
Writing manifest to image destination
Storing signatures
Loaded image(s): @d11911c3dc4bee46cabd52b91c87f48b8a7d450fadc8cfbeb69e2de98b413521
</code></pre>
<p>Tag the image for convenience:</p>
<pre><code>$ podman tag d11911c3dc4bee46cabd52b91c87f48b8a7d450fadc8cfbeb69e2de98b413521 localhost/edge-example
</code></pre>
<p>Start the container (note the different internal port numbers between the two versions)</p>
<p>For RHEL 8.4:</p>
<pre><code>$ podman run --rm -d -p 8080:80 --name ostree-repo localhost/edge-example
</code></pre>
<p>For RHEL 8.5+:</p>
<pre><code>$ podman run --rm -d -p 8080:8080 --name ostree-repo localhost/edge-example
</code></pre>
<p><em>Note: The <code>-d</code> option detaches the container and leaves it running in the background. You can also remove the option to keep the container attached to the terminal.</em></p>
<h3 id="build-the-installer"><a class="header" href="#build-the-installer">Build the installer</a></h3>
<p>Start by creating a simple blueprint for the installer. The blueprint must not have any customizations or packages; only a name, and optionally a version and a description. Add the content below to a file and name it <code>empty.toml</code>:</p>
<pre><code>name = &quot;empty&quot;
description = &quot;Empty blueprint&quot;
version = &quot;0.0.1&quot;
</code></pre>
<p>The <code>edge-installer</code> image type does not support customizations or package selection, so the build will fail if any are specified.</p>
<p>Push the blueprint:</p>
<pre><code>$ composer-cli blueprints push empty.toml
</code></pre>
<p>Start the build:</p>
<pre><code>$ composer-cli compose start-ostree --ref &quot;rhel/edge/example&quot; --url http://10.0.2.2:8080/repo/ empty edge-installer
Compose 09d98a67-a401-4613-9a5b-b93f8a6e695f added to the queue
</code></pre>
<p><em>Note: In RHEL 8.4, the image type was called <code>rhel-edge-installer</code>. It has been renamed to <code>edge-installer</code> in 8.5 onwards.</em></p>
<p>The <code>--ref</code> argument must match the one from the <code>rhel-edge-container</code> compose.
The <code>--url</code> in this case is IP address of the container. This tutorial uses <code>qemu</code> to boot the virtual machine and <code>10.0.2.2</code> is an address which you can use to reach the host system from the guest: <a href="https://wiki.qemu.org/Documentation/Networking#User_Networking_.28SLIRP.29">User Networking</a>.</p>
<p>Monitor the build status using:</p>
<pre><code>$ composer-cli compose status
</code></pre>
<p>When the compose is FINISHED, download the result:</p>
<pre><code>$ composer-cli compose image 09d98a67-a401-4613-9a5b-b93f8a6e695f
 09d98a67-a401-4613-9a5b-b93f8a6e695f-rhel84-boot.iso: 1422.61 MB
</code></pre>
<p>The downloaded image can then booted to begin the installation. If you used the blueprint in this guide, use the username &quot;user&quot; and password &quot;password42&quot; to login.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uploading-cloud-images"><a class="header" href="#uploading-cloud-images">Uploading cloud images</a></h1>
<p><code>osbuild-composer</code> can upload images to a cloud provider right after they are built. The configuration is slightly different for each cloud provider. See individual subsections of this documentation.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uploading-an-image-to-aws"><a class="header" href="#uploading-an-image-to-aws">Uploading an image to AWS</a></h1>
<p><code>osbuild-composer</code> provides the users with a convenient way to upload images directly to AWS right after the image is built. Before you can use this feature, you have to define <code>vmimport</code> IAM role in your AWS account. See <a href="https://docs.aws.amazon.com/vm-import/latest/userguide/vmie_prereqs.html#vmimport-role">VM Import/Export Requirements</a> in AWS documentation.</p>
<p>Now, you are ready to upload your first image to AWS. Using a text editor of your choice, create a configuration file with the following content: </p>
<pre><code class="language-toml">provider = &quot;aws&quot;

[settings]
accessKeyID = &quot;AWS_ACCESS_KEY_ID&quot;
secretAccessKey = &quot;AWS_SECRET_ACCESS_KEY&quot;
bucket = &quot;AWS_BUCKET&quot;
region = &quot;AWS_REGION&quot;
key = &quot;OBJECT_KEY&quot;
</code></pre>
<p>There are several considerations when filling values in this file:</p>
<ul>
<li><code>AWS_BUCKET</code> must be in the <code>AWS_REGION</code></li>
<li><code>AWS_BUCKET</code> must be created in AWS prior to running the script</li>
<li>The <code>vmimport</code> role must have read access to the <code>AWS_BUCKET</code> please see this guide on how to do so:  <a href="https://www.msp360.com/resources/blog/how-to-configure-vmimport-role/">How to create vmimport role</a> </li>
<li><code>OBJECT_KEY</code> is the name of an intermediate S3 object. It must not exist before the upload, and it will be deleted when the process is done.</li>
</ul>
<blockquote>
<p>If your authentication method requires you to also specify a session token, you can put it in the <code>settings</code> section of the configuration file in a field named <code>sessionToken</code>.</p>
</blockquote>
<p>Once everything is configured, you can trigger a compose as usual with additional image name and cloud provider profile:</p>
<h2 id="general-syntax"><a class="header" href="#general-syntax">General Syntax</a></h2>
<pre><code>$ sudo composer-cli compose start &lt;image_name&gt; ami IMAGE_KEY aws-config.toml
</code></pre>
<p>where IMAGE_KEY will be the name of your new AMI, once it is uploaded to EC2.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uploading-an-image-to-an-aws-s3-bucket"><a class="header" href="#uploading-an-image-to-an-aws-s3-bucket">Uploading an image to an AWS S3 Bucket</a></h1>
<p><code>osbuild-composer</code> provides the users with a convenient way to upload images, of all sorts, directly to an AWS S3 bucket right after the image is built.</p>
<p>Using a text editor of your choice, create a configuration file with the following content:</p>
<pre><code class="language-toml">provider = &quot;aws.s3&quot;

[settings]
accessKeyID = &quot;AWS_ACCESS_KEY_ID&quot;
secretAccessKey = &quot;AWS_SECRET_ACCESS_KEY&quot;
bucket = &quot;AWS_BUCKET&quot;
region = &quot;AWS_REGION&quot;
key = &quot;OBJECT_KEY&quot;
</code></pre>
<p>There are several considerations when filling values in this file:</p>
<ul>
<li><code>AWS_BUCKET</code> must be in the <code>AWS_REGION</code></li>
</ul>
<blockquote>
<p>If your authentication method requires you to also specify a session token, you can put it in the <code>settings</code> section of the configuration file in a field named <code>sessionToken</code>.</p>
</blockquote>
<p>Once everything is configured, you can trigger a compose as usual with additional image name and cloud provider profile:</p>
<pre><code>$ sudo composer-cli compose start base-image-with-tmux qcow2 IMAGE_KEY aws-s3-config.toml
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uploading-an-image-to-gcp"><a class="header" href="#uploading-an-image-to-gcp">Uploading an image to GCP</a></h1>
<p><code>osbuild-composer</code> provides the users with a convenient way to upload images directly to GCP right after the image is built. Before you can use this feature, you have to provide credentials for your user or service account, which you would like to use for uploading images to GCP.</p>
<p>The account associated with the credentials must have at least the following IAM roles assigned:</p>
<ul>
<li><code>roles/storage.admin</code> - to create and delete storage objects</li>
<li><code>roles/compute.storageAdmin</code> - to import a VM image to Compute Engine</li>
</ul>
<p>Now, you are ready to upload your first image to GCP.</p>
<p>Using a text editor of your choice, create a configuration file <code>gcp-config.toml</code> with the following content:</p>
<pre><code class="language-toml">provider = &quot;gcp&quot;

[settings]
bucket = &quot;GCP_BUCKET&quot;
region = &quot;GCP_STORAGE_REGION&quot;
object = &quot;OBJECT_KEY&quot;
credentials = &quot;GCP_CREDENTIALS&quot;
</code></pre>
<p>There are several considerations when filling values in this file:</p>
<ul>
<li><code>GCP_BUCKET</code> must point to an existing bucket.</li>
<li><code>GCP_STORAGE_REGION</code> can be a <a href="https://cloud.google.com/storage/docs/locations#location-r">regular Google storage region, but also a dual or multi region</a>.</li>
<li><code>OBJECT_KEY</code> is the name of an intermediate storage object. It must not exist before the upload, and it will be deleted when the upload process is done. If the object name does not end with <code>.tar.gz</code>, the extension is automatically added to the object name.</li>
<li><code>GCP_CREDENTIALS</code> is a Base64 encoded content of the credentials JSON file downloaded from GCP. The credentials are used to determine the GCP project to upload the image to.
<blockquote>
<p>Specifying this value in the <code>gcp-config.toml</code> may be optional if you use a different mechanism of authenticating with GCP. For more information about the various ways of authenticating with GCP, read the <a href="image-builder-on-premises/uploading-to-gcp.html#authenticating-with-gcp">Authenticating with GCP</a> below.</p>
</blockquote>
</li>
</ul>
<p>After everything is configured, you can trigger a compose as usual with an additional image name and cloud provider profile:</p>
<pre><code class="language-bash">sudo composer-cli compose start base-image-with-tmux gce IMAGE_KEY gcp-config.toml
</code></pre>
<p>where <em>IMAGE_KEY</em> will be the name of your new GCE image, once it is uploaded to GCP.</p>
<h2 id="authenticating-with-gcp"><a class="header" href="#authenticating-with-gcp">Authenticating with GCP</a></h2>
<p>osbuild-composer supports multiple ways of authenticating with GCP.</p>
<p>In case the osbuild-composer is configured to authenticate with GCP in multiple ways, it uses them in the following order of preference:</p>
<ol>
<li>Credentials specified with the <code>composer-cli</code> command in the configuration file.</li>
<li>Credentials configured in the osbuild-composer worker configuration.</li>
<li>Application Default Credentials from the Google GCP SDK library, which tries to automatically find a way to authenticate using the following options:
<ol>
<li>If <code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variable is set, it tries to load and use credentials from the file pointed to by the variable.</li>
<li>It tries to authenticate using the service account attached to the resource which is running the code (e.g. Google Compute Engine VM).</li>
</ol>
</li>
</ol>
<blockquote>
<p><strong>Note that the GCP credentials are used to determine the GCP project to upload the image to.</strong> Therefore, unless you want to upload all of your images to the same GCP project, you should always specify credentials with the <code>composer-cli</code> command.</p>
</blockquote>
<h3 id="specifying-credentials-with-the-composer-cli-command"><a class="header" href="#specifying-credentials-with-the-composer-cli-command">Specifying credentials with the <code>composer-cli</code> command</a></h3>
<p>You need to specify the credentials with the <code>composer-cli</code> command in the provided upload target configuration <code>gcp-config.toml</code>:</p>
<pre><code class="language-toml">provider = &quot;gcp&quot;

[settings]
...
credentials = &quot;GCP_CREDENTIALS&quot;
</code></pre>
<p>The <code>GCP_CREDENTIALS</code> value is a Base64 encoded content of the Google account credentials JSON file. The reason for this is that the file is quite large and contains multiple key values, therefore mapping them to the TOML configuration format would require more manual work from the user, than encoding the whole file in Base64 and specifying it as a single value.</p>
<p>To get the encoded content of the Google account credentials file with the path stored in <code>GOOGLE_APPLICATION_CREDENTIALS</code> environment variable, run:</p>
<pre><code class="language-bash">base64 -w 0 &quot;${GOOGLE_APPLICATION_CREDENTIALS}&quot;
</code></pre>
<h3 id="specifying-credentials-in-the-osbuild-composer-worker-configuration"><a class="header" href="#specifying-credentials-in-the-osbuild-composer-worker-configuration">Specifying credentials in the osbuild-composer worker configuration</a></h3>
<p>You can configure the credentials to be used for GCP globally for all image builds in the worker configuration <code>/etc/osbuild-worker/osbuild-worker.toml</code>:</p>
<pre><code class="language-toml">[gcp]
credentials = &quot;PATH_TO_GCP_ACCOUNT_CREDENTIALS&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uploading-an-image-to-to-a-bucket-in-a-generic-s3-server"><a class="header" href="#uploading-an-image-to-to-a-bucket-in-a-generic-s3-server">Uploading an image to to a bucket in a Generic S3 server</a></h1>
<p><code>osbuild-composer</code> provides the users with a convenient way to upload images, of all sorts, directly to a bucket in a Generic S3 server right after the image is built.</p>
<p>Using a text editor of your choice, create a configuration file with the following content:</p>
<pre><code class="language-toml">provider = &quot;generic.s3&quot;

[settings]
endpoint = &quot;S3_SERVER_ENDPOINT&quot;
accessKeyID = &quot;S3_ACCESS_KEY_ID&quot;
secretAccessKey = &quot;S3_SECRET_ACCESS_KEY&quot;
bucket = &quot;S3_BUCKET&quot;
region = &quot;S3_REGION&quot;
key = &quot;OBJECT_KEY&quot;
</code></pre>
<p>There are several considerations when filling values in this file:</p>
<ul>
<li><code>AWS_REGION</code> must still be set (e.g. to us-east-1) even if it has no meaning in your S3 server</li>
<li>If your server is using HTTPS with a certificate signed by your own CA, you can either pass the CA bundle by setting the field <code>ca_bundle</code>, pointing it to the CA's public certificate, or skip SSL verification by setting <code>skip_ssl_verification</code> to <code>true</code></li>
</ul>
<p>Once everything is configured, you can trigger a compose as usual with additional image name and cloud provider profile:</p>
<pre><code>$ sudo composer-cli compose start base-image-with-tmux qcow2 IMAGE_KEY generic-s3-config.toml
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uploading-an-image-to-microsoft-azure"><a class="header" href="#uploading-an-image-to-microsoft-azure">Uploading an image to Microsoft Azure</a></h1>
<p><code>osbuild-composer</code> builds images and delivers them to <a href="https://azure.microsoft.com/en-us/">Microsoft Azure</a>
automatically. These images are ready to use with <a href="https://azure.microsoft.com/en-us/services/virtual-machines/">virtual machines</a> in the
Azure cloud.</p>
<h2 id="initial-setup"><a class="header" href="#initial-setup">Initial setup</a></h2>
<p>Before you can upload images to Azure with <code>osbuild-composer</code>, your account
needs some initial setup. Be sure to complete these steps</p>
<ul>
<li>Create a resource group</li>
<li>Create a storage account inside the resource group</li>
<li>Create a storage container within the storage account</li>
<li>Gather your access keys</li>
</ul>
<p>For a detailed walkthrough on each step within the Azure portal, review the
<a href="https://www.redhat.com/en/blog/build-rhel-images-azure-image-builder">Build RHEL images for Azure with Image Builder</a> post on the Red Hat Blog.</p>
<p>Make a note of the following items during the setup so you can provide them to
<code>osbuild-composer</code> during the build process:</p>
<ul>
<li>the name of your storage account</li>
<li>the name of the storage container inside your storage account</li>
<li>the access key for your storage account</li>
</ul>
<h2 id="deploy"><a class="header" href="#deploy">Deploy</a></h2>
<p>Push a blueprint containing your image configuration and create a new file
called <code>azure.toml</code> that contains the information about your Azure storage
account:</p>
<pre><code class="language-toml">provider = &quot;azure&quot;

[settings]
storageAccount = &quot;your storage account name&quot;
storageAccessKey = &quot;storage access key you copied in the Azure portal&quot;
container = &quot;your storage container name&quot;
</code></pre>
<p>Build and deploy the image to Azure:</p>
<pre><code class="language-shell">composer-cli compose start my_blueprint vhd my_image_key azure.toml
</code></pre>
<p>In this example <code>my_blueprint</code> is the name of the blueprint containing your
image configuration. Replace <code>my_image_key</code> with the preferred image name you
want to see in Azure. This is the name that appears inside your storage
container.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uploading-an-image-to-oci"><a class="header" href="#uploading-an-image-to-oci">Uploading an image to OCI</a></h1>
<p><code>osbuild-composer</code> provides the users with a convenient way to upload images directly to OCI right after the image is built.
See <a href="https://docs.oracle.com/en-us/iaas/Content/Compute/Tasks/managingcustomimages.htm">Managing Custom Images</a> in OCI documentation (includes permissions details).</p>
<p>Now, you are ready to upload your first image to OCI. Using a text editor of your choice, create a configuration file with the following content: </p>
<pre><code class="language-toml">provider = &quot;oci&quot;

[settings]
user = &quot;OCI_CLI_USER&quot;
tenancy = &quot;OCI_CLI_TENANCY&quot;
fingerprint = &quot;OCI_CLI_FINGERPRINT&quot;
region = &quot;OCI_CLI_REGION&quot;
bucket = &quot;OCI_BUCKET&quot;
namespace = &quot;OCI_NAMESPACE&quot;
compartment = &quot;OCI_COMPARTMENT&quot;
private_key = '''
...
'''
</code></pre>
<p>There are several considerations when filling values in this file:</p>
<ul>
<li><code>OCI_BUCKET</code> must be in the <code>OCI_REGION</code> and must exist before the upload</li>
</ul>
<p>Once everything is configured, you can trigger a compose as usual with additional image name and cloud provider profile:</p>
<pre><code>$ sudo composer-cli compose start BLUEPRINT_NAME oci IMAGE_KEY oci-config.toml
</code></pre>
<p>where <code>IMAGE_KEY</code> will be the name of your new OCI image once uploaded.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="uploading-a-container-image-to-a-registry"><a class="header" href="#uploading-a-container-image-to-a-registry">Uploading a container image to a registry</a></h1>
<p><code>osbuild-composer</code> can upload a container image, like the RHEL for
edge container, to a registry directly after it has been built.</p>
<p>In order to do so, the container reference and an upload configuration
file need to be specified when building a container artifact:</p>
<pre><code>$ sudo composer-cli compose start BLUEPRINT container REFERENCE CONFIG.toml
</code></pre>
<p>where <code>BLUEPRINT</code> is the name for the container and <code>REFERENCE</code> the
reference to the container image, like <code>registry.example.com/image:tag</code>.
If <code>:tag</code> is omitted, <code>:latest</code> is the default.  The <code>CONFIG.toml</code> file
must include <code>provider = &quot;container&quot;</code>. Other values are optional.</p>
<pre><code class="language-Toml">provider = &quot;container&quot; # required

[settings]
tls_verify = false     # optional, TLS verification, default: true
username = &quot;USERNAME&quot;  # optional, username to use
password = &quot;PASSWORD&quot;  # optional, password to use
</code></pre>
<p>Instead of specifying <code>username</code> and <code>password</code> directly, a central
<code>containers-auth.json(5)</code> file can be used, see
<a href="image-builder-on-premises/./container-auth.html">Container registry credentials</a>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="openscap-remediation"><a class="header" href="#openscap-remediation">OpenSCAP Remediation</a></h1>
<p><code>osbuild-composer</code> now provides the ability to build security hardened images using the <a href="https://github.com/OpenSCAP/openscap/blob/maint-1.3/docs/manual/manual.adoc">OpenSCAP</a> tool. 
This feature is available for <code>RHEL 8.7</code> (&amp; above) and <code>RHEL 9.1</code> (&amp; above).</p>
<h2 id="openscap"><a class="header" href="#openscap">OpenSCAP</a></h2>
<p>The <code>OpenSCAP</code> tool enables users to scan images for vulnerabilities and then remediate the non-compliances according to
predefined security standards. A limitation of this is that it is not always trivial to fix all issues after the first
boot of the image.</p>
<h2 id="build-time-remediation"><a class="header" href="#build-time-remediation">Build-time Remediation</a></h2>
<p>To solve this issue, an <a href="image-builder-on-premises/&#x27;https://github.com/osbuild/osbuild/blob/main/stages/org.osbuild.oscap.remediation&#x27;">osbuild stage</a> runs the <code>OpenSCAP</code> tool on the filesystem tree while the image is being built. The <code>OpenSCAP</code> tool runs 
the standard evaluation for the given profile and applies the remediations to the image. This process enables the user to build a more completely
hardened image compared to running the remediation on a live system.</p>
<h2 id="openscap-example"><a class="header" href="#openscap-example">Openscap Example</a></h2>
<pre><code>[customizations.openscap]
profile_id = &quot;xccdf_org.ssgproject.content_profile_standard&quot;
datastream = &quot;/usr/share/xml/scap/ssg/content/ssg-fedora-ds.xml&quot;
</code></pre>
<p><code>osbuild-composer</code> exposes to fields for the user to customize in the image blueprints: </p>
<ol>
<li>The path to the <code>datastream</code> instructions (most likely in the <code>/usr/share/xml/scap/ssg/content/</code> directory)</li>
<li>The <code>profile_id</code> for the desired security standard</li>
<li>Install openscap via this command: <code>dnf install scap-security-guide</code></li>
<li>Use the command <code>oscap info /usr/share/xml/scap/ssg/content/&lt;security_profile&gt;.xml</code> to obtain more information such as the profile id to use</li>
<li>The <code>profile_id</code> field accepts both the long and short forms, i.e. <code>cis</code> or <code>xccdf_org.ssgproject.content_profile_cis</code>.</li>
</ol>
<p>See the below table for supported profiles.</p>
<p><code>osbuild-composer</code> will then generate the necessary configurations for the <code>osbuild</code> stage based on the user
customizations. Additionally, two packages will be added to the image, <code>openscap-scanner</code> (the <code>OpenSCAP</code> tool)
&amp; <code>scap-security-guide</code> (this package contains the remediation instructions).</p>
<blockquote>
<p>:warning: <strong>Note</strong>
The remediation stage assumes that the
<code>scap-security-guide</code> will be used for the datastream. This package is installed on the image by default. If another datastream is desired, add the necessary package to the blueprint and specify the path to the datastream in the oscap config.</p>
</blockquote>
<h2 id="supported-profiles"><a class="header" href="#supported-profiles">Supported profiles</a></h2>
<p>The supported profiles are distro specific, see below:</p>
<div class="table-wrapper"><table><thead><tr><th></th><th>Fedora</th><th>RHEL 8.7^</th><th>CS9/RHEL 9.1^</th></tr></thead><tbody>
<tr><td>ANSSI-BP-028 (enhanced)</td><td></td><td>x</td><td>x</td></tr>
<tr><td>ANSSI-BP-028 (high)</td><td></td><td>x</td><td>x</td></tr>
<tr><td>ANSSI-BP-028 (intermediary)</td><td></td><td>x</td><td>x</td></tr>
<tr><td>ANSSI-BP-028 (minimal)</td><td></td><td>x</td><td>x</td></tr>
<tr><td>CIS Level 2 - Server</td><td></td><td>x</td><td>x</td></tr>
<tr><td>CIS Level 1 - Server</td><td></td><td>x</td><td>x</td></tr>
<tr><td>CIS Level 1 - Workstation</td><td></td><td>x</td><td>x</td></tr>
<tr><td>CIS Level 2 - Workstation</td><td></td><td>x</td><td>x</td></tr>
<tr><td>CUI</td><td></td><td>x</td><td>x</td></tr>
<tr><td>Essential Eight</td><td></td><td>x</td><td>x</td></tr>
<tr><td>HIPAA</td><td></td><td>x</td><td>x</td></tr>
<tr><td>ISM Official</td><td></td><td>x</td><td>x</td></tr>
<tr><td>OSPP</td><td>x</td><td>x</td><td>x</td></tr>
<tr><td>PCI-DSS</td><td>x</td><td>x</td><td>x</td></tr>
<tr><td>Standard</td><td>x</td><td></td><td></td></tr>
<tr><td>DISA STIG</td><td></td><td>x</td><td>x</td></tr>
<tr><td>DISA STIG with GUI</td><td></td><td>x</td><td>x</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="third-party-repositories"><a class="header" href="#third-party-repositories">Third-party Repositories</a></h1>
<p><code>osbuild-composer</code> supports adding packages from third-party repositories and saving the repository customizations
to an image. This guide aims to clarify each usecase and how to configure <code>osbuild-composer</code> and
the blueprints accordingly.</p>
<p>Very importantly, <code>osbuild-composer</code> has two distinct definitions of third-party repositories. Firstly, <strong>payload repositories</strong> which can be used to install third-party packages at build time and,
secondly, <strong>custom repositories</strong> which are used to persist the repository configurations to the image.</p>
<p>This could lead to the following desired usecases:</p>
<ol>
<li>Install a third-party package</li>
<li>Save the third-party repository configurations to the image</li>
<li>Install a third-party package <strong>and</strong> save the configurations</li>
</ol>
<h2 id="1-install-a-third-party-package"><a class="header" href="#1-install-a-third-party-package">1. Install a third-party package</a></h2>
<p>To install a third-party package at build time, it is necessary to enable the required third-party repository as a payload repository. This will not save any of the repository configurations
to the image and will not make the repositories available to users on the system after the image has been built. For further information on how to install and configure <code>osbuild-composer</code>
to use custom repositories for installing third-party packages, continue reading <a href="image-builder-on-premises/./managing-repositories.html">here</a>.</p>
<h2 id="2-save-repository-configurations"><a class="header" href="#2-save-repository-configurations">2. Save repository configurations</a></h2>
<p>In the second scenario, to make third-party repository configurations persistent and make the repositories available to users on the system, one would use the blueprint <code>custom repository</code>
configurations to enable this. The repository will be configured and saved to <code>/etc/yum.repos.d</code> as a <code>.repo</code> file. GPG keys are not imported at build time, but are imported when first 
installing a third-party package from the desired repository. You can find the blueprint reference for custom repositories <a href="image-builder-on-premises/../blueprint-reference/blueprint-reference.html">here</a>.</p>
<h2 id="3-install-a-third-party-package-and-save-configurations"><a class="header" href="#3-install-a-third-party-package-and-save-configurations">3. Install a third-party package and save configurations</a></h2>
<p>In this case it is necessary to use a combination of payload repositories and custom repositories in order to achieve the desired outcome. This will ensure that the package is installed during 
build time and the repository configuration is saved to disk for future use. If the user only needs the package or the configuration file, they can use the appropriate repository type to achieve
their goal.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="blueprint-reference"><a class="header" href="#blueprint-reference">Blueprint Reference</a></h1>
<p>Blueprints are text files in the <a href="https://toml.io/en/">TOML format</a> that describe customizations for the image you are building.</p>
<blockquote>
<p>An important thing to note is that these customizations are not applicable to all image types. <code>osbuild-composer</code> currently has no good validation or warning system in place to tell you if a customization in your blueprint is not supported for the image type you're building. The customization may be silently dropped.</p>
</blockquote>
<p>A very basic blueprint with just the required attributes at the root looks like:</p>
<pre><code class="language-toml">name = &quot;basic-example&quot;
description = &quot;A basic blueprint&quot;
version = &quot;0.0.1&quot;
</code></pre>
<p>Where:</p>
<ul>
<li>The <code>name</code> attribute is a string that contains the name of the blueprint. It can contain spaces, but they will be converted to <code>-</code> when it is import into <code>osbuild-composer</code>. It should be short and descriptive.</li>
<li>The <code>description</code> attribute is a string that can be a longer description of the blueprint and is only used for display purposes.</li>
<li>The <code>version</code> attribute is a string that contains a semver compatible version number. If a new blueprint is uploaded with the same version the server will automatically bump the PATCH level of the version. If the version doesn't match it will be used as is. For example, uploading a blueprint with version set to 0.1.0 when the existing blueprint version is 0.0.1 will result in the new blueprint being stored as version 0.1.0.</li>
</ul>
<p>You can upload a blueprint with the <code>osbuild-composer blueprints push $filename</code> command, the blueprint will then be usable in <code>osbuild-composer compose</code> as the <code>name</code> you gave it.</p>
<p>Blueprints have two main sections, the <a href="image-builder-on-premises/blueprint-reference.html#content">content</a> and <a href="image-builder-on-premises/blueprint-reference.html#customizations">customizations</a> sections.</p>
<h3 id="distribution-selection-with-blueprints"><a class="header" href="#distribution-selection-with-blueprints">Distribution selection with blueprints</a></h3>
<p>The blueprint now supports a new <code>distro</code> field that will be used to select the
distribution to use when composing images, or depsolving the blueprint. If
<code>distro</code> is left blank it will use the host distribution. If you upgrade the
host operating system the blueprints with no <code>distro</code> set will build using the
new os. You can't build an OS image that differs from the host OS that Image Builder lives on.</p>
<p>eg. A blueprint that will always build a Fedora 38 image, no matter what
version is running on the host:</p>
<pre><code class="language-toml">name = &quot;tmux&quot;
description = &quot;tmux image with openssh&quot;
version = &quot;1.2.16&quot;
distro = &quot;fedora-38&quot;

[[packages]]
name = &quot;tmux&quot;
version = &quot;*&quot;

[[packages]]
name = &quot;openssh-server&quot;
version = &quot;*&quot;
</code></pre>
<h2 id="content"><a class="header" href="#content">Content</a></h2>
<p>The content section determines what goes into the image from other sources such as packages, package groups, or containers. Content is defined at the root of the blueprint.</p>
<ul>
<li><a href="image-builder-on-premises/blueprint-reference.html#packages">Packages</a>.</li>
<li><a href="image-builder-on-premises/blueprint-reference.html#groups">Groups</a>.</li>
<li><a href="image-builder-on-premises/blueprint-reference.html#containers">Containers</a>.</li>
</ul>
<h3 id="packages"><a class="header" href="#packages">Packages</a></h3>
<p>The <code>packages</code> and <code>modules</code> lists contain objects with a <code>name</code> and optional <code>version</code> attribute.</p>
<ul>
<li>The <code>name</code> attribute is a <strong>required</strong> string and can be an exact match, or a filesystem-like glob using <code>*</code> for wildcards and <code>?</code> for character matching.</li>
<li>The <code>version</code> attribute is an <em>optional</em> string can be an exact match or a filesystem-like glob of the version using <code>*</code> for wildcards and <code>?</code> for character matching. If not provided the latest version in the repositories is used.</li>
</ul>
<p><em>Currently there are no differences between packages and modules in <code>osbuild-composer</code>. Both are treated like an rpm package dependency.</em></p>
<blockquote>
<p>When using virtual provides as the package name the version glob should be <code>*</code>. And be aware that you will be unable to <code>freeze</code> the blueprint. This is because the provide will expand into multiple packages with their own names and versions.</p>
</blockquote>
<p>For example, to install <code>tmux-2.9a</code> and <code>openssh-server-8.*</code> packages, add this to your blueprint:</p>
<pre><code class="language-toml">[[packages]]
name = &quot;tmux&quot;
version = &quot;2.9a&quot;

[[packages]]
name = &quot;openssh-server&quot;
version = &quot;8.*&quot;
</code></pre>
<p>Or in alternative syntax:</p>
<pre><code class="language-toml">packages = [
    { name = &quot;tmux&quot;, version = &quot;2.9a&quot; },
    { name = &quot;openssh-server&quot;, version = &quot;8.*&quot; }
]
</code></pre>
<h3 id="groups"><a class="header" href="#groups">Groups</a></h3>
<p>The <code>groups</code> list describes contains objects with a <code>name</code>-attribute.</p>
<ul>
<li>The <code>name</code> attribute is a <strong>required</strong> string and must match the id of a package group in the repositories exactly.</li>
</ul>
<p><code>groups</code> describes groups of packages to be installed into the image. Package groups are defined in the repository metadata. Each group has a descriptive name used primarily for display in user interfaces and an ID more commonly used in kickstart files. Here, the ID is the expected way of listing a group. Groups have three different ways of categorizing their packages: mandatory, default, and optional. For the purposes of blueprints, only mandatory and default packages will be installed. There is no mechanism for selecting optional packages.</p>
<p>For example, if you want to install the <code>anaconda-tools</code> group, add the following to your blueprint:</p>
<pre><code class="language-toml">[[groups]]
name = &quot;anaconda-tools&quot;
</code></pre>
<p>Or in alternative syntax:</p>
<pre><code class="language-toml">groups = [
    { name = &quot;anaconda-tools&quot; }
]
</code></pre>
<h3 id="containers"><a class="header" href="#containers">Containers</a></h3>
<p>The <code>containers</code> list contains objects with a <code>source</code> and optional <code>tls-verify</code> attribute.</p>
<p>These list entries describe the container images to be embedded into the image.</p>
<ul>
<li>The <code>source</code> attribute is a <strong>required</strong> string and is a reference to a container image at a registry.</li>
<li>The <code>name</code> attribute is an <em>optional</em> string to set the name under which the container image will be saved in the image. If not specified <code>name</code> falls back to the same value as <code>source</code>.</li>
<li>The <code>tls-verify</code> attribute is an <em>optional</em> boolean to disable TLS verification of the source download. By default this is set to <code>true</code>.</li>
</ul>
<p>The container is pulled during the image build and stored in the image at the default local container storage location that is appropriate for the image type, so that all supported container tools like <code>podman</code> and <code>cri-o</code> will be able to work with it.</p>
<p>The embedded containers are not started, to do so you can create systemd unit files or quadlets with the files customization.</p>
<p>To embed the latest fedora container from http://quay.io, add this to your blueprint:</p>
<pre><code class="language-toml">[[containers]]
source = &quot;quay.io/fedora/fedora:latest&quot;
</code></pre>
<p>Or in alternative syntax:</p>
<pre><code class="language-toml">containers = [
    { source = &quot;quay.io/fedora/fedora:latest&quot; },
    { source = &quot;quay.io/fedora/fedora-minimal:latest&quot;, tls-verify = false, name = &quot;fedora-m&quot; },
]
</code></pre>
<p>To access protected container resources a <code>containers-auth.json(5)</code> file can be used, see <a href="image-builder-on-premises/../user-guide/container-auth.html">Container registry credentials</a>.</p>
<h2 id="customizations"><a class="header" href="#customizations">Customizations</a></h2>
<p>In the customizations we determine what goes into the image that's not in the default packages defined under <a href="image-builder-on-premises/blueprint-reference.html#content">Content</a>.</p>
<ul>
<li><a href="image-builder-on-premises/blueprint-reference.html#hostname">Hostname</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#kernel-command-line-arguments">Kernel Command Line Arguments</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#ssh-keys">SSH Keys</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#additional-users">Additional Users</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#additional-groups">Additional Groups</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#timezone">Timezone</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#locale">Locale</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#firewall">Firewall</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#systemd-services">Systemd Services</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#files-and-directories">Files and Directories</a>
<ul>
<li><a href="image-builder-on-premises/blueprint-reference.html#directories">Directories</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#files">Files</a></li>
</ul>
</li>
<li><a href="image-builder-on-premises/blueprint-reference.html#ignition">Ignition</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#repositories">Repositories</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#filesystems">Filesystems</a></li>
<li><a href="image-builder-on-premises/blueprint-reference.html#openscap">OpenSCAP</a></li>
</ul>
<h3 id="hostname"><a class="header" href="#hostname">Hostname</a></h3>
<p><code>customizations.hostname</code> is an <em>optional</em> string that can be used to configure the hostname of the final image:</p>
<pre><code class="language-toml">[customizations]
hostname = &quot;baseimage&quot;
</code></pre>
<p>This is optional and can be left out to use the default hostname.</p>
<h3 id="kernel"><a class="header" href="#kernel">Kernel</a></h3>
<h4 id="kernel-command-line-arguments"><a class="header" href="#kernel-command-line-arguments">Kernel Command-Line Arguments</a></h4>
<p>An <em>optional</em> string that allows to append arguments to the bootloader kernel command line:</p>
<pre><code class="language-toml">[customizations.kernel]
append = &quot;nosmt=force&quot;
</code></pre>
<h3 id="ssh-keys"><a class="header" href="#ssh-keys">SSH Keys</a></h3>
<p>An <em>optional</em> list of objects containing:</p>
<ul>
<li>The <code>user</code> attribute is a <strong>required</strong> string and must match the name of a user in the image exactly.</li>
<li>The <code>key</code> attribute is a <strong>required</strong> string that contains the public key to be set for that user.</li>
</ul>
<p><em>Warning: <code>key</code> expects the entire content of the public key file, traditionally <code>~/.ssh/id_rsa.pub</code> but any algorithm supported by the operating system in the image is valid</em></p>
<p><em>Note: If you are adding a user you can add their SSH key in the <a href="image-builder-on-premises/blueprint-reference.html#additional-users">additional users</a> customization instead.</em></p>
<p>Set an existing user's SSH key in the final image:</p>
<pre><code class="language-toml">[[customizations.sshkey]]
user = &quot;root&quot;
key = &quot;PUBLIC SSH KEY&quot;
</code></pre>
<p>The key will be added to the user's <code>authorized_keys</code> file in their home directory.</p>
<h3 id="additional-users"><a class="header" href="#additional-users">Additional Users</a></h3>
<p>An <em>optional</em> list of objects that contain the following attributes:</p>
<ul>
<li><code>name</code> a <strong>required</strong> string that sets the username.</li>
<li><code>description</code> an <em>optional</em> string.</li>
<li><code>password</code> an <em>optional</em> string.</li>
<li><code>key</code> an <em>optional</em> string.</li>
<li><code>home</code> an <em>optional</em> string.</li>
<li><code>shell</code> an <em>optional</em> string.</li>
<li><code>groups</code> an <em>optional</em> list of strings.</li>
<li><code>uid</code> an <em>optional</em> integer.</li>
<li><code>gid</code> an <em>optional</em> integer.</li>
</ul>
<p><em>Warning: <code>key</code> expects the entire content of the public key file, traditionally <code>~/.ssh/id_rsa.pub</code> but any algorithm supported by the operating system in the image is valid</em></p>
<p><em>Note: If the password starts with $6$, $5$, or $2b$ it will be stored as an encrypted password. Otherwise it will be treated as a plain text password.</em></p>
<p>Add a user to the image, and/or set their ssh key. All fields for this section are optional except for the name. The following is a complete example:</p>
<pre><code class="language-toml">[[customizations.user]]
name = &quot;admin&quot;
description = &quot;Administrator account&quot;
password = &quot;$6$CHO2$3rN8eviE2t50lmVyBYihTgVRHcaecmeCk31L...&quot;
key = &quot;PUBLIC SSH KEY&quot;
home = &quot;/srv/widget/&quot;
shell = &quot;/usr/bin/bash&quot;
groups = [&quot;widget&quot;, &quot;users&quot;, &quot;wheel&quot;]
uid = 1200
gid = 1200
</code></pre>
<h3 id="additional-groups"><a class="header" href="#additional-groups">Additional groups</a></h3>
<p>An <em>optional</em> list of objects that contain the following attributes:</p>
<ul>
<li><code>name</code> a <strong>required</strong> string that sets the name of the group.</li>
<li><code>gid</code> a <strong>required</strong> integer that sets the id of the group.</li>
</ul>
<pre><code class="language-toml">[[customizations.group]]
name = &quot;widget&quot;
gid = 1130
</code></pre>
<h3 id="timezone"><a class="header" href="#timezone">Timezone</a></h3>
<p>An <em>optional</em> object that contains the following attributes:</p>
<ul>
<li><code>timezone</code> an <em>optional</em> string. If not provided the UTC timezone is used..</li>
<li><code>ntpservers</code> an <em>optional</em> list of strings containing NTP servers to use. If not provided the distribution defaults are used.</li>
</ul>
<pre><code class="language-toml">[customizations.timezone]
timezone = &quot;US/Eastern&quot;
ntpservers = [&quot;0.north-america.pool.ntp.org&quot;, &quot;1.north-america.pool.ntp.org&quot;]
</code></pre>
<p>The values supported by timezone can be listed by running the command:</p>
<pre><code>$ timedatectl list-timezones
</code></pre>
<p>Some image types have already NTP servers setup such as Google Cloud images. These cannot be overridden because they are required to boot in the selected environment. However, the timezone will be updated to the one selected in the blueprint.</p>
<h3 id="locale"><a class="header" href="#locale">Locale</a></h3>
<p>An <em>optional</em> object that contains the following attributes to customize the locale settings for the system:</p>
<ul>
<li><code>languages</code> an <em>optional</em> list of strings containing locales to be installed.</li>
<li><code>keyboard</code> an <em>optional</em> string to set the keyboard layout.</li>
</ul>
<p>Multiple languages can be added. The first one becomes the primary, and the others are added as secondary. You must include one or more languages or keyboards in the section.</p>
<pre><code class="language-toml">[customizations.locale]
languages = [&quot;en_US.UTF-8&quot;]
keyboard = &quot;us&quot;
</code></pre>
<p>The values supported by languages can be listed by running can be listed by running the command:</p>
<pre><code>$ localectl list-locales
</code></pre>
<p>The values supported by keyboard can be listed by running the command:</p>
<pre><code>$ localectl list-keymaps
</code></pre>
<h3 id="firewall"><a class="header" href="#firewall">Firewall</a></h3>
<p>An <em>optional</em> object containing the following attributes:</p>
<ul>
<li><code>ports</code> an <em>optional</em> list of strings containing ports (or port ranges) and protocols to open.</li>
<li><code>services</code> an <em>optional</em> object with the following attributes containing services to enable or disable for <code>firewalld</code>.
<ul>
<li><code>enabled</code> <em>optional</em> list of strings for services to enable.</li>
<li><code>disabled</code> <em>optional</em> list of strings for services to disable.</li>
</ul>
</li>
</ul>
<p>By default the firewall blocks all access, except for services that enable their ports explicitly such as the sshd. The following blueprint can be used to open other ports or services.</p>
<p><em>Note: Ports are configured using the <code>port:protocol</code> format; port ranges are configured using <code>portA-portB:protocol</code> format:</em></p>
<pre><code class="language-toml">[customizations.firewall]
ports = [&quot;22:tcp&quot;, &quot;80:tcp&quot;, &quot;imap:tcp&quot;, &quot;53:tcp&quot;, &quot;53:udp&quot;, &quot;30000-32767:tcp&quot;, &quot;30000-32767:udp&quot;]
</code></pre>
<p>Numeric ports, or their names from <code>/etc/services</code> can be used in the ports enabled/disabled lists.</p>
<p>The blueprint settings extend any existing settings in the image templates. Thus, if sshd is already enabled, it will extend the list of ports with those already listed by the blueprint.</p>
<p>If the distribution uses <code>firewalld</code> you can specify services listed by <code>firewall-cmd --get-services</code> in a <code>customizations.firewall.services</code> section:</p>
<pre><code class="language-toml">[customizations.firewall.services]
enabled = [&quot;ftp&quot;, &quot;ntp&quot;, &quot;dhcp&quot;]
disabled = [&quot;telnet&quot;]
</code></pre>
<p>Remember that the <code>firewall.services</code> are different from the names in <code>/etc/services</code>.</p>
<p>Both are optional, if they are not used leave them out or set them to an empty list <code>[]</code>. If you only want the default firewall setup this section can be omitted from the blueprint.</p>
<p><em>Note: The Google and OpenStack templates explicitly disable the firewall for their environment. This cannot be overridden by the blueprint.</em></p>
<h3 id="systemd-services"><a class="header" href="#systemd-services">Systemd Services</a></h3>
<p>An <em>optional</em> object containing the following attributes:</p>
<ul>
<li><code>enabled</code> an <em>optional</em> list of strings containing services to be enabled.</li>
<li><code>disabled</code> an <em>optional</em> list of strings containing services to be disabled.</li>
</ul>
<pre><code class="language-toml">[customizations.services]
enabled = [&quot;sshd&quot;, &quot;cockpit.socket&quot;, &quot;httpd&quot;]
disabled = [&quot;postfix&quot;, &quot;telnetd&quot;]
</code></pre>
<p>This section can be used to control which services are enabled at boot time. Some image types already have services enabled or disabled in order for the image to work correctly, and cannot be overridden. For example, <code>ami</code> image type requires <code>sshd</code>, <code>chronyd</code>, and <code>cloud-init</code> services. Without them, the image will not boot. Blueprint services do not replace this services, but add them to the list of services already present in the templates, if any.</p>
<p>The service names are systemd service units. You may specify any systemd unit file accepted by systemctl enable, for example, cockpit.socket:</p>
<h3 id="files-and-directories"><a class="header" href="#files-and-directories">Files and directories</a></h3>
<p>You can use blueprint customizations to create custom files and directories in the image. These customizations are currently restricted only to the <code>/etc</code> directory.</p>
<p>When using the custom files and directories customization, the following rules apply:</p>
<ul>
<li>The path must be an absolute path and must be under <code>/etc</code> or <code>/root</code>.</li>
<li>There must be no duplicate paths of the same directory.</li>
<li>There must be no duplicate paths of the same file.</li>
</ul>
<p>These customizations are not supported for image types that deploy ostree commits (such as <code>edge-raw-image</code>, <code>edge-installer</code>, <code>edge-simplified-installer</code>). The only exception is the Fedora <code>iot-raw-image</code> image type, which supports these customizations.</p>
<h4 id="directories"><a class="header" href="#directories">Directories</a></h4>
<p>You can create custom directories by specifying items in the <code>customizations.directories</code> list. The existence of a specified directory is handled gracefully only if no explicit <code>mode</code>, <code>user</code> or <code>group</code> is specified. If any of these customizations are specified and the directory already exists in the image, the image build will fail. The intention is to prevent changing the ownership or permissions of existing directories.</p>
<p>The following example creates a directory <code>/etc/foobar</code> with all the default settings:</p>
<pre><code class="language-toml">[[customizations.directories]]
path = &quot;/etc/foobar&quot;
mode = &quot;0755&quot;
user = &quot;root&quot;
group = &quot;root&quot;
ensure_parents = false
</code></pre>
<ul>
<li><code>path</code> is the path to the directory to create. It must be an absolute path under <code>/etc</code>. This is the only required field.</li>
<li><code>mode</code> is the octal mode to set on the directory. If not specified, the default is <code>0755</code>. The leading zero is optional.</li>
<li><code>user</code> is the user to set as the owner of the directory. If not specified, the default is <code>root</code>. Can be specified as user name (string) or as user id (integer).</li>
<li><code>group</code> is the group to set as the owner of the directory. If not specified, the default is <code>root</code>. Can be specified as group name (string) or as group id (integer).</li>
<li><code>ensure_parents</code> is a boolean that specifies whether to create parent directories as needed. If not specified, the default is <code>false</code>.</li>
</ul>
<h4 id="files"><a class="header" href="#files">Files</a></h4>
<p>You can create custom files by specifying items in the <code>customizations.files</code> list. You can use the customization to create new files or to replace existing ones, if not restricted by the policy specified below. If the target path is an existing symlink to another file, the symlink will be replaced by the custom file.</p>
<p>Please note that the parent directory of a specified file must exist. If it does not exist, the image build will fail. One can ensure that the parent directory exists by specifying it in the <code>customizations.directories</code> list.</p>
<p>In addition, the following files are not allowed to be created or replaced by policy:</p>
<ul>
<li><code>/etc/fstab</code></li>
<li><code>/etc/shadow</code></li>
<li><code>/etc/passwd</code></li>
<li><code>/etc/group</code></li>
</ul>
<p>Using the <code>files</code> customization comes with a high chance of creating an image that doesn't boot. <strong>Use this feature only if you know what you are doing</strong>. Although the <code>files</code> customization can be used to configure parts of the OS which can also be configured by other blueprint customizations, this use is discouraged. If possible, users should always default to using the specialized blueprint customizations. Note that if you combine the files customizations with other customizations, the other customizations may not work as expected or may be overridden by the files customizations.</p>
<p>The following example creates a file <code>/etc/foobar</code> with the contents <code>Hello world!</code>:</p>
<pre><code class="language-toml">[[customizations.files]]
path = &quot;/etc/foobar&quot;
mode = &quot;0644&quot;
user = &quot;root&quot;
group = &quot;root&quot;
data = &quot;Hello world!&quot;
</code></pre>
<ul>
<li><code>path</code> is the path to the file to create. It must be an absolute under <code>/etc</code>. This is the only required field.</li>
<li><code>mode</code> is the octal mode to set on the file. If not specified, the default is <code>0644</code>. The leading zero is optional.</li>
<li><code>user</code> is the user to set as the owner of the file. If not specified, the default is <code>root</code>. Can be specified as user name (string) or as user id (integer).</li>
<li><code>group</code> is the group to set as the owner of the file. If not specified, the default is <code>root</code>. Can be specified as group name (string) or as group id (integer).</li>
<li><code>data</code> is the plain text contents of the file. If not specified, the default is an empty file.</li>
</ul>
<p>Note that the <code>data</code> property can be specified in any of the ways supported by TOML. Some of them require escaping certain characters and others don't. Please refer to the <a href="https://toml.io/en/v1.0.0#string">TOML specification</a> for more details.</p>
<h3 id="ignition"><a class="header" href="#ignition">Ignition</a></h3>
<p>The <code>customizations.ignition</code> section allows users to provide <a href="https://coreos.github.io/ignition/">Ignition</a> configuration files to be used in <code>edge-raw-image</code> and <code>edge-simplified-installer</code> images. Check the RHEL for Edge (<code>r4e</code>) <a href="https://coreos.github.io/butane/specs/">butane</a> specification for a description of the supported configuration options.</p>
<p>The blueprint configuration can be done <em>either</em> by embedding an Ignition configuration file into the image (only available for <code>edge-simplified-installer</code>), or providing a provisioning URL that will be fetched at first boot.</p>
<h4 id="ignitionembedded-configuration"><a class="header" href="#ignitionembedded-configuration"><code>ignition.embedded</code> configuration</a></h4>
<pre><code class="language-toml">[customizations.ignition.embedded]
config = &quot;eyJpZ25pdGlvbiI6eyJ2ZXJzaW9uIjoiMy4zLjAifSwicGFzc3dkIjp7InVzZXJzIjpbeyJncm91cHMiOlsid2hlZWwiXSwibmFtZSI6ImNvcmUiLCJwYXNzd29yZEhhc2giOiIkNiRqZnVObk85dDFCdjdOLjdrJEhxUnhxMmJsdFIzek15QUhqc1N6YmU3dUJIWEVyTzFZdnFwaTZsamNJMDZkUUJrZldYWFpDdUUubUpja2xQVHdhQTlyL3hwSmlFZFdEcXR4bGU3aDgxIn1dfX0=&quot;
</code></pre>
<p>Add a <code>base64</code> encoded Ignition configuration in the <code>config</code> field. This Ignition configuration will be included in the <code>edge-simplified-installer</code> image.</p>
<h4 id="ignitionfirstboot-configuration"><a class="header" href="#ignitionfirstboot-configuration"><code>ignition.firstboot</code> configuration</a></h4>
<pre><code class="language-toml">[customizations.ignition.firstboot]
url = &quot;http://some-server/configuration.ig&quot;
</code></pre>
<p>Add a URL pointing to the Ignition configuration that will be fetched during the first boot in the <code>url</code> field. Available for both <code>edge-simplified-installer</code> and <code>edge-raw-image</code>.</p>
<h3 id="repositories"><a class="header" href="#repositories">Repositories</a></h3>
<p>Third-party repositories are supported by the blueprint customizations. A repository can be defined and enabled in the blueprints which will then be saved to the <code>/etc/yum.repos.d</code> directory in an image.
An optional <code>filename</code> argument can be set, otherwise the repository will be saved using the the repository ID, i.e. <code>/etc/yum.repos.d/&lt;repo-id&gt;.repo</code>.</p>
<p>Please note custom repositories <strong>cannot be used at build time to install third-party packages</strong>. These customizations are used to save and enable third-party repositories on the image. For more information, or if you
wish to install a package from a third-party repository, please continue reading <a href="image-builder-on-premises/../user-guide/repository-customizations.html">here</a>.</p>
<p>The following example can be used to create a third-party repository:</p>
<pre><code class="language-toml">[[customizations.repositories]]
id = &quot;example&quot;
name=&quot;Example repo&quot;
baseurls=[ &quot;https://example.com/yum/download&quot; ]
gpgcheck=true
gpgkeys = [ &quot;https://example.com/public-key.asc&quot; ]
enabled=true
</code></pre>
<p>Since no filename is specified, the repo will be saved to <code>/etc/yum.repos.d/example.repo</code>.</p>
<p>The blueprint accepts the following options:</p>
<ul>
<li><code>id</code> (required)</li>
<li><code>name</code></li>
<li><code>filename</code></li>
<li><code>baseurls</code> (array)</li>
<li><code>mirrorlist</code></li>
<li><code>metalink</code></li>
<li><code>gpgkeys</code> keys (array)</li>
<li><code>gpgcheck</code></li>
<li><code>repo_gpgcheck</code></li>
<li><code>priority</code></li>
<li><code>ssl_verify</code></li>
</ul>
<p><em>Note: the <code>baseurls</code> and <code>gpgkeys</code> fields both accept arrays as input. One of <code>baseurls</code>, <code>metalink</code> &amp; <code>mirrorlist</code> must be provided</em></p>
<h4 id="repository-gpg-keys"><a class="header" href="#repository-gpg-keys">Repository GPG Keys</a></h4>
<p>The blueprint accepts both inline GPG keys and GPG key urls. If an inline GPG key is provided it will be saved to the <code>/etc/pki/rpm-gpg</code> directory and will be referenced accordingly
in the repository configuration. <strong>GPG keys are not imported to the RPM database</strong> and will only be imported when first installing a package from the third-party repository.</p>
<h3 id="filesystems"><a class="header" href="#filesystems">Filesystems</a></h3>
<p>The blueprints can be extended to provide filesytem support. Currently the <code>mountpoint</code> and minimum partition <code>size</code> can be set. Custom mountpoints are currently only supported for <code>RHEL 8.5</code> &amp; <code>RHEL 9.0</code>. For other distributions, only the <code>root</code> partition is supported, the size argument being an alias for the image size.</p>
<pre><code class="language-toml">[[customizations.filesystem]]
mountpoint = &quot;/var&quot;
size = 2147483648
</code></pre>
<p>In addition to the root mountpoint, <code>/</code>, the following <code>mountpoints</code> and their sub-directories are supported:</p>
<ul>
<li><code>/var</code></li>
<li><code>/home</code></li>
<li><code>/opt</code></li>
<li><code>/srv</code></li>
<li><code>/usr</code></li>
<li><code>/app</code></li>
<li><code>/data</code></li>
<li><code>/tmp</code></li>
</ul>
<p>Filesystem customizations are currently <strong>not</strong> supported for the following image types:</p>
<ul>
<li><code>image-installer</code></li>
<li><code>edge-installer</code> (RHEL and CentOS) and <code>iot-installer</code> (Fedora)</li>
<li><code>edge-simplified-installer</code> (RHEL and CentOS)</li>
</ul>
<p>In addition, the following image types do not create partitioned OS images and therefore filesystem customizations for these types are meaningless:</p>
<ul>
<li><code>edge-commit</code> (RHEL and CentOS) and <code>iot-commit</code> (Fedora)</li>
<li><code>edge-container</code> (RHEL and CentOS) and <code>iot-container</code> (Fedora)</li>
<li><code>tar</code></li>
<li><code>container</code></li>
</ul>
<h3 id="openscap-1"><a class="header" href="#openscap-1">OpenSCAP</a></h3>
<p>From <code>RHEL 8.7</code> &amp; <code>RHEL 9.1</code> support has been added for <code>OpenSCAP</code> build-time remediation. The blueprints accept two fields:</p>
<ul>
<li>the <code>datastream</code> path to the remediation instructions</li>
<li>the <code>profile_id</code> of the desired security profile</li>
</ul>
<p>Please see <a href="image-builder-on-premises/oscap-remediation.html">the OpenSCAP page</a> for the list of available security profiles.</p>
<pre><code class="language-toml">[customizations.openscap]
datastream = &quot;/usr/share/xml/scap/ssg/content/ssg-rhel8-ds.xml&quot;
profile_id = &quot;xccdf_org.ssgproject.content_profile_cis&quot;
</code></pre>
<h2 id="example-blueprints"><a class="header" href="#example-blueprints">Example Blueprints</a></h2>
<p>The following blueprint example will:</p>
<ul>
<li>install the <code>tmux</code>, <code>git</code>, and <code>vim-enhanced</code> packages</li>
<li>set the root ssh key</li>
<li>add the groups: widget, admin users and students</li>
</ul>
<pre><code class="language-toml">name = &quot;example-custom-base&quot;
description = &quot;A base system with customizations&quot;
version = &quot;0.0.1&quot;

[[packages]]
name = &quot;tmux&quot;
version = &quot;*&quot;

[[packages]]
name = &quot;git&quot;
version = &quot;*&quot;

[[packages]]
name = &quot;vim-enhanced&quot;
version = &quot;*&quot;

[customizations]
hostname = &quot;custombase&quot;

[[customizations.sshkey]]
user = &quot;root&quot;
key = &quot;A SSH KEY FOR ROOT&quot;

[[customizations.user]]
name = &quot;widget&quot;
description = &quot;Widget process user account&quot;
home = &quot;/srv/widget/&quot;
shell = &quot;/usr/bin/false&quot;
groups = [&quot;dialout&quot;, &quot;users&quot;]

[[customizations.user]]
name = &quot;admin&quot;
description = &quot;Widget admin account&quot;
password = &quot;$6$CHO2$3rN8eviE2t50lmVyBYihTgVRHcaecmeCk31LeOUleVK/R/aeWVHVZDi26zAH.o0ywBKH9Tc0/wm7sW/q39uyd1&quot;
home = &quot;/srv/widget/&quot;
shell = &quot;/usr/bin/bash&quot;
groups = [&quot;widget&quot;, &quot;users&quot;, &quot;students&quot;]
uid = 1200

[[customizations.user]]
name = &quot;plain&quot;
password = &quot;simple plain password&quot;

[[customizations.user]]
name = &quot;bart&quot;
key = &quot;SSH KEY FOR BART&quot;
groups = [&quot;students&quot;]

[[customizations.group]]
name = &quot;widget&quot;

[[customizations.group]]
name = &quot;students&quot;

[[customizations.filesystem]]
mountpoint = &quot;/&quot;
size = 2147483648

[customizations.openscap]
datastream = &quot;/usr/share/xml/scap/ssg/content/ssg-rhel8-ds.xml&quot;
profile_id = &quot;xccdf_org.ssgproject.content_profile_cis&quot;
</code></pre>
<div style="break-before: page; page-break-before: always;"></div><h1 id="developer-guide"><a class="header" href="#developer-guide">Developer Guide</a></h1>
<p>In this section, you will find a description of the source code in <code>osbuild</code> organization.</p>
<p>The following scheme describes how separate components communicate with each other:
<img src="developer-guide/osbuild-composer.svg" alt="" /></p>
<p>In the very basic use case where <code>osbuild-composer</code> is running locally, the &quot;pool of workers&quot; also lives on the user's host machine. The <code>osbuild-composer</code> and <code>osbuild-worker</code> processes are spawned by systemd. We don't support any other means of spawning these processes, as they rely on systemd to open sockets, create state directories etc. Additionally, <code>osbuild-worker</code> spawns osbuild as a subprocess to create the image itself. The whole image building machinery is spawned from a user process, for example, <code>composer-cli</code>.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="general"><a class="header" href="#general">General</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="glossary"><a class="header" href="#glossary">Glossary</a></h1>
<div class="table-wrapper"><table><thead><tr><th>Term</th><th>Explanation</th></tr></thead><tbody>
<tr><td>AMI</td><td>Amazon Machine Image (image type)</td></tr>
<tr><td>Blueprint</td><td>Definition of customizations in the image</td></tr>
<tr><td>Compose</td><td>Request from the user that produces one or more images. Images in a single compose are, in theory, the same, but for different platforms, such as Azure or AWS. In practice they are slightly different because every cloud platform requires a different package set and system configuration. osbuild-composer running the Weldr API can only create one image at a time, so one compose maps directly to one image build. It can map to multiple image builds when used with other APIs, such as the Koji API.</td></tr>
<tr><td>Composer API</td><td>HTTP API meant as publicly accessible (over TCP). It was created specifically for osbuild-composer and does not support some Weldr features like blueprint management, but adds new features like building different distros and architectures.</td></tr>
<tr><td>GCP</td><td>Google Cloud Platform</td></tr>
<tr><td>Image Build</td><td>One request from osbuild-composer to osbuild-worker. Its result is a single image.</td></tr>
<tr><td>Image Type</td><td>Image file format usually associated with a specific use case. For example: AMI for AWS, qcow2 for OpenStack, etc.</td></tr>
<tr><td>Manifest</td><td>Input for the osbuild tool. It should be a precise definition of an image. See https://www.osbuild.org/man/osbuild-manifest.5 for more information.</td></tr>
<tr><td>osbuild</td><td>Low-level tool for building images. Not meant for end-user usage.</td></tr>
<tr><td>osbuild-composer</td><td>HTTP service for building OS images.</td></tr>
<tr><td>OSTree</td><td>Base technology for immutable OS images: Fedora IoT and RHEL Edge</td></tr>
<tr><td>Repository overrides</td><td>osbuild-composer uses its own set of repository definitions. In case a user wants to use custom repositories, &quot;overrides&quot; can be created in /etc/osbuild-composer</td></tr>
<tr><td>Weldr API</td><td>Local HTTP API used for communication between composer-cli/cockpit-composer and osbuild-composer. It comes from the lorax-composer project.</td></tr>
</tbody></table>
</div><div style="break-before: page; page-break-before: always;"></div><h1 id="workflow"><a class="header" href="#workflow">Workflow</a></h1>
<h2 id="git-workflow"><a class="header" href="#git-workflow">Git Workflow</a></h2>
<h3 id="commits"><a class="header" href="#commits">Commits</a></h3>
<p>Commits should be easy to read.</p>
<p>The commit message should explain clearly what it's trying to do and why. The following format is
common but not required:</p>
<pre><code>&lt;module&gt;: Topic of the commit

Body of the commit, describing the changes in more detail.
</code></pre>
<p>The <code>&lt;module&gt;</code> should point to the area of the codebase (for instance <code>tests</code> or <code>tools</code>). The topic
should summarize what the commit is doing.</p>
<p>GitHub truncates the first line if it's longer than 65 characters, which is something to keep in
mind as well.</p>
<p>A <code>Fixes #issue-number</code> can be added to automatically link and close a related issue if it exists.</p>
<h3 id="pull-requests"><a class="header" href="#pull-requests">Pull requests</a></h3>
<p>A pull request should be one or more commits which form a coherent unit, it can be
rebased/rewritten/force-pushed until it's fit for merging.</p>
<p>How the PR developed, and the iterations it went through, should not be visible in the git
history. The end result counts: a certain amount of commits, each one forming a logical unit of
changes. Avoid 'fix-up' commits which tweak previous commits in the PR.</p>
<p>Pull requests should be opened from a developer's own fork to avoid random branches on the origin.</p>
<p>Each pull request should be reviewed, and the CI should pass.</p>
<p>Once a pull request is ready to be merged, it should be merged via the <code>Rebase and merge</code> or <code>Squash and merge</code> option. This avoids merge commits on the main branch.</p>
<h3 id="branches"><a class="header" href="#branches">Branches</a></h3>
<p>Force-pushing to, or rebasing the main branch (or other release branches) is not allowed. Avoid
directly pushing (fast-forward) to those branches as well. Commits can always be reverted by opening
a new pull request.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="code-style-guidelines"><a class="header" href="#code-style-guidelines">Code style guidelines</a></h1>
<p>This depends a little bit on the project and the language. Most of our projects have linters
available, so do make use of those.</p>
<p>If unsure on how to format a specific statement, try to look for examples in the code.</p>
<h2 id="general-1"><a class="header" href="#general-1">General</a></h2>
<ul>
<li>
<p>No trailing whitespace</p>
</li>
<li>
<p>Avoid really long lines where possible (&gt;120 characters)</p>
</li>
<li>
<p>Single newline at the end of each file</p>
</li>
</ul>
<h3 id="golang"><a class="header" href="#golang">Golang</a></h3>
<p>This is easy, simply use <a href="https://blog.golang.org/gofmt">Gofmt</a>.</p>
<h3 id="python"><a class="header" href="#python">Python</a></h3>
<p>Python code should follow <a href="https://www.python.org/dev/peps/pep-0008/">the PEP 8 style guide</a>.</p>
<h3 id="shell"><a class="header" href="#shell">Shell</a></h3>
<p><a href="https://www.shellcheck.net/">ShellCheck</a> is used to lint shell code.</p>
<h3 id="javascript"><a class="header" href="#javascript">Javascript</a></h3>
<p>Projects like <a href="https://github.com/osbuild/cockpit-composer/">Cockpit Composer</a> use eslint to enforce
style.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="releasing"><a class="header" href="#releasing">Releasing</a></h1>
<p>This guide describes the process of releasing osbuild and osbuild-composer to <a href="https://github.com/osbuild/osbuild">upstream</a>, into <a href="https://src.fedoraproject.org/rpms/osbuild">Fedora</a> and <a href="https://gitlab.com/redhat/centos-stream/rpms/osbuild">CentOS Stream</a>.</p>
<h2 id="clone-the-release-helpers"><a class="header" href="#clone-the-release-helpers">Clone the release helpers</a></h2>
<p>Go to the <a href="https://github.com/osbuild/maintainer-tools">maintainer-tools repository</a>, clone the repository and run <code>pip install -r requirements.txt</code> in order to get all the dependencies to be able to execute the <code>release.py</code> and <code>update-distgit.py</code> scripts.</p>
<p>It's also advised to set a GitHub personal access token, otherwise you might run into API usage quotas. Go to <a href="https://github.com/settings/tokens">Personal access tokens</a> on GitHub and create a new token with scope <code>public_repo</code>. Now, create a new packit user configuration at <code>~/.config/packit.yaml</code> and paste there the following content:</p>
<pre><code>authentication:
  github.com:
    token: [YOUR_GITHUB_PERSONAL_ACCESS_TOKEN]
</code></pre>
<h2 id="upstream-release"><a class="header" href="#upstream-release">Upstream release</a></h2>
<p>Note: <a href="https://github.com/osbuild/release-action/tree/create-tag">Upstream releases are done automatically</a> on a fortnightly alternating schedule, meaning one week we release osbuild and then the next week we release osbuild-composer.</p>
<h3 id="manual-upstream-release"><a class="header" href="#manual-upstream-release">Manual upstream release</a></h3>
<p>Navigate to your local repository in your terminal and call the <code>release.py</code> script. It will interactively take you through the following steps:</p>
<ol>
<li>
<p>Gather all pull request titles merged to <code>main</code> since the latest release tag</p>
</li>
<li>
<p>Create a draft of the next release tag</p>
<p>While writing the commit message, keep in mind that it needs to conform to both Markdown and git commit message formats, have a look at the commit message for one of the <a href="https://github.com/osbuild/osbuild-composer/tags">recent releases</a> to get a clear idea how it should look like.</p>
</li>
<li>
<p>Push your signed git tag to <code>main</code></p>
</li>
</ol>
<p>From here on a <a href="https://github.com/osbuild/release-action">GitHub composite action</a> will take over and</p>
<ol>
<li>Create a GitHub release based on the tag (version and message)</li>
<li>Bump the version in <code>osbuild.spec</code> or <code>osbuild-composer.spec</code> (and potentially <code>setup.py</code>)</li>
<li>Commit and push this change to <code>main</code> so the version is already reflecting the next release</li>
</ol>
<h2 id="fedora-release"><a class="header" href="#fedora-release">Fedora release</a></h2>
<p>We use packit (see <code>.packit.yml</code> in the osbuild or osbuild-composer repository respectively or the <a href="https://packit.dev/docs/">official packit documentation</a>) to automatically push new releases directly to <a href="https://src.fedoraproject.org/rpms/osbuild">Fedora's dist-git</a>.</p>
<p>Then our <a href="https://github.com/osbuild/fedora-bot">fedora-bot</a> takes over and performs the remaining steps:</p>
<ol>
<li>Get a kerberos ticket by running <code>kinit $USER@FEDORAPROJECT.ORG</code></li>
<li>Call <code>fedpkg build</code> to schedule Koji builds for each active Fedora release (or: dist-git branch)</li>
<li>Update <a href="https://bodhi.fedoraproject.org/">Bodhi</a> with the latest release</li>
</ol>
<h2 id="centos-stream--rhel-releases"><a class="header" href="#centos-stream--rhel-releases">CentOS Stream / RHEL releases</a></h2>
<p>If you are a Red Hat employee, please continue reading about this in our internal release guide.</p>
<h2 id="spreading-the-word-on-osbuildorg"><a class="header" href="#spreading-the-word-on-osbuildorg">Spreading the word on osbuild.org</a></h2>
<p>The last of releasing a new version is to create a new post on osbuild.org. Just open a PR in <a href="https://github.com/osbuild/osbuild.github.io">osbuild/osbuild.github.io</a>. You can find a lot of inspiration in existing release posts.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="backporting-simple-fixes"><a class="header" href="#backporting-simple-fixes">Backporting simple fixes</a></h1>
<h2 id="overview"><a class="header" href="#overview">Overview</a></h2>
<div class="table-wrapper"><table><thead><tr><th>Method</th><th>Complexity</th><th>Time</th><th>Notes</th></tr></thead><tbody>
<tr><td><a href="https://copr.fedorainfracloud.org/coprs/g/osbuild/">COPR</a></td><td>Easy</td><td>Immediate</td><td>Unofficial, but the fix is already there</td></tr>
<tr><td>Unsigned RPM</td><td>Easy</td><td>1 week</td><td>Unofficial in that it's unsigned</td></tr>
<tr><td>Async Update to z-stream</td><td>Difficult</td><td>2 weeks</td><td>Requires sign-off from many and could be rejected</td></tr>
<tr><td>Batch Update to z-stream</td><td>Medium</td><td>up to 8 weeks</td><td>Red Hat's preferred method</td></tr>
</tbody></table>
</div>
<h2 id="how-to"><a class="header" href="#how-to">How to</a></h2>
<h3 id="copr"><a class="header" href="#copr">COPR</a></h3>
<ol>
<li>Share the correct COPR package version and URL</li>
</ol>
<h3 id="unsigned-rpm"><a class="header" href="#unsigned-rpm">Unsigned RPM</a></h3>
<ol>
<li>Take the latest spec file from downstream</li>
<li>Create a downstream patch and add it</li>
<li>Create a scratch build in Brew</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div><h1 id="latest-rpm-builds"><a class="header" href="#latest-rpm-builds">Latest RPM builds</a></h1>
<p>While developing osbuild and osbuild composer it is convenient to download the latest RPM builds directly from upstream. The repositories in the osbuild organization don't use any automation from Copr or Packit. Instead, the RPMs are built directly in the Jenkins CI and stored in AWS under the commit hash which allows anyone to download precisely the version built from a desired commit.</p>
<p>The URL is specified in the <code>mockbuild.sh</code> scripts in the osbuild and osbuild-composer repositories:</p>
<ul>
<li><a href="https://github.com/osbuild/osbuild-composer/blob/f091af55d89ac9e77aa34b94e0180aacead3f32e/schutzbot/mockbuild.sh#L27">mockbuild.sh in osbuild-composer</a></li>
<li><a href="https://github.com/osbuild/osbuild/blob/850ee4466f0e3335d4c21871a5f2549f2f571965/schutzbot/mockbuild.sh#L27">mockbuild.sh in osbuild</a></li>
</ul>
<p>And the final resulting URL is displayed in the Jenkins output (available only from Red Hat VPN).</p>
<p><em>Common trap: If you click on a link to a repo, such as:</em></p>
<p><a href="http://osbuild-composer-repos.s3-website.us-east-2.amazonaws.com/osbuild-composer/rhel-8.4/x86_64/6b67ca34caf0ff9d31fabb398f50533c1e41c847/">http://osbuild-composer-repos.s3-website.us-east-2.amazonaws.com/osbuild-composer/rhel-8.4/x86_64/6b67ca34caf0ff9d31fabb398f50533c1e41c847/</a></p>
<p><em>you will get HTTP 403 because that's a directory and we don't allow directory listing. If you append a known file path, such as</em> <code>repodata/repomd.xml</code> <em>you will see that the repo is there:</em></p>
<p><a href="http://osbuild-composer-repos.s3-website.us-east-2.amazonaws.com/osbuild-composer/rhel-8.4/x86_64/6b67ca34caf0ff9d31fabb398f50533c1e41c847/repodata/repomd.xml">http://osbuild-composer-repos.s3-website.us-east-2.amazonaws.com/osbuild-composer/rhel-8.4/x86_64/6b67ca34caf0ff9d31fabb398f50533c1e41c847/repodata/repomd.xml</a></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="testing-strategy"><a class="header" href="#testing-strategy">Testing strategy</a></h1>
<p>Let me start with a quote:</p>
<blockquote>
<p>As the team obsessed with immutable test dependencies, how could we use ..</p>
</blockquote>
<p><em>One osbuild developer in one PR fixing one more piece of infrastructure which could still change.</em></p>
<p>TODO: what do we test in each repo</p>
<h2 id="osbuild-composer"><a class="header" href="#osbuild-composer">osbuild-composer</a></h2>
<p>This section provides a basic summary of the various types of testing done for <code>osbuild-composer</code>. Detailed information about testing can be found in <a href="https://github.com/osbuild/osbuild-composer/blob/main/test/README.md">the upstream repository</a>.</p>
<h3 id="unit-tests"><a class="header" href="#unit-tests">Unit tests</a></h3>
<p>There is pretty heavy mocking in the osbuild-composer codebase.</p>
<p>HTTP API is unit-tested without any network communication (there is no socket), only the HTTP request/responses are tested.</p>
<h3 id="integration-tests"><a class="header" href="#integration-tests">Integration tests</a></h3>
<p>These test cases live under <code>test/cases</code> and each of them is a standalone script. Some of them invoke additional binaries which live under <code>cmd</code> if not specified otherwise.</p>
<ol>
<li>
<p><code>api.sh [aws|azure|gcp]</code> - test the Cloud API (running at localhost:443)</p>
<ul>
<li>
<p>Provisions osbuild-composer and locally running remote worker.</p>
</li>
<li>
<p>Creates a request for compose and uploads the image to specified cloud provider. Currently AWS, Azure and GCP are supported.</p>
</li>
<li>
<p>The uploaded image is used for a VM instance in the respective cloud environment, booted and connected to via SSH. This is currently tested only for AWS and GCP.</p>
</li>
<li>
<p><strong>Requires credentials for the respective cloud provider</strong> to work properly.</p>
</li>
</ul>
</li>
<li>
<p><code>aws.sh</code></p>
<p>Use osbuild-composer &quot;the way we expect our customers to use it&quot;. That means provision <code>osbuild-composer</code> and use Weldr API to build an AMI image and upload it to EC2. Then use the <code>aws</code> CLI tool to spawn a VM from the image and make sure it boots and can be accessed.</p>
<ul>
<li><strong>Requires AWS credentials</strong></li>
</ul>
</li>
<li>
<p><code>base_tests.sh</code></p>
<p>This script runs binaries implemented as part of osbuild-composer codebase in golang. It provisions osbuild-composer and then runs the tests in a loop.</p>
<ol>
<li>
<p><code>osbuild-composer-cli-tests</code> - Weldr API tests using composer-cli</p>
<ul>
<li>Executing <code>composer-cli</code> utility</li>
<li>Invoke multiple image builds</li>
</ul>
</li>
<li>
<p><code>osbuild-weldr-tests</code> - Weldr API tests using golang library from <code>internal/client</code></p>
<ul>
<li>These live directly in the <code>internal</code> directory, which is a bit odd given that all other tests live under <code>cmd/</code>, but there might be a reason for this.</li>
<li>They invoke a build of a qcow2 image</li>
</ul>
</li>
<li>
<p><code>osbuild-dnf-json-tests</code> - These make sure the interface to dnf still works</p>
<ul>
<li>
<p>This binary will execute <code>dnf-json</code> multiple times and it will also run multiple <code>dnf</code> depsolving tasks in parallel. It is possible that it will require a high amount of RAM.</p>
</li>
<li>
<p><em>My guess would be at least 2GB memory for a VM running this test.</em></p>
</li>
</ul>
</li>
<li>
<p><code>osbuild-auth-tests</code> - Make sure the TLS certificate authentication works as expected for the koji api and worker api sockets.</p>
<ul>
<li>A certificate authority is created for these tests and the files are stored in <code>/etc/osbuild-composer-test/ca</code></li>
<li>The certificates live in the standard configuration directory: <code>/etc/osbuild-composer</code></li>
<li>Multiple certificates are created:
<ul>
<li>For osbuild-composer itself (let's say a &quot;server&quot; certificate)</li>
<li>For osbuild-worker</li>
<li>For a client application, in this case the test binary</li>
<li>For kojihub</li>
</ul>
</li>
</ul>
</li>
</ol>
</li>
<li>
<p><code>image_tests.sh</code></p>
<p>Possibly the most resource-hungry test case. It builds an image for all supported image types for all supported distributions on all supported architectures <em>(note that every distro has a different set of aches and arches have different set of supported types, e.g. there is no s390x image for AWS because there is no such machine)</em>.
The &quot;test cases&quot; are defined in <code>test/cases/manifests</code> and they contain a boot type (where to spawn the VM), compose request (what to ask Weldr API for), and finally the expected manifest. Osbuild-composer should generate the same manifest, build the image successfully, optionally upload it to a cloud provider, boot the image, and finally verify it is running.</p>
<ul>
<li><strong>Require AWS, Openstack, and Azure credentials</strong></li>
</ul>
</li>
<li>
<p><code>koji.sh</code></p>
<p>Runs a koji instance in a container. It sets up certificates and Kerberos KDC because osbuild-composer uses Kerberos to authenticate with Koji.</p>
</li>
<li>
<p><code>ostree.sh</code></p>
<p>This test case creates an OSTree commit, boots it, then it creates a commit with an upgrade on top of the previous commit and makes sure the VM can upgrade to the new one.</p>
<ul>
<li>Uses libvirt to run the VM</li>
</ul>
</li>
<li>
<p><code>qemu.sh</code></p>
<p>Create a qcow2 image and boot it using libvirt.</p>
</li>
</ol>
<h3 id="leaking-resources"><a class="header" href="#leaking-resources">Leaking resources</a></h3>
<p>The cloud-cleaner binary was created to clean up all artifacts (like images, but also registered AMIs, security groups, etc.) that could be left behind. Not all executables in our CI have proper error handling and clean up code and what is even worse, if Jenkins fails and takes down all running jobs, it is possible that the clean-up code will not run even if it is implemented.</p>
<p><strong>Possibly leaking resources:</strong></p>
<ol>
<li>
<p><code>api.sh</code> test case:</p>
<ul>
<li>Image uploaded to AWS, Azure or GCP</li>
</ul>
</li>
<li>
<p><code>aws.sh</code> test case:</p>
<ul>
<li>
<p>Image uploaded to EC2</p>
</li>
<li>
<p>VM running in EC2</p>
</li>
</ul>
</li>
</ol>
<h3 id="rpm-repository-snapshots"><a class="header" href="#rpm-repository-snapshots">RPM Repository Snapshots</a></h3>
<p>In order to provide a stable base for the tests, the maintainer team created <a href="developer-guide/general/testing-strategy/../../projects/rpmrepo/index.html">the RPMRepo project</a> that periodically snapshots repositories of selected distributions.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="projects"><a class="header" href="#projects">Projects</a></h1>
<div style="break-before: page; page-break-before: always;"></div><h1 id="osbuild"><a class="header" href="#osbuild">osbuild</a></h1>
<p><a href="https://www.osbuild.org/man/osbuild.1"><strong>osbuild MAN pages</strong></a></p>
<p>The osbuild project is the heart of Image Builder. It is a command-line tool for building OS images. It takes manifest as an input and produces an image as an output. osbuild defines a pipeline description to build arbitrary operating system artifacts out of many small and self-contained stages. Furthermore, it provides an execution engine that will consume a pipeline description, execute the pipeline, and provide the resulting image back to the user. The osbuild interfaces are meant to be used by machines, not humans. Therefore, access to osbuild resources should only be required if you plan to develop new osbuild frontends, debug osbuild failures on your own, or contribute to the osbuild development.</p>
<h2 id="manifests"><a class="header" href="#manifests">Manifests</a></h2>
<p><a href="https://www.osbuild.org/man/osbuild-manifest.5"><strong>osbuild-manifest MAN pages</strong></a></p>
<p>The manifest consists of:</p>
<ul>
<li>sources section</li>
<li>pipeline</li>
</ul>
<p>In our usual use-case, that is tied to Fedora and RHEL, not applicable to other non-RPM distros, the sources section contains an <code>org.osbuild.files</code> section, which is a list of RPMs described by their name, hash, and URL for downloading. We do not support metalink at the moment.</p>
<p><em>This section is, very often, a source of build failures. This happens because we can only include a single link and RPM repos are often instable. Furthermore, we need to set a timeout for the <code>curl</code> download, because we want the build to timeout eventually in case the RPMs are unavailable, but it sometimes fails on slow Internet connection as well.</em></p>
<p>The pipeline consists of a series of stages and ends with an assembler. A stage is our unit of filesystem tree modification and it is implemented as a standalone executable. For example, we have a stage for installing RPM packages, adding a user, enabling systemd service, or setting a timezone.</p>
<p>The difference between a stage and an assembler is that the former takes a read-write filesystem-tree and performs a certain modification to it, whereas the latter takes a read-only filesystem tree and produces an output artifact.</p>
<p>The pipeline contains one more &quot;nested&quot; pipeline, which does not have an assembler. It is called a &quot;build&quot; pipeline.</p>
<h2 id="high-level-goals"><a class="header" href="#high-level-goals">High level goals</a></h2>
<ol>
<li>reproducibility</li>
<li>extensibility</li>
</ol>
<p>The ideal case for building images would be that, given the same input manifest, the output image would always be the same no matter what machine was used for building it. Where &quot;the same&quot; is defined as a binary equivalent. The world of IT is, of course, not ideal therefore we define <strong>reproducibility</strong> as a functional equivalence (that is the image behaves the same when built on different machines) and we limit the set of build machines only to those running the same distribution, in the same version, and on the same architecture. That means if you want to build a Fedora 33 aarch64 image, you need a Fedora 33 aarch64 machine.</p>
<p><em>It is possible to run a RHEL pipeline on Fedora, for example, but we do not test it and therefore we can't promise it will produce the correct result.</em></p>
<p>The advantage of the stage/assembler model is that any user can <strong>extend</strong> the tool with their own stage or assembler.</p>
<h2 id="how-osbuild-works-in-practise"><a class="header" href="#how-osbuild-works-in-practise">How osbuild works in practise</a></h2>
<p>The following subsections describe how OSBuild tries to achieve the outlined high level goals.</p>
<h3 id="manifest-versions"><a class="header" href="#manifest-versions">Manifest versions</a></h3>
<p>OSBuild accepts two versions of manifests. Both manifests are plain JSON files. The following sections contain examples of both <em>(note that comments are not allowed in JSON, so the examples below are not actually valid JSON)</em>.</p>
<h4 id="version-1"><a class="header" href="#version-1">Version 1</a></h4>
<p>The version 1 manifest is built around the idea that an artifact is produced by downloading files from the Internet (e.g. RPMs), using them to build and modify a filesystem tree (using stages), and finally using a read-only version of the final filesystem tree as an input to a assembler which produces the desired artifact.</p>
<pre><code class="language-yaml">{
   # This version contains 2 top-level keys.
   # First sources, these get downloaded from a network and are available
   # in the stages.
   &quot;sources&quot;: {},
   # Second is a pipeline, which can optionally contain a nested &quot;build&quot;
   # pipeline.
   &quot;pipeline&quot;: {
      # The build pipeline is used to create a build container that is
      # later used for building the actual OS artifact. This is mostly
      # to increase reproducibility and host-guest separation.
      # Also note that this is optional.
      &quot;build&quot;: {
         &quot;pipeline&quot;: {
            &quot;stages&quot;: [
               {
                  &quot;name&quot;: &quot;&quot;,
                  &quot;options&quot;: {}
               },
               {
                  &quot;name&quot;: &quot;&quot;,
                  &quot;options&quot;: {}
               }
            ],
            &quot;runner&quot;: &quot;&quot;
         }
      },
      # The pipeline itself is a list of osbuild stages.
      &quot;stages&quot;: [
         {
            &quot;name&quot;: &quot;&quot;,
            &quot;options&quot;: {}
         },
         {
            &quot;name&quot;: &quot;&quot;,
            &quot;options&quot;: {}
         }
      ],
      # And finally exactly one osbuild assembler.
      &quot;assembler&quot;: {
         &quot;name&quot;: &quot;&quot;,
         &quot;options&quot;: {}
      }
   },
}
</code></pre>
<h4 id="version-2"><a class="header" href="#version-2">Version 2</a></h4>
<p>Version 2 is more complicated because OSBuild needed to cover additional use cases like OSTree commit inside of a OCI container. In general that is an artifact inside of another artifact. This is why it comes with multiple pipelines.</p>
<pre><code class="language-yaml">{
   # This version has 3 top-level keys.
   # The first one is simply a version.
   &quot;version&quot;: &quot;2&quot;,
   # The second one are sources as in version 1, but keep in mind that in this
   # version, stages take inputs instead of sources because inputs can be both
   # downloaded from a network and produced by a pipeline in this manifest.
   &quot;sources&quot;: {},
   # This time the 3rd entry is a list of pipelines.
   &quot;pipelines&quot;: [
      {
         # A custom name for each pipeline. &quot;build&quot; is used only as an example.
         &quot;name&quot;: &quot;build&quot;,
         # The runner is again optional.
         &quot;runner&quot;: &quot;&quot;,
         &quot;stages&quot;: [
            {
               # The &quot;type&quot; is same as &quot;name&quot; in v1.
               &quot;type&quot;: &quot;&quot;,
               # The &quot;inputs&quot; field is new in v2. You can specify what goes to
               # the stage. Example inputs are RPMs and OSTree commits from the
               # &quot;sources&quot; section, but also filesystem trees built by othe
               # pipelines.
               &quot;inputs&quot;: {},
               &quot;options&quot;: {}
            }
         ]
      },
      {
         # Again only example name.
         &quot;name&quot;: &quot;build-fs-tree&quot;,
         # But this time the pipeline can use the previous one as a build pipeline.
         # The name:&lt;something&gt; is a reference format in OSBuild manifest v2.
         &quot;build&quot;: &quot;name:build&quot;,
         &quot;stages&quot;: []
      },
      {
         &quot;name&quot;: &quot;do-sth-with-the-tree&quot;,
         &quot;build&quot;: &quot;name:build&quot;,
         &quot;stages&quot;: [
            {
               &quot;type&quot;: &quot;&quot;,
               &quot;inputs&quot;: {
                  # This is an example of how to use the filesystem tree built by
                  # another pipeline as an input to this stage.
                  &quot;tree&quot;: {
                     &quot;type&quot;: &quot;org.osbuild.tree&quot;,
                     &quot;origin&quot;: &quot;org.osbuild.pipeline&quot;,
                     &quot;references&quot;: [
                        # This is a reference to the name of the pipeline above.
                        &quot;name:build-fs-tree&quot;
                     ]
                  }
               },
               &quot;options&quot;: {}
            }
         ]
      },
      {
         # In v2 the assembler is a pipeline as well.
         &quot;name&quot;: &quot;assembler&quot;,
         &quot;build&quot;: &quot;name:build&quot;,
         &quot;stages&quot;: []
      }
   ]
}
</code></pre>
<h3 id="components-of-osbuild"><a class="header" href="#components-of-osbuild">Components of osbuild</a></h3>
<p>OSBuild is designed as a set of loosely coupled or independent components. This subsection describes each of them separately so that the following section can describe how they work together.</p>
<h4 id="object-store"><a class="header" href="#object-store">Object Store</a></h4>
<p>Object store is a directory (also a class representing it) that contains multiple filesystem trees. Each filesystem tree lives in a directory whose name represents hash of the pipeline resulting in this tree. In OSBuild, a user can specify a &quot;checkpoint&quot; which stores particular filesystem tree inside of the Object Store.</p>
<h4 id="build-root"><a class="header" href="#build-root">Build Root</a></h4>
<p>It is a directory where OSBuild modules (stages and assemblers) are executed. The directory contains full operating system which is composed of multiple things:</p>
<ul>
<li>Executables and libraries needed for building the OS artifact (these are either from the host or created in a build pipeline).</li>
<li>Directory where the resulting filesystem tree resides.</li>
<li>Few directories bind-mounted directly from the host system (like <code>/dev</code>)</li>
<li>API sockets for communication between the stage running inside a container and the osbuild process running outside of it (directly on the host).</li>
</ul>
<h4 id="sources"><a class="header" href="#sources">Sources</a></h4>
<p>Sources are artifacts that are downloaded from the Internet. For example, generic files downloaded with <code>curl</code>, or OSTree commits downloaded using <code>libostree</code>.</p>
<h4 id="inputs"><a class="header" href="#inputs">Inputs</a></h4>
<p>Inputs are a generalization of the concept of sources, but this time an &quot;input&quot; can be both downloaded, as sources are, or generated using osbuild pipeline. That means one pipeline can be used as an input for another pipeline so you can have an artifact inside of an artifact (for example OSTree commit inside of a container).</p>
<h4 id="apis"><a class="header" href="#apis">APIs</a></h4>
<p>OSBuild allows for bidirectional communication from the build container to the osbuild process running on the host system. It uses Unix-domain sockets and JSON-based communication (<code>jsoncomm</code>) for this purpose. Examples of available APIs:</p>
<ul>
<li>osbuild - provides basic osbuild features like passing arguments to the stage inside the build container or reporting exceptions from the stage back to the host</li>
<li>remoteloop - helps with setting up loop devices on the host and forwarding them to the container</li>
<li>sources - runs a source module and returns the result</li>
</ul>
<h3 id="what-happens-during-simplified-osbuild-run"><a class="header" href="#what-happens-during-simplified-osbuild-run">What happens during simplified osbuild run</a></h3>
<p>This section puts the above concepts into context. It does not aim to describe all the possible code paths. To understand <code>osbuild</code> properly, you need to read the source code, but it should help you get started.</p>
<p>During a single <code>osbuild</code> run, this is what usually happens:</p>
<ol>
<li>Preparation
<ol>
<li>Validate the manifest schema to make sure it is either v1 or v2 manifest</li>
<li>Object Store is instantiated either from an empty directory or from already existing one which might contain already cached filesystem trees.</li>
</ol>
</li>
<li>Processing the manifest
<ol>
<li>Download sources</li>
<li>Run all pipelines sequentially</li>
</ol>
</li>
<li>Processing a pipeline (one of N)
<ol>
<li>Check the Object Store for cached filesystem trees and start from there if it already contains parially built artifact</li>
</ol>
</li>
<li>Processing a module (stage or assembler)
<ol>
<li>Create a BuildRoot, which means initializing a <code>bwrap</code> container, mounting all necessary directories, and forwarding API sockets.</li>
<li>From the build container, use the osbuild API to get arguments and run the module</li>
</ol>
</li>
<li>If an assembler is present in the manifest, run it and store the resulting artifact in the output directory</li>
</ol>
<h2 id="issues-that-do-not-fit-into-the-high-level-goals"><a class="header" href="#issues-that-do-not-fit-into-the-high-level-goals">Issues that do not fit into the high level goals</a></h2>
<h3 id="bootstrapping-the-build-environment"><a class="header" href="#bootstrapping-the-build-environment">Bootstrapping the build environment</a></h3>
<p>The &quot;build&quot; pipeline was introduced to improve reproducibility. Ideally, given a build pipeline, one would always get the same filesystem tree. But, to create the first filesystem tree, you need some tools. So, where go you get them from? Of course from the host operating system (OS). The problem with getting tools from the host OS this is that the host can affect the final result.</p>
<p><em>We've already had this issue many times, because most of the usual CLI tools were not created with reproducibility in mind.</em></p>
<h3 id="the-struggle-with-grub"><a class="header" href="#the-struggle-with-grub">The struggle with GRUB</a></h3>
<p>The standard tooling for creating GRUB does not fit to our stage/assembler concept because it wants to modify the filesystem tree and create the resulting artifact at the same time. As a result we have our own reimplementation of these tools.</p>
<h2 id="running-osbuild-from-sources"><a class="header" href="#running-osbuild-from-sources">Running OSBuild from sources</a></h2>
<p>It is not strictly required to run OSBuild installed from an RPM package. If you attempt to run <code>osbuild</code> from the command line in combination with an SELinux stage in the manifest it will most likely fail. For example:</p>
<pre><code>$ python3 -m osbuild
</code></pre>
<p>The cause of error is a lack of proper labelling of the <code>python3</code> executable, all stages and assemblers. Creating two additional files resolves the problem:</p>
<ol>
<li>New entrypoint which will soon have the right SELinux label, let's call it <code>osbuild-cli</code>:</li>
</ol>
<pre><code class="language-python">#!/usr/bin/python3

import sys

from .osbuild.main_cli import osbuild_cli as main


if __name__ == &quot;__main__&quot;:
   r = main()
   sys.exit(r)
</code></pre>
<ol start="2">
<li>A script to relabel all the files that need it:</li>
</ol>
<pre><code class="language-bash">#!/bin/bash

LABEL=$(matchpathcon -n /usr/bin/osbuild)

echo &quot;osbuild label: ${LABEL}&quot;

chcon ${LABEL} osbuild-cli

find . -maxdepth 2 -type f -executable -name 'org.osbuild.*' -print0 |
   while IFS= read -r -d '' module; do
   chcon ${LABEL} ${module}
   done
</code></pre>
<p>Now run the script and use the entrypoint to execute OSBuild from git checkout.</p>
<h2 id="stage-development"><a class="header" href="#stage-development">Stage development</a></h2>
<h3 id="stage-unit-testing"><a class="header" href="#stage-unit-testing">Stage unit testing</a></h3>
<p>To update a stage unit test, modify appropriate <code>test/data/stages/&lt;stage_suffix&gt;/b.mpp.json</code>.</p>
<p>Regenerate testing manifests:</p>
<pre><code class="language-shell">make test-data
</code></pre>
<p>You can run <code>osbuild</code> stage test only for a specific stage:</p>
<pre><code class="language-shell">sudo python3 -m pytest test/run/test_stages.py -k test_&lt;stage_suffix&gt;
</code></pre>
<p>Based on the result of the unit test adjust <code>test/data/stages/&lt;stage_suffix&gt;/diff.json</code></p>
<h3 id="inspecting-filesystem-tree-modified-by-the-stage-using-unit-test-manifest"><a class="header" href="#inspecting-filesystem-tree-modified-by-the-stage-using-unit-test-manifest">Inspecting filesystem tree modified by the stage using unit test manifest</a></h3>
<pre><code class="language-shell"># needed only first time
mkdir -p store/
mkdir -p output/

rm -rf rpmbuild
make rpm
sudo dnf install -y rpmbuild/RPMS/noarch/*.rpm
sudo rm -rf store/*

# This command assumes that the latest pipeline stage, which you want to inspect has index &quot;1&quot;.
# If this is not true, adjust the index in the `jq .pipeline.stages[1].id`
STAGE_ID=$(osbuild --inspect test/data/stages/&lt;stage_suffix&gt;/b.json | jq .pipeline.stages[1].id | tr -d '&quot;')
sudo osbuild --store store/ --checkpoint &quot;$STAGE_ID&quot; --export &quot;$STAGE_ID&quot; --output-directory output/ test/data/stages/&lt;stage_suffix&gt;/b.json
</code></pre>
<p>The modified filesystem tree will be located in <strong>store/objects/&lt;stage_id&gt;/</strong></p>
<h3 id="special-case---the-stage-requires-additional-dependency"><a class="header" href="#special-case---the-stage-requires-additional-dependency">Special case - the stage requires additional dependency</a></h3>
<p>If the additional dependency is not present int the <strong>build</strong> pipeline of the stage test manifest, you'll have to fix it. Modify the appropriate manifest imported in the <strong>build</strong> pipeline of the <code>b.mpp.json</code> file. This may be e.g. the <code>f34-build.json</code> present in <code>test/data/manifests/</code>. Modify it's &quot;mpp&quot; version, e.g. <code>test/data/manifests/f34-build.mpp.json</code> and run <code>make test-data</code> in the git checkout root.</p>
<p>osbuild CI runs unit tests inside a special <code>osbuild-ci</code> container. If the stage imports a 3rd party Python module, then you will have to make sure, that this Python module is present in the container image. Adding the dependency to the <strong>build</strong> pipeline will cover only the case when stages are tested, but not other types of unit testing. In order to extend the <code>osbuild-ci</code> image, you need to submit a Pull Request against the <a href="https://github.com/osbuild/containers">OSBuild Containers</a> repository.</p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="osbuild-composer-1"><a class="header" href="#osbuild-composer-1">osbuild-composer</a></h1>
<p>It is a web service for building OS images. The core of <code>osbuild-composer</code>, which is common to all APIs, is osbuild manifests generation a job queuing. If an operating system is to be supported by <code>osbuild-composer</code>, it needs the manifest generation code in <code>internal/distro</code> directory. So far, we only focus on RPM based distributions, such as Fedora and RHEL. The queuing mechanism is under heavy development at the moment.</p>
<h2 id="interfacing-with-dnf-package-manager"><a class="header" href="#interfacing-with-dnf-package-manager">Interfacing with dnf package manager</a></h2>
<p>We use our custom wrapper for <code>dnf</code>, which we call simply <code>dnf-json</code>, because its interface goes like this:</p>
<ul>
<li>Stdin - takes  a JSON object</li>
<li>Stdout - returns a JSON object</li>
<li>Return code is used <strong>only</strong> for <code>dnf-json</code> internal errors, not for errors in the operation specified on the input. Those errors are reported in the returned JSON object.</li>
</ul>
<h2 id="local-api---weldr"><a class="header" href="#local-api---weldr">Local API - Weldr</a></h2>
<p>This API comes from the <code>Lorax-composer project</code>. <code>osbuild-composer</code> was created as a drop-in replacement for Lorax which influenced many design decisions. It uses Unix-Domain socket, so it is meant for local usage only. There are two clients:</p>
<ul>
<li>composer-cli / <a href="https://github.com/osbuild/weldr-client">weldr-client</a></li>
<li><a href="https://github.com/osbuild/cockpit-composer">cockpit-composer</a> (branded as Image Builder in the Cockpit console)</li>
</ul>
<p>Activate this API by invoking <code>systemctl start osbuild-composer.socket</code>. Systemd will create a socket at <code>/run/weldr/api.socket</code>.</p>
<h2 id="remote-api---cloud-api"><a class="header" href="#remote-api---cloud-api">Remote API - Cloud API</a></h2>
<p>This is the <code>/api/image-builder-composer/v2/</code> API endpoint. There are currently two clients, which are integrating with <code>osbuild-composer</code> using this API:</p>
<ul>
<li><a href="https://github.com/osbuild/image-builder">image-builder</a>, described in more detail in the <a href="developer-guide/projects/osbuild-composer/../../../image-builder-service/architecture.html">Image Builder service architecture</a> document.</li>
<li><a href="https://github.com/osbuild/koji-osbuild">koji-osbuild</a> plugin, which integrates <code>osbuild-composer</code> with the <a href="https://koji.build/">Koji</a> build system.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div><h1 id="local-cloud-api-development"><a class="header" href="#local-cloud-api-development">Local Cloud API Development</a></h1>
<p>The following instructions assume you are running osbuild-composer in a local
VM on some version of Fedora and that you have the osbuild-composer github
repository available.  The VM should have ssh access from the host system. In
these examples I use <code>localvm</code> as an alias for the VM's ssh settings in my
<code>~/.ssh/config</code> file.</p>
<h2 id="setup-local-api-access"><a class="header" href="#setup-local-api-access">Setup Local API Access</a></h2>
<p>The osbuild-composer cloud api listens to port 443, but it requires SSL
certificates in order to authenticate the requests.  You can generate the
needed certificates using a slightly modified script from the <code>./tools/</code>
directory, and the system running the script needs to have <code>openssl</code> installed
on it.</p>
<p>These changes will let you use curl on the VM to POST the composer api json
request files to the service listening on 127.0.0.1:443.</p>
<p>From the osbuild-composer git repo copy <code>./tools/gen-certs.sh</code> and
<code>./test/data/x509/openssl.cnf</code> to a temporary directory.  Edit the
<code>gen-certs.sh</code> script and replace all of the <code>subjectAltName=</code> entries with
<code>subjectAltName=IP:127.0.0.1</code> and generate new certs like so:</p>
<pre><code>./gen-certs.sh /tmp/openssl.cnf /tmp/local-certs/ /tmp/working-certs/
</code></pre>
<p>Copy the new certs to the VM:</p>
<pre><code>scp /tmp/local-certs/* localvm:/etc/osbuild-composer/
</code></pre>
<p>ssh into the VM and stop any currently running osbuild services and then start
the cloud api socket service by running:</p>
<pre><code>systemctl stop '*osbuild*'
systemctl start osbuild-composer-api.socket osbuild-remote-worker.socket
</code></pre>
<p>Make a helper script to POST json cloud api requests to the service.  Save this
in a file named <code>start-cloudapi</code> on the VM:</p>
<pre><code class="language-bash">#!/usr/bin/sh
curl -v -k --cert /etc/osbuild-composer/client-crt.pem \
--cacert /etc/osbuild-composer/ca-crt.pem \
--key /etc/osbuild-composer/client-key.pem \
https://localhost/api/image-builder-composer/v2/compose \
--header 'Content-Type: application/json' \
--data @$1
</code></pre>
<p>Now you need a simple request to create a guest (qcow2) image.  This uses Fedora 38, and
doesn't include gpg key checking.  Save this as <code>simple-guest.json</code>:</p>
<pre><code class="language-json">{
  &quot;distribution&quot;: &quot;fedora-38&quot;,
  &quot;image_request&quot;:
    {
      &quot;architecture&quot;: &quot;x86_64&quot;,
      &quot;image_type&quot;: &quot;guest-image&quot;,
      &quot;repositories&quot;: [
          {
            &quot;name&quot;: &quot;fedora&quot;,
            &quot;metalink&quot;: &quot;https://mirrors.fedoraproject.org/metalink?repo=fedora-38&amp;arch=x86_64&quot;,
            &quot;check_gpg&quot;: false
          },
          {
            &quot;name&quot;: &quot;updates&quot;,
            &quot;metalink&quot;: &quot;https://mirrors.fedoraproject.org/metalink?repo=updates-released-f38&amp;arch=x86_64&quot;,
            &quot;check_gpg&quot;: false
          },
          {
            &quot;name&quot;: &quot;fedora-modular&quot;,
            &quot;metalink&quot;: &quot;https://mirrors.fedoraproject.org/metalink?repo=fedora-modular-38&amp;arch=x86_64&quot;,
            &quot;check_gpg&quot;: false
          },
          {
            &quot;name&quot;: &quot;updates-modular&quot;,
            &quot;metalink&quot;: &quot;https://mirrors.fedoraproject.org/metalink?repo=updates-released-modular-f38&amp;arch=x86_64&quot;,
            &quot;check_gpg&quot;: false
          }
      ]
    }
}
</code></pre>
<p>Use <code>./start-cloudapi simple-guest.json</code> start the build.  You should get a JSON response similar to this:</p>
<pre><code class="language-json">{&quot;href&quot;:&quot;/api/image-builder-composer/v2/compose&quot;,&quot;kind&quot;:&quot;ComposeId&quot;,&quot;id&quot;:&quot;f3ac9290-23c0-47b4-bb9e-cadee85d1340&quot;}
</code></pre>
<p>This will run the build, but since it doesn't have any upload instructions it
will fail at the upload step and delete the image from the local system.
<code>journalctl -f</code> will show the progress and the upload error.</p>
<p>If you want to upload results to a service include the upload details in the request.  If you
want to save the results locally continue to the next section.</p>
<h2 id="skip-upload-and-save-locally"><a class="header" href="#skip-upload-and-save-locally">Skip upload and save locally</a></h2>
<p>You can configure osbuild-composer to save the image locally and not try to
upload it.  This allows you to examine the image, or copy it somewhere to do a
test boot of it.  This is not enabled normally because there are no provisions
for cleaning up the images -- you need to do that manually before your disk
runs out of space.</p>
<p>The <code>local_save</code> upload option is enabled by setting an environmental variable
in the <code>osbuild-composer.service</code> file.  You can either edit the file directly,
which will need to be replaced every time you update the osbuild-composer rpm,
or you can create a drop-in file by running <code>systemctl edit osbuild-composer.service</code> and adding these lines:</p>
<pre><code>[Service]
Environment=&quot;OSBUILD_LOCALSAVE=1&quot;
</code></pre>
<p>You can confirm the change by running <code>systemctl cat osbuild-composer.service</code>.
Now stop the local osbuild-composer services and start the cloudapi service by
running:</p>
<pre><code>systemctl stop '*osbuild*'
systemctl start osbuild-composer-api.socket osbuild-remote-worker.socket
</code></pre>
<p>Make a new composer api request json file with the <code>local_save</code> upload option
set to true.  Copy the <code>simple-guest.json</code> example to <code>local-guest.json</code> and add
the <code>upload_options</code> section:</p>
<pre><code class="language-json">{
  &quot;distribution&quot;: &quot;fedora-38&quot;,
  &quot;image_request&quot;:
    {
      &quot;architecture&quot;: &quot;x86_64&quot;,
      &quot;image_type&quot;: &quot;guest-image&quot;,
      &quot;upload_options&quot;: {
          &quot;local_save&quot;: true
      },
      &quot;repositories&quot;: [ ... SAME AS PREVIOUS EXAMPLE ... ]
    }
}
</code></pre>
<p>You can now run <code>./start-cloudapi local-guest.json</code> to start the build.  You
should get a JSON response similar to this:</p>
<pre><code>{&quot;href&quot;:&quot;/api/image-builder-composer/v2/compose&quot;,&quot;kind&quot;:&quot;ComposeId&quot;,&quot;id&quot;:&quot;4674e0d3-ecb3-4cbe-9c31-ca14b7425eaa&quot;}
</code></pre>
<p>and monitor the progress with <code>journalctl -f</code>.  When the compose is finished the
result will be saved in
<code>/var/lib/osbuild-composer/artifacts/4674e0d3-ecb3-4cbe-9c31-ca14b7425eaa</code></p>
<p>Remember to monitor your disk usage, it can fill up quickly if you do not delete old artifact
entries.  These are un-managed, unlike the store used with the weldr api, so they can be removed manually with a simple <code>rm -rf /var/lib/osbuild-composer/artifacts/*</code></p>
<div style="break-before: page; page-break-before: always;"></div><h1 id="rpm-repository-snapshots-1"><a class="header" href="#rpm-repository-snapshots-1">RPM Repository Snapshots</a></h1>
<p>For reliable continuous development, the OSBuild project employs its own RPM
repository snapshots. These snapshots are persistent and immutable. They are
meant to be used by test farms, CI systems, and other development tools, in
case the official RPM repositories are not suitable.</p>
<blockquote>
<p><strong>WARNING</strong>: These snapshots are not meant for production use! No guarantee of
safety, applicability, or fitness for a particular purpose is made. No security
fixes are applied to the repositories!</p>
</blockquote>
<h2 id="target-repositories"><a class="header" href="#target-repositories">Target Repositories</a></h2>
<p>The authoritative list of repositories that we target can be found in the
<code>./repo/</code> subdirectory of the <code>rpmrepo</code> repository:</p>
<pre><code>https://github.com/osbuild/rpmrepo/tree/main/repo
</code></pre>
<p>This directory contains a configuration for each target repository, including
the Base-URL that will be sourced for snapshots. The following list contains an
overview (possibly outdated) of the repositories we create snapshots for:</p>
<div class="table-wrapper"><table><thead><tr><th>Platform</th><th style="text-align: center">Version</th><th style="text-align: center">Architectures</th><th>Lifetime</th></tr></thead><tbody>
<tr><td>Fedora</td><td style="text-align: center">31</td><td style="text-align: center">x86_64</td><td>(obsolete)</td></tr>
<tr><td>Fedora</td><td style="text-align: center">32</td><td style="text-align: center">x86_64</td><td>(obsolete)</td></tr>
<tr><td>Fedora</td><td style="text-align: center">33</td><td style="text-align: center">x86_64</td><td>12 months</td></tr>
<tr><td>Fedora</td><td style="text-align: center">34</td><td style="text-align: center">x86_64</td><td>12 months</td></tr>
<tr><td>Fedora</td><td style="text-align: center">35</td><td style="text-align: center">x86_64</td><td>12 months</td></tr>
<tr><td>RHEL</td><td style="text-align: center">8.2</td><td style="text-align: center">aarch64, ppc64le, s390x, x86_64</td><td>infinite?</td></tr>
<tr><td>RHEL</td><td style="text-align: center">8.3</td><td style="text-align: center">aarch64, ppc64le, s390x, x86_64</td><td>infinite?</td></tr>
<tr><td>RHEL</td><td style="text-align: center">8.4</td><td style="text-align: center">aarch64, ppc64le, s390x, x86_64</td><td>infinite?</td></tr>
<tr><td>RHEL</td><td style="text-align: center">8.5</td><td style="text-align: center">aarch64, ppc64le, s390x, x86_64</td><td>infinite?</td></tr>
<tr><td>RHEL</td><td style="text-align: center">9.0</td><td style="text-align: center">aarch64, ppc64le, s390x, x86_64</td><td>infinite?</td></tr>
</tbody></table>
</div>
<p>Each target repository has an ID-string that identifies it (which also is the
filename of its target configuration file in the <code>./repo/</code> directory). Whenever
a snapshot is created, the snapshot will be identified by that ID-string
suffixed with the date it was created (and possibly some other suffix
identifiers).</p>
<p>An enumeration of all available snapshots of all target repositories can be
retrieved via:</p>
<pre><code>$ curl -s https://rpmrepo.osbuild.org/v2/enumerate | jq .
</code></pre>
<p>For a given target repository ID-string like <code>el9-x86_64-baseos-n9.0</code>, the list
of available snapshots can be queried via:</p>
<pre><code>$ curl -s https://rpmrepo.osbuild.org/v2/enumerate/el9-x86_64-baseos-n9.0 | jq .
</code></pre>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>We provide an RPM repository for every snapshot, accessible via
<code>rpmrepo.osbuild.org</code>. The <em>Base URL</em> for a given snapshot is:</p>
<pre><code>https://rpmrepo.osbuild.org/v2/mirror/&lt;storage&gt;/&lt;platform&gt;/&lt;snapshot&gt;/
</code></pre>
<p>The parameters are:</p>
<div class="table-wrapper"><table><thead><tr><th>Key</th><th style="text-align: center">Value</th><th style="text-align: center">Examples</th></tr></thead><tbody>
<tr><td><em>&lt;storage&gt;</em></td><td style="text-align: center"><em>public</em>, <em>rhvpn</em></td><td style="text-align: center"><em>public</em>, <em>rhvpn</em></td></tr>
<tr><td><em>&lt;platform&gt;</em></td><td style="text-align: center"><em>f&lt;num&gt;</em>, <em>el&lt;num&gt;</em></td><td style="text-align: center"><em>f33</em>, <em>el8</em></td></tr>
<tr><td><em>&lt;snapshot&gt;</em></td><td style="text-align: center"><em>&lt;tag&gt;</em></td><td style="text-align: center"><em>f33-x86_64-devel-20201010</em></td></tr>
</tbody></table>
</div>
<p>The <em>storage</em> key selects the actual data store. Available storage includes
<em>public</em> for the anonymous, public storage, <em>rhvpn</em> for data on Red Hat private
infrastructure. The <em>platform</em> key groups the data by platform, required for
data lifetime management. The <em>snapshot</em> key selects the individual snapshot.</p>
<p>Note that not all data is available on all storage locations and platforms. If
you select the wrong combination, you will get <em>404</em> replies. As a general
rule, you should select the platform based on the snapshot name (e.g., for the
snapshot <em>f33-x86_64-devel-20201010</em> you should use <em>f33</em> as platform). As
storage selector, you should use <em>public</em> for all publicly available data,
<em>rhvpn</em> for Red Hat internal data.</p>
<p>For instance, to access the F33 snapshot <em>f33-x86_64-fedora-202103231401</em>, use:</p>
<pre><code>https://rpmrepo.osbuild.org/v2/mirror/public/f33/f33-x86_64-fedora-202103231401/
</code></pre>
<p>To access the EL8.2 snapshot <em>el8-x86_64-baseos-r8.2-202103231359</em>, use:</p>
<pre><code>https://rpmrepo.osbuild.org/v2/mirror/rhvpn/el8/el8-x86_64-baseos-r8.2-202103231359/
</code></pre>
<h2 id="access"><a class="header" href="#access">Access</a></h2>
<p>By default, all snapshots are publicly available, unless they contain
confidential or proprietary data. If you decide to use these snapshots, please
contact the OSBuild Developers and give us a short notice, so we can track the
users and communicate upcoming changes:</p>
<ul>
<li><strong>RPMrepo Issue Tracker</strong>: <a href="https://github.com/osbuild/rpmrepo/issues">@GitHub</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>

    </div>
    </body>
</html>
